<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="live2d.manager">Live2D æ¨¡å‹ç®¡ç†å™¨ - Project N.E.K.O.</title>
    <!-- i18next åŠ è½½å™¨ï¼ˆç»Ÿä¸€å¤„ç† CDN åŠ è½½å’Œåˆå§‹åŒ–ï¼‰ -->
    <script src="/static/i18n-i18next.js"></script>
    <script src="/static/common_dialogs.js"></script>
    <style>
        *:focus {
            outline: none !important;
            box-shadow: none !important; 
        }
        html, body {
            height: 100%; margin: 0; padding: 0; background: #eee; color: #222;
            font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden;
        }
        #live2d-container {
            position: fixed; right: 0px; bottom: 0px; width: 100%; height: 100%;
            z-index: 10; pointer-events: auto;
        }
        #live2d-canvas {
            display: block; width: 100%; height: 100%; background: transparent;
            cursor: grab; pointer-events: auto;
        }
        #live2d-canvas:active { cursor: grabbing; }

        #sidebar {
            position: fixed;
            left: 20px;
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 20;
            min-width: 280px;
            padding: 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .control-label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        .control-select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 14px;
            cursor: pointer;
            background: #fff;
            color: #333;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23d5f1ff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 35px;
        }
        
        .btn {
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            color: white;
            transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
            text-align: center;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .btn:disabled {
            background: #e0e0e0;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .btn-primary { background: #44b7fe; }
        .btn-primary:hover:not(:disabled) { background: #2662c8; }
        
        .btn-secondary { 
            background: #d5f1ff; 
            color: #333;
        }
        .btn-secondary:hover:not(:disabled) { 
            background: #b8e5ff; 
            color: #333;
        }

        .btn-success { background: #44b7fe; }
        .btn-success:hover:not(:disabled) { background: #2662c8; }
        
        #save-position-btn {
            background: #d5f1ff !important;
            color: #333 !important;
        }
        #save-position-btn:hover:not(:disabled) {
            background: #b8e5ff !important;
            color: #333 !important;
        }
        
        .btn-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-icon img {
            width: 16px;
            height: 16px;
            object-fit: contain;
        }

        .action-group {
            display: flex;
            gap: 10px;
        }
        .action-group .control-select {
            flex-grow: 1;
        }
        #persistent-list {
            margin-top: 6px;
            max-height: 120px;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 6px;
            background: #fff;
        }
        
        #status {
            margin-top: 10px;
            color: #4f8cff;
            font-size: 14px;
            font-weight: 500;
            max-width: 280px;
            word-break: break-all;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="control-group">
        <button id="backToMainBtn" class="btn btn-primary" data-i18n="live2d.backToMain">â† è¿”å›ä¸»é¡µ</button>
    </div>
    
    <div class="control-group">
        <label class="control-label" data-i18n="live2d.importModel">å¯¼å…¥æ¨¡å‹:</label>
        <input type="file" id="model-upload" webkitdirectory directory multiple style="display: none;">
        <button id="upload-btn" class="btn btn-primary" data-i18n="live2d.selectFolder">ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹</button>
        <div id="upload-status" style="font-size:12px; color:#666; margin-top:4px;"></div>
    </div>
    
    <div class="control-group">
        <label for="model-select" class="control-label" data-i18n="live2d.selectModel">é€‰æ‹©æ¨¡å‹:</label>
        <select id="model-select" class="control-select">
            <option data-i18n="common.loading">åŠ è½½ä¸­...</option>
        </select>
    </div>

    <div class="control-group">
        <label class="control-label" data-i18n="live2d.motionPreview">åŠ¨ä½œé¢„è§ˆ:</label>
        <div class="action-group">
            <select id="motion-select" class="control-select" disabled>
                <option data-i18n="live2d.pleaseLoadModel">è¯·å…ˆåŠ è½½æ¨¡å‹</option>
            </select>
            <button id="play-motion-btn" class="btn btn-primary btn-icon" disabled>
                <img src="/static/icons/play_icon.png" alt="æ’­æ”¾" data-i18n-alt="live2d.play">
                <span data-i18n="live2d.play">æ’­æ”¾</span>
            </button>
        </div>
    </div>
    
    <div class="control-group">
        <label class="control-label" data-i18n="live2d.expressionPreview">è¡¨æƒ…é¢„è§ˆ:</label>
        <div class="action-group">
            <select id="expression-select" class="control-select" disabled>
                <option data-i18n="live2d.pleaseLoadModel">è¯·å…ˆåŠ è½½æ¨¡å‹</option>
            </select>
            <button id="play-expression-btn" class="btn btn-primary btn-icon" disabled>
                <img src="/static/icons/play_icon.png" alt="æ’­æ”¾" data-i18n-alt="live2d.play">
                <span data-i18n="live2d.play">æ’­æ”¾</span>
            </button>
        </div>
    </div>

    <div class="control-group">
        <div style="display:flex; gap: 10px;">
            <button id="emotion-manager-btn" class="btn btn-primary btn-icon" disabled style="flex:1;">
                <img src="/static/icons/emotion_config_icon.png" alt="æƒ…æ„Ÿé…ç½®" data-i18n-alt="live2d.emotionConfig">
                <span data-i18n="live2d.emotionConfig">æƒ…æ„Ÿé…ç½®</span>
            </button>
            <button id="save-position-btn" class="btn btn-success btn-icon" disabled style="flex:1;">
                <img src="/static/icons/save_settings.png" alt="ä¿å­˜è®¾ç½®" data-i18n-alt="live2d.saveSettings">
                <span data-i18n="live2d.saveSettings">ä¿å­˜è®¾ç½®</span>
            </button>
        </div>
    </div>

    <div class="control-group" id="persistent-box" style="display:none;">
        <label class="control-label" data-i18n="live2d.persistentExpression">å¸¸é©»è¡¨æƒ…ï¼ˆä»…expressionï¼‰:</label>
        <div class="action-group">
            <select id="persistent-expression-select" class="control-select" disabled>
                <option data-i18n="live2d.pleaseLoadModel">è¯·å…ˆåŠ è½½æ¨¡å‹</option>
            </select>
            <button id="add-persistent-btn" class="btn btn-primary" disabled data-i18n="live2d.add">æ·»åŠ </button>
        </div>
        <div id="persistent-list"></div>
        <button id="save-persistent-btn" class="btn btn-success" disabled style="margin-top:6px;" data-i18n="live2d.savePersistent">ä¿å­˜å¸¸é©»è¡¨æƒ…</button>
        <div style="font-size:12px; color:#666;" data-i18n="live2d.persistentHint">å¸¸é©»è¡¨æƒ…ä¼šä¸€ç›´ç”Ÿæ•ˆï¼Œä¸ä¼šè¢«æ¸…é™¤æˆ–è¦†ç›–ï¼›æ­¤å¤„ä»…èƒ½é€‰æ‹© .exp3.jsonã€‚</div>
    </div>
    
    <div id="status" data-i18n="status.initializing">æ­£åœ¨åˆå§‹åŒ–...</div>
</div>

<div id="live2d-container"><canvas id="live2d-canvas"></canvas></div>

<script src="/static/libs/live2dcubismcore.min.js"></script>
<script src="/static/libs/live2d.min.js"></script>
<script src="/static/libs/pixi.min.js"></script>
<script src="/static/libs/index.min.js"></script>
<script src="/static/live2d.js"></script>

<script>
    // ç”¨äºé¡µé¢é—´é€šä¿¡çš„äº‹ä»¶å¤„ç†
        function sendMessageToMainPage(action) {
            try {
                // ä½¿ç”¨localStorageäº‹ä»¶æœºåˆ¶å‘é€æ¶ˆæ¯ç»™ä¸»é¡µé¢
                const message = {
                    action: action,
                    timestamp: Date.now()
                };
                localStorage.setItem('nekopage_message', JSON.stringify(message));
                localStorage.removeItem('nekopage_message'); // ç«‹å³ç§»é™¤ä»¥å…è®¸é‡å¤å‘é€ç›¸åŒæ¶ˆæ¯
            } catch (e) {
                console.log('å‘é€æ¶ˆæ¯ç»™ä¸»é¡µé¢å¤±è´¥:', e);
            }
        }

        // å…¨å±€å˜é‡ï¼šè·Ÿè¸ªæœªä¿å­˜çš„æ›´æ”¹
        window.hasUnsavedChanges = false;

        document.addEventListener('DOMContentLoaded', async () => {
        const statusDiv = document.getElementById('status');
        const modelSelect = document.getElementById('model-select');
        const motionSelect = document.getElementById('motion-select');
        const expressionSelect = document.getElementById('expression-select');
        const playMotionBtn = document.getElementById('play-motion-btn');
        const playExpressionBtn = document.getElementById('play-expression-btn');
        const emotionManagerBtn = document.getElementById('emotion-manager-btn');
        const savePositionBtn = document.getElementById('save-position-btn');
        const persistentBox = document.getElementById('persistent-box');
        const persistentSelect = document.getElementById('persistent-expression-select');
        const addPersistentBtn = document.getElementById('add-persistent-btn');
        const persistentList = document.getElementById('persistent-list');
        const savePersistentBtn = document.getElementById('save-persistent-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const modelUpload = document.getElementById('model-upload');
        const uploadStatus = document.getElementById('upload-status');
        const backToMainBtn = document.getElementById('backToMainBtn');
        
        // å…¨å±æ§åˆ¶å‡½æ•°
        const requestFullscreen = () => {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                return elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                return elem.webkitRequestFullscreen();
            } else if (elem.mozRequestFullScreen) {
                return elem.mozRequestFullScreen();
            } else if (elem.msRequestFullscreen) {
                return elem.msRequestFullscreen();
            }
            return Promise.reject(new Error('Fullscreen not supported'));
        };
        
        const exitFullscreen = () => {
            if (document.exitFullscreen) {
                return document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                return document.webkitExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                return document.mozCancelFullScreen();
            } else if (document.msExitFullscreen) {
                return document.msExitFullscreen();
            }
            return Promise.reject(new Error('Exit fullscreen not supported'));
        };
        
        const isFullscreen = () => {
            return !!(document.fullscreenElement || 
                     document.webkitFullscreenElement || 
                     document.mozFullScreenElement || 
                     document.msFullscreenElement);
        };
        
        // æ£€æµ‹é¡µé¢æ¥æºï¼Œè®¾ç½®è¿”å›æŒ‰é’®æ–‡æœ¬
        const isPopupWindow = window.opener !== null;
        if (isPopupWindow) {
            backToMainBtn.textContent = t('common.close', 'âœ– å…³é—­');
            
            // å°è¯•æœ€å¤§åŒ–çª—å£
            try {
                window.resizeTo(screen.availWidth, screen.availHeight);
                window.moveTo(0, 0);
            } catch (e) {
                console.log('æœ€å¤§åŒ–çª—å£å¤±è´¥:', e);
            }
            
            // ä¸ºpopupçª—å£æ·»åŠ å…¨å±æŒ‰é’®
            const fullscreenBtn = document.createElement('button');
            fullscreenBtn.id = 'fullscreen-btn';
            fullscreenBtn.className = 'btn btn-primary';
            fullscreenBtn.textContent = t('live2d.toggleFullscreen', 'åˆ‡æ¢å…¨å±');
            fullscreenBtn.onclick = async () => {
                try {
                    if (isFullscreen()) {
                        await exitFullscreen();
                        fullscreenBtn.textContent = t('live2d.toggleFullscreen', 'åˆ‡æ¢å…¨å±');
                    } else {
                        await requestFullscreen();
                        fullscreenBtn.textContent = t('live2d.exitFullscreen', 'é€€å‡ºå…¨å±');
                    }
                } catch (e) {
                    console.log('åˆ‡æ¢å…¨å±å¤±è´¥:', e);
                }
            };
            
            // å°†å…¨å±æŒ‰é’®æ·»åŠ åˆ°è¿”å›æŒ‰é’®æ—è¾¹
            const backToMainBtnParent = backToMainBtn.parentElement;
            backToMainBtnParent.appendChild(fullscreenBtn);
        } else {
            backToMainBtn.textContent = t('live2d.backToMain', 'â† è¿”å›ä¸»é¡µ');
        }
        
        // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–ï¼Œæ›´æ–°æŒ‰é’®æ–‡æœ¬
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
        document.addEventListener('mozfullscreenchange', updateFullscreenButton);
        document.addEventListener('MSFullscreenChange', updateFullscreenButton);
        
        function updateFullscreenButton() {
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            if (fullscreenBtn) {
                if (isFullscreen()) {
                    fullscreenBtn.textContent = t('live2d.exitFullscreen', 'é€€å‡ºå…¨å±');
                } else {
                    fullscreenBtn.textContent = t('live2d.toggleFullscreen', 'åˆ‡æ¢å…¨å±');
                }
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶å‘é€æ¶ˆæ¯éšè—ä¸»ç•Œé¢
        sendMessageToMainPage('hide_main_ui');

        // ç¿»è¯‘è¾…åŠ©å‡½æ•°ï¼šç®€åŒ–ç¿»è¯‘è°ƒç”¨å¹¶å¤„ç†é”™è¯¯
        function t(key, fallback, params = {}) {
            try {
                if (window.t && typeof window.t === 'function') {
                    return window.t(key, params);
                }
            } catch (e) {
                console.error(`[i18n] Translation failed for key "${key}":`, e);
            }
            return fallback;
        }

        let currentModelInfo = null;
        let availableModels = [];
        let currentModelFiles = { motion_files: [], expression_files: [] };
        let live2dModel = null;
        let currentEmotionMapping = null; // { motions: {...}, expressions: {...} }
        let currentPersistent = []; // expressions.å¸¸é©»

        const showStatus = (msg, duration = 0) => {
            statusDiv.textContent = msg;
            if (duration > 0) {
                setTimeout(() => {
                    if (currentModelInfo) {
                        showStatus(t('live2d.currentModel', `å½“å‰æ¨¡å‹: ${currentModelInfo.name}`, {model: currentModelInfo.name}));
                    }
                }, duration);
            }
        };

        await window.live2dManager.initPIXI('live2d-canvas', 'live2d-container');
        showStatus(t('live2d.pixiInitialized', 'PIXI åˆå§‹åŒ–å®Œæˆ'));

        // å…ˆåŠ è½½æ¨¡å‹åˆ—è¡¨
        try {
            const response = await fetch('/api/live2d/models');
            availableModels = await response.json();
            if (availableModels.length > 0) {
                modelSelect.innerHTML = `<option value="">${t('live2d.pleaseSelectModel', 'è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹')}</option>`;
                availableModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.name;
                    modelSelect.appendChild(option);
                });

                showStatus(t('live2d.modelListLoaded', 'æ¨¡å‹åˆ—è¡¨åŠ è½½æˆåŠŸ'));
            } else {
                showStatus(t('live2d.noModelsFound', 'æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹'));
            }
        } catch (e) {
            showStatus(t('live2d.modelListLoadFailed', 'åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥'));
        }

        // ç„¶ååŠ è½½å½“å‰è§’è‰²çš„æ¨¡å‹ï¼ˆæ­¤æ—¶ä¸‹æ‹‰æ¡†å·²ç»æœ‰é€‰é¡¹äº†ï¼‰
        await loadCurrentCharacterModel();

        // å¦‚æœå·²è‡ªåŠ¨åŠ è½½äº†ä¸€ä¸ªæ¨¡å‹ï¼Œç¡®ä¿åœ¨ä¸‹æ‹‰æ¡†ä¸­é€‰ä¸­å®ƒ
        // è¿™æ˜¯åŒé‡ä¿é™©ï¼šé˜²æ­¢ loadCurrentCharacterModel() å†…éƒ¨è®¾ç½®å¤±è´¥
        if (currentModelInfo && currentModelInfo.name) {
            const exists = availableModels.some(m => m.name === currentModelInfo.name);
            if (exists && modelSelect.value !== currentModelInfo.name) {
                console.log('ä¸‹æ‹‰æ¡†å€¼æœªæ­£ç¡®è®¾ç½®ï¼Œæ‰§è¡Œè¡¥æ•‘:', currentModelInfo.name);
                modelSelect.value = currentModelInfo.name;
            }
        }

        // è·å– lanlan_name çš„è¾…åŠ©å‡½æ•°
        async function getLanlanName() {
            // ä¼˜å…ˆä» URL è·å–
            const urlParams = new URLSearchParams(window.location.search);
            let lanlanName = urlParams.get('lanlan_name') || '';
            
            // å¦‚æœ URL ä¸­æ²¡æœ‰ï¼Œä» API è·å–
            if (!lanlanName) {
                try {
                    const response = await fetch('/api/config/page_config');
                    const data = await response.json();
                    if (data.success) {
                        lanlanName = data.lanlan_name || '';
                    }
                } catch (error) {
                    console.error('è·å– lanlan_name å¤±è´¥:', error);
                }
            }
            
            return lanlanName;
        }
        
        // ä¿å­˜æ¨¡å‹è®¾ç½®åˆ°è§’è‰²çš„å‡½æ•°
        async function saveModelToCharacter(modelName) {
            try {
                // è·å–è§’è‰²åç§°
                const lanlanName = await getLanlanName();
                
                if (!lanlanName) {
                    showStatus(t('live2d.cannotSaveNoCharacter', 'æ— æ³•ä¿å­˜ï¼šæœªæŒ‡å®šè§’è‰²åç§°'));
                    return false;
                }
                
                const response = await fetch(`/api/characters/catgirl/l2d/${encodeURIComponent(lanlanName)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ live2d: modelName })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(t('live2d.modelSettingsSaved', `å·²ä¿å­˜æ¨¡å‹è®¾ç½®: ${lanlanName} -> ${modelName}`, {name: lanlanName, model: modelName}), 2000);
                    return true;
                } else {
                    showStatus(t('live2d.saveFailed', `ä¿å­˜å¤±è´¥: ${result.error}`, {error: result.error}), 3000);
                    return false;
                }
            } catch (error) {
                console.error('ä¿å­˜æ¨¡å‹è®¾ç½®å¤±è´¥:', error);
                showStatus(t('live2d.saveModelSettingsFailed', 'ä¿å­˜æ¨¡å‹è®¾ç½®å¤±è´¥'), 3000);
                return false;
            }
        }

        // ä¿®æ”¹æ¨¡å‹é€‰æ‹©äº‹ä»¶ï¼Œè‡ªåŠ¨ä¿å­˜æ¨¡å‹è®¾ç½®
        modelSelect.addEventListener('change', async (e) => {
            const modelName = e.target.value;
            if (!modelName) return;

            currentModelInfo = availableModels.find(m => m.name === modelName);
            if (!currentModelInfo) return;

            await loadModel(modelName, currentModelInfo);
            
            // è‡ªåŠ¨ä¿å­˜æ¨¡å‹è®¾ç½®åˆ°è§’è‰²
            const saveSuccess = await saveModelToCharacter(modelName);
            if (!saveSuccess) {
                // å¦‚æœè‡ªåŠ¨ä¿å­˜å¤±è´¥ï¼Œæ ‡è®°ä¸ºæœ‰æœªä¿å­˜çš„æ›´æ”¹
                window.hasUnsavedChanges = true;
            }
        });

        // åŠ è½½æ¨¡å‹çš„å‡½æ•°
        async function loadModel(modelName, modelInfo) {
            if (!modelName || !modelInfo) return;
            
            showStatus(t('live2d.loadingModel', `æ­£åœ¨åŠ è½½æ¨¡å‹: ${modelName}...`, {model: modelName}));
            setControlsDisabled(true);

            try {
                // 1. Fetch files list
                const filesRes = await fetch(`/api/live2d/model_files/${modelName}`);
                const filesData = await filesRes.json();
                if (!filesData.success) throw new Error(t('live2d.modelFilesFetchFailed', 'æ— æ³•è·å–æ¨¡å‹æ–‡ä»¶åˆ—è¡¨'));
                currentModelFiles = filesData;

                // 2. Fetch model config
                const modelJsonUrl = modelInfo.path;
                const modelConfigRes = await fetch(modelJsonUrl);
                if (!modelConfigRes.ok) throw new Error(t('live2d.modelConfigFetchFailed', `æ— æ³•è·å–æ¨¡å‹é…ç½®: ${modelConfigRes.statusText}`, {status: modelConfigRes.statusText}));
                const modelConfig = await modelConfigRes.json();
                
                // 3. Add URL context for the loader
                modelConfig.url = modelJsonUrl;

                // 4. Inject PreviewAll motion group AND ensure all expressions are referenced
                if (!modelConfig.FileReferences) modelConfig.FileReferences = {};

                // Motions
                if (!modelConfig.FileReferences.Motions) modelConfig.FileReferences.Motions = {};
                // åªæœ‰å½“æ¨¡å‹æœ‰åŠ¨ä½œæ–‡ä»¶æ—¶æ‰æ·»åŠ PreviewAllç»„
                if (currentModelFiles.motion_files.length > 0) {
                    modelConfig.FileReferences.Motions.PreviewAll = currentModelFiles.motion_files.map(file => ({
                        File: file  // ç›´æ¥ä½¿ç”¨APIè¿”å›çš„å®Œæ•´è·¯å¾„
                    }));
                }

                // Expressions: Overwrite with all available expression files for preview purposes.
                modelConfig.FileReferences.Expressions = currentModelFiles.expression_files.map(file => ({
                    Name: file.split('/').pop().replace('.exp3.json', ''),  // ä»è·¯å¾„ä¸­æå–æ–‡ä»¶åä½œä¸ºåç§°
                    File: file  // ç›´æ¥ä½¿ç”¨APIè¿”å›çš„å®Œæ•´è·¯å¾„
                }));
                
                // 5. Load preferences
                const preferences = await window.live2dManager.loadUserPreferences();
                console.log('åŠ è½½çš„åå¥½è®¾ç½®:', preferences);
                console.log('å½“å‰æ¨¡å‹è·¯å¾„:', modelInfo.path);
                const modelPreferences = preferences.find(p => p && p.model_path === modelInfo.path) || null;
                console.log('åŒ¹é…çš„æ¨¡å‹åå¥½:', modelPreferences);

                // 6. Load model FROM THE MODIFIED OBJECT
                await window.live2dManager.loadModel(modelConfig, {
                    loadEmotionMapping: true,
                    dragEnabled: true,
                    wheelEnabled: true,
                    preferences: modelPreferences
                });
                live2dModel = window.live2dManager.getCurrentModel();
                
                // æ·»åŠ æ¨¡å‹äº¤äº’ç›‘å¬å™¨ï¼Œè·Ÿè¸ªä½ç½®å’Œç¼©æ”¾å˜åŒ–
                if (live2dModel && live2dModel.internalModel) {
                    const canvas = document.getElementById('live2d-canvas');
                    if (canvas) {
                        // ç›‘å¬æ‹–åŠ¨å’Œæ»šè½®äº‹ä»¶
                        const markChanged = () => { 
                            window.hasUnsavedChanges = true; 
                            console.log('æ£€æµ‹åˆ°æ¨¡å‹ä½ç½®/ç¼©æ”¾å˜åŒ–ï¼ŒhasUnsavedChanges = true');
                        };
                        canvas.addEventListener('mouseup', markChanged);
                        canvas.addEventListener('wheel', markChanged);
                        canvas.addEventListener('touchend', markChanged);
                    }
                }

                updateSelectWithOptions(motionSelect, currentModelFiles.motion_files, t('live2d.selectMotion', 'é€‰æ‹©åŠ¨ä½œ'), 'motion');
                updateSelectWithOptions(expressionSelect, currentModelFiles.expression_files, t('live2d.selectExpression', 'é€‰æ‹©è¡¨æƒ…'), 'expression');

                // 7. Load current emotion mapping for this model
                await loadEmotionMappingForModel(modelName);
                renderPersistentUI();
                
                // å¦‚æœæ²¡æœ‰åŠ¨ä½œæ–‡ä»¶ï¼Œç¦ç”¨åŠ¨ä½œç›¸å…³æ§ä»¶
                if (currentModelFiles.motion_files.length === 0) {
                    motionSelect.disabled = true;
                    playMotionBtn.disabled = true;
                    motionSelect.innerHTML = `<option value="">${t('live2d.noMotionFiles', 'è¯¥æ¨¡å‹æ²¡æœ‰åŠ¨ä½œæ–‡ä»¶')}</option>`;
                }
                setControlsDisabled(false);
                showStatus(t('live2d.modelLoadSuccess', `æ¨¡å‹ ${modelName} åŠ è½½æˆåŠŸ`, {model: modelName}));

            } catch (error) {
                showStatus(t('live2d.modelLoadFailed', `åŠ è½½æ¨¡å‹ ${modelName} å¤±è´¥`, {model: modelName}));
                console.error(error);
                setControlsDisabled(false);
            }
        }

        playMotionBtn.addEventListener('click', () => {
            if (!live2dModel || !motionSelect.value) return;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰åŠ¨ä½œæ–‡ä»¶
            if (currentModelFiles.motion_files.length === 0) {
                showStatus(t('live2d.noMotionFilesStatus', 'è¯¥æ¨¡å‹æ²¡æœ‰åŠ¨ä½œæ–‡ä»¶'), 2000);
                return;
            }
            
            const motionIndex = currentModelFiles.motion_files.indexOf(motionSelect.value);
            if (motionIndex > -1) {
                try {
                    live2dModel.motion('PreviewAll', motionIndex, 3);
                    showStatus(t('live2d.playingMotion', `æ’­æ”¾åŠ¨ä½œ: ${motionSelect.value}`, {motion: motionSelect.value}), 1000);
                } catch (error) {
                    console.error('æ’­æ”¾åŠ¨ä½œå¤±è´¥:', error);
                    showStatus(t('live2d.playMotionFailed', `æ’­æ”¾åŠ¨ä½œå¤±è´¥: ${motionSelect.value}`, {motion: motionSelect.value}), 2000);
                }
            } else {
                showStatus(t('live2d.motionFileNotExists', 'åŠ¨ä½œæ–‡ä»¶ä¸å­˜åœ¨'), 2000);
            }
        });

        playExpressionBtn.addEventListener('click', () => {
            if (!live2dModel || !expressionSelect.value) return;
            // ä»å®Œæ•´è·¯å¾„ä¸­æå–è¡¨æƒ…åç§°ï¼ˆå»æ‰è·¯å¾„å’Œæ‰©å±•åï¼‰
            const expressionName = expressionSelect.value.split('/').pop().replace('.exp3.json', '');
            console.log('æ’­æ”¾è¡¨æƒ…:', expressionName); // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            try {
                live2dModel.expression(expressionName);
                showStatus(t('live2d.playingExpression', `æ’­æ”¾è¡¨æƒ…: ${expressionName}`, {expression: expressionName}), 1000);
            } catch (error) {
                console.error('æ’­æ”¾è¡¨æƒ…å¤±è´¥:', error);
                showStatus(t('live2d.playExpressionFailed', `æ’­æ”¾è¡¨æƒ…å¤±è´¥: ${expressionName}`, {expression: expressionName}), 2000);
            }
        });

        emotionManagerBtn.addEventListener('click', () => {
            if (!currentModelInfo) return;
            openModal('/live2d_emotion_manager');
        });

        savePositionBtn.addEventListener('click', async () => {
            if (!currentModelInfo || !live2dModel) return;
            showStatus(t('live2d.savingSettings', 'æ­£åœ¨ä¿å­˜è®¾ç½®...'));
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            console.log('ä¿å­˜è®¾ç½® - æ¨¡å‹è·¯å¾„:', currentModelInfo.path);
            console.log('ä¿å­˜è®¾ç½® - å½“å‰ä½ç½®:', { x: live2dModel.x, y: live2dModel.y });
            console.log('ä¿å­˜è®¾ç½® - å½“å‰ç¼©æ”¾:', { x: live2dModel.scale.x, y: live2dModel.scale.y });
            
            // ä¿å­˜ä½ç½®å’Œç¼©æ”¾
            const positionSuccess = await window.live2dManager.saveUserPreferences(
                currentModelInfo.path,
                { x: live2dModel.x, y: live2dModel.y },
                { x: live2dModel.scale.x, y: live2dModel.scale.y }
            );
            
            // ä¿å­˜æ¨¡å‹è®¾ç½®åˆ°è§’è‰²
            const modelSuccess = await saveModelToCharacter(currentModelInfo.name);
            
            if (positionSuccess && modelSuccess) {
                showStatus(t('live2d.settingsSaved', 'ä½ç½®å’Œæ¨¡å‹è®¾ç½®ä¿å­˜æˆåŠŸ!'), 2000);
                window.hasUnsavedChanges = false; // ä¿å­˜æˆåŠŸåé‡ç½®æ ‡å¿—
            } else if (positionSuccess) {
                showStatus(t('live2d.positionSavedModelFailed', 'ä½ç½®ä¿å­˜æˆåŠŸï¼Œæ¨¡å‹è®¾ç½®ä¿å­˜å¤±è´¥!'), 2000);
            } else if (modelSuccess) {
                showStatus(t('live2d.modelSavedPositionFailed', 'æ¨¡å‹è®¾ç½®ä¿å­˜æˆåŠŸï¼Œä½ç½®ä¿å­˜å¤±è´¥!'), 2000);
            } else {
                showStatus(t('live2d.saveFailedGeneral', 'ä¿å­˜å¤±è´¥!'), 2000);
            }
        });
        
        // è¿”å›ä¸»é¡µ/å…³é—­æŒ‰é’®
        backToMainBtn.addEventListener('click', async () => {
            // æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ›´æ”¹
            console.log('è¿”å›æŒ‰é’®è¢«ç‚¹å‡»ï¼ŒhasUnsavedChanges =', window.hasUnsavedChanges);
            if (window.hasUnsavedChanges) {
                console.log('æ£€æµ‹åˆ°æœªä¿å­˜çš„æ›´æ”¹ï¼Œæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†');
                const message = t('dialogs.unsavedChanges', 'æ‚¨æœ‰æœªä¿å­˜çš„è®¾ç½®ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ');
                const title = t('dialogs.confirmLeave', 'ç¡®è®¤ç¦»å¼€');
                const confirmLeave = await showConfirm(message, title, { danger: true });
                console.log('ç”¨æˆ·é€‰æ‹©:', confirmLeave ? 'ç¡®å®šç¦»å¼€' : 'å–æ¶ˆ');
                if (!confirmLeave) {
                    return; // ç”¨æˆ·å–æ¶ˆï¼Œä¸ç¦»å¼€
                }
            } else {
                console.log('æ²¡æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç›´æ¥è¿”å›');
            }
            
            // å¦‚æœå¤„äºå…¨å±çŠ¶æ€ï¼Œå…ˆé€€å‡ºå…¨å±
            if (isFullscreen()) {
                try {
                    await exitFullscreen();
                    // ç­‰å¾…å…¨å±é€€å‡ºå®Œæˆ
                    await new Promise(resolve => setTimeout(resolve, 100));
                } catch (e) {
                    console.log('é€€å‡ºå…¨å±å¤±è´¥:', e);
                }
            }
            
            // æ ¹æ®çª—å£ç±»å‹æ‰§è¡Œä¸åŒçš„æ“ä½œ
            if (isPopupWindow) {
                // å¦‚æœæ˜¯å¼¹å‡ºçª—å£ï¼Œç›´æ¥å…³é—­
                window.close();
            } else {
                // å¦‚æœæ˜¯ä¸»çª—å£è·³è½¬ï¼Œç›´æ¥è·³è½¬å³å¯ï¼Œæ–°é¡µé¢ä¼šè‡ªåŠ¨åŠ è½½æœ€æ–°é…ç½®
                window.location.href = '/';
            }
        });

        // ä¸Šä¼ æ¨¡å‹åŠŸèƒ½
        uploadBtn.addEventListener('click', () => {
            modelUpload.click();
        });

        modelUpload.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            uploadStatus.textContent = t('live2d.uploadingModel', 'æ­£åœ¨ä¸Šä¼ æ¨¡å‹...');
            uploadStatus.style.color = '#4f8cff';
            uploadBtn.disabled = true;

            try {
                const formData = new FormData();
                
                // æ·»åŠ æ‰€æœ‰æ–‡ä»¶åˆ°FormData
                for (const file of files) {
                    // ä¿ç•™æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„
                    formData.append('files', file, file.webkitRelativePath || file.name);
                }

                const response = await fetch('/api/live2d/upload_model', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    uploadStatus.textContent = t('live2d.uploadSuccess', `âœ“ ${result.message}`, {message: result.message});
                    uploadStatus.style.color = '#28a745';
                    
                    // é‡æ–°åŠ è½½æ¨¡å‹åˆ—è¡¨
                    setTimeout(async () => {
                        try {
                            const modelsResponse = await fetch('/api/live2d/models');
                            availableModels = await modelsResponse.json();
                            modelSelect.innerHTML = `<option value="">${t('live2d.pleaseSelectModel', 'è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹')}</option>`;
                            availableModels.forEach(model => {
                                const option = document.createElement('option');
                                option.value = model.name;
                                option.textContent = model.name;
                                modelSelect.appendChild(option);
                            });
                            
                            // è‡ªåŠ¨é€‰æ‹©æ–°ä¸Šä¼ çš„æ¨¡å‹
                            if (result.model_name) {
                                modelSelect.value = result.model_name;
                                modelSelect.dispatchEvent(new Event('change'));
                            }
                            
                            uploadStatus.textContent = '';
                        } catch (e) {
                            console.error('é‡æ–°åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', e);
                        }
                    }, 1500);
                } else {
                    uploadStatus.textContent = t('live2d.uploadFailed', `âœ— ${result.error}`, {error: result.error});
                    uploadStatus.style.color = '#dc3545';
                    setTimeout(() => {
                        uploadStatus.textContent = '';
                    }, 5000);
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                uploadStatus.textContent = t('live2d.uploadError', `âœ— ä¸Šä¼ å¤±è´¥: ${error.message}`, {error: error.message});
                uploadStatus.style.color = '#dc3545';
                setTimeout(() => {
                    uploadStatus.textContent = '';
                }, 5000);
            } finally {
                uploadBtn.disabled = false;
                // é‡ç½®file inputä»¥å…è®¸é‡æ–°é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶å¤¹
                modelUpload.value = '';
            }
        });

        // Helper functions
        function setControlsDisabled(disabled) {
            motionSelect.disabled = disabled;
            expressionSelect.disabled = disabled;
            playMotionBtn.disabled = disabled;
            playExpressionBtn.disabled = disabled;
            emotionManagerBtn.disabled = disabled;
            savePositionBtn.disabled = disabled;
            persistentSelect.disabled = disabled;
            addPersistentBtn.disabled = disabled;
            savePersistentBtn.disabled = disabled;
        }

        function updateSelectWithOptions(select, options, defaultText, type) {
            select.innerHTML = `<option value="">${defaultText}</option>`;
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                
                if (type === 'expression') {
                    const displayName = opt.split('/').pop().replace('.exp3.json', '');
                    option.textContent = displayName;
                } else if (type === 'motion') {
                    const displayName = opt.split('/').pop().replace('.motion3.json', '');
                    option.textContent = displayName;
                } else {
                    option.textContent = opt;
                }
                select.appendChild(option);
            });
        }

        function openModal(url) {
            const modal = document.createElement('div');
            modal.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; justify-content: center; align-items: center;`;
            
            const iframeContainer = document.createElement('div');
            iframeContainer.style.cssText = `background: white; border-radius: 15px; width: 95%; height: 95%; max-width: 1500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden;`;

            const header = document.createElement('div');
            header.style.cssText = `padding: 12px 20px; background: #f1f3f5; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;`;
            
            const title = document.createElement('h3');
            title.textContent = t('emotion.manager', 'æƒ…æ„Ÿé…ç½®ç®¡ç†å™¨');
            title.style.cssText = 'margin: 0;';

            const closeButton = document.createElement('button');
            closeButton.textContent = 'Ã—';
            closeButton.style.cssText = `background: none; border: none; font-size: 24px; cursor: pointer;`;

            const iframe = document.createElement('iframe');
            iframe.src = url;
            iframe.style.cssText = 'width: 100%; height: 100%; border: none;';

            const closeModal = () => {
                modal.remove();
                if (currentModelInfo) {
                    modelSelect.value = currentModelInfo.name;
                    modelSelect.dispatchEvent(new Event('change'));
                }
            };
            
            closeButton.onclick = closeModal;
            header.appendChild(title);
            header.appendChild(closeButton);
            iframeContainer.appendChild(header);
            iframeContainer.appendChild(iframe);
            modal.appendChild(iframeContainer);
            document.body.appendChild(modal);
        }

        // ===== å¸¸é©»è¡¨æƒ… ç®¡ç† =====
        async function loadEmotionMappingForModel(modelName) {
            currentEmotionMapping = null;
            currentPersistent = [];
            try {
                const res = await fetch(`/api/live2d/emotion_mapping/${encodeURIComponent(modelName)}`);
                const data = await res.json();
                if (data && data.success && data.config) {
                    currentEmotionMapping = data.config;
                } else {
                    currentEmotionMapping = { motions: {}, expressions: {} };
                }
            } catch (e) {
                currentEmotionMapping = { motions: {}, expressions: {} };
            }
            const expr = (currentEmotionMapping.expressions || {});
            currentPersistent = Array.isArray(expr['å¸¸é©»']) ? [...expr['å¸¸é©»']] : [];
            // å°†åç«¯æ˜ å°„åº”ç”¨åˆ°å‰ç«¯ Live2D ç®¡ç†å™¨å¹¶å¯ç”¨å¸¸é©»
            try {
                if (window.live2dManager) {
                    const mgr = window.live2dManager;
                    if (!mgr.emotionMapping) mgr.emotionMapping = { motions: {}, expressions: {} };
                    if (!mgr.emotionMapping.expressions) mgr.emotionMapping.expressions = {};
                    mgr.emotionMapping.expressions['å¸¸é©»'] = [...currentPersistent];
                    await mgr.setupPersistentExpressions();
                }
            } catch (e) { console.warn('åº”ç”¨å¸¸é©»è¡¨æƒ…å¤±è´¥:', e); }
        }

        function renderPersistentUI() {
            persistentBox.style.display = '';
            // å¯é€‰ï¼šæ‰€æœ‰è¡¨è¾¾å¼ - å·²é€‰ï¼ˆå¸¸é©»ï¼‰
            const unused = (currentModelFiles.expression_files || []).filter(f => !currentPersistent.includes(f));
            updateSelectWithOptions(persistentSelect, unused, t('live2d.selectPersistentExpression', 'é€‰æ‹©å¸¸é©»è¡¨æƒ…'), 'expression');

            // åˆ—è¡¨
            if (!currentPersistent.length) {
                persistentList.innerHTML = `<div style="color:#999;">${t('live2d.noPersistentExpressions', 'å°šæœªæ·»åŠ å¸¸é©»è¡¨æƒ…')}</div>`;
            } else {
                persistentList.innerHTML = currentPersistent.map(f => {
                    const name = f.split('/').pop().replace('.exp3.json','');
                    const removeLabel = t('common.delete', 'ç§»é™¤');
                    return `<div style="display:flex; align-items:center; justify-content:space-between; padding:4px 6px; border-bottom:1px dashed #eee;">
                        <span>${name}</span>
                        <button data-file="${f}" class="btn btn-secondary" style="padding:4px 8px; font-size:12px;">${removeLabel}</button>
                    </div>`;
                }).join('');
                // ç»‘å®šç§»é™¤
                Array.from(persistentList.querySelectorAll('button[data-file]')).forEach(btn => {
                    btn.onclick = async () => {
                        const file = btn.getAttribute('data-file');
                        const idx = currentPersistent.indexOf(file);
                        if (idx > -1) currentPersistent.splice(idx, 1);
                        window.hasUnsavedChanges = true; // æ ‡è®°ä¸ºæœ‰æœªä¿å­˜çš„æ›´æ”¹
                        renderPersistentUI();
                        // å³æ—¶åŒæ­¥åˆ°å‰ç«¯å¹¶åº”ç”¨
                        try {
                            if (window.live2dManager) {
                                const mgr = window.live2dManager;
                                if (!mgr.emotionMapping) mgr.emotionMapping = { motions: {}, expressions: {} };
                                if (!mgr.emotionMapping.expressions) mgr.emotionMapping.expressions = {};
                                mgr.emotionMapping.expressions['å¸¸é©»'] = [...currentPersistent];
                                await mgr.setupPersistentExpressions();
                                showStatus(t('live2d.updatedPersistentExpression', 'å·²æ›´æ–°å¸¸é©»è¡¨æƒ…'), 1200);
                            }
                        } catch (e) { console.warn('åº”ç”¨å¸¸é©»è¡¨æƒ…å¤±è´¥:', e); }
                    };
                });
            }
            // å¯ç”¨ç›¸å…³æ§ä»¶
            persistentSelect.disabled = false;
            addPersistentBtn.disabled = false;
            savePersistentBtn.disabled = false;
        }

        addPersistentBtn.addEventListener('click', async () => {
            const file = persistentSelect.value;
            if (!file) return;
            if (!currentPersistent.includes(file)) {
                currentPersistent.push(file);
                window.hasUnsavedChanges = true; // æ ‡è®°ä¸ºæœ‰æœªä¿å­˜çš„æ›´æ”¹
            }
            renderPersistentUI();
            // å³æ—¶åŒæ­¥åˆ°å‰ç«¯å¹¶åº”ç”¨
            try {
                if (window.live2dManager) {
                    const mgr = window.live2dManager;
                    if (!mgr.emotionMapping) mgr.emotionMapping = { motions: {}, expressions: {} };
                    if (!mgr.emotionMapping.expressions) mgr.emotionMapping.expressions = {};
                    mgr.emotionMapping.expressions['å¸¸é©»'] = [...currentPersistent];
                    await mgr.setupPersistentExpressions();
                    showStatus(t('live2d.appliedPersistentExpression', 'å¸¸é©»è¡¨æƒ…å·²åº”ç”¨'), 1200);
                }
            } catch (e) { console.warn('åº”ç”¨å¸¸é©»è¡¨æƒ…å¤±è´¥:', e); }
        });

        savePersistentBtn.addEventListener('click', async () => {
            if (!currentModelInfo) return;
            showStatus(t('live2d.savingPersistentExpression', 'æ­£åœ¨ä¿å­˜å¸¸é©»è¡¨æƒ…...'));
            try {
                // åˆå¹¶æ—§æ˜ å°„ï¼šä¿ç•™ motionsï¼Œä¿ç•™ expressions å…¶ä»–ç»„ï¼Œä»…æ›¿æ¢ å¸¸é©» ç»„
                const motions = (currentEmotionMapping && currentEmotionMapping.motions) ? currentEmotionMapping.motions : {};
                const expressions = Object.assign({}, (currentEmotionMapping && currentEmotionMapping.expressions) ? currentEmotionMapping.expressions : {});
                expressions['å¸¸é©»'] = [...currentPersistent];

                const body = { motions, expressions };
                const resp = await fetch(`/api/live2d/emotion_mapping/${encodeURIComponent(currentModelInfo.name)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const result = await resp.json();
                if (result && result.success) {
                    showStatus(t('live2d.persistentExpressionSaved', 'å¸¸é©»è¡¨æƒ…ä¿å­˜æˆåŠŸ'), 1500);
                    window.hasUnsavedChanges = false; // ä¿å­˜æˆåŠŸåé‡ç½®æ ‡å¿—
                    // é€šçŸ¥å‰ç«¯ç®¡ç†å™¨é‡æ–°åº”ç”¨å¸¸é©»ï¼Œæ— éœ€é‡è½½æ¨¡å‹
                    if (window.live2dManager && window.live2dManager.setupPersistentExpressions) {
                        await window.live2dManager.setupPersistentExpressions();
                    }
                } else {
                    showStatus(t('live2d.persistentExpressionSaveFailed', 'ä¿å­˜å¸¸é©»è¡¨æƒ…å¤±è´¥'), 2000);
                }
            } catch (e) {
                console.error(e);
                showStatus(t('live2d.persistentExpressionSaveFailed', 'ä¿å­˜å¸¸é©»è¡¨æƒ…å¤±è´¥'), 2000);
            }
        });

        // åŠ è½½å½“å‰è§’è‰²æ¨¡å‹çš„å‡½æ•°
        async function loadCurrentCharacterModel() {
            try {
                // è·å–è§’è‰²åç§°
                const lanlanName = await getLanlanName();
                
                let apiUrl = '/api/characters/current_live2d_model';
                if (lanlanName) {
                    apiUrl += `?catgirl_name=${encodeURIComponent(lanlanName)}`;
                }
                
                const currentModelResponse = await fetch(apiUrl);
                const currentModelData = await currentModelResponse.json();
                
                if (!currentModelData.success) {
                    console.log('æ— æ³•è·å–å½“å‰è§’è‰²æ¨¡å‹ä¿¡æ¯:', currentModelData.error);
                    return;
                }
                
                const { catgirl_name, model_name, model_info } = currentModelData;
                
                if (model_name && model_info) {
                    // å¦‚æœè§’è‰²æœ‰è®¾ç½®çš„æ¨¡å‹ï¼Œè‡ªåŠ¨åŠ è½½
                    console.log(`è‡ªåŠ¨åŠ è½½è§’è‰² ${catgirl_name} çš„æ¨¡å‹: ${model_name}`);
                    showStatus(t('live2d.loadingCharacterModel', `æ­£åœ¨åŠ è½½è§’è‰² ${catgirl_name} çš„æ¨¡å‹: ${model_name}...`, {name: catgirl_name, model: model_name}));
                    
                    // è®¾ç½®æ¨¡å‹é€‰æ‹©å™¨
                    currentModelInfo = model_info;
                    modelSelect.value = model_name;
                    
                    // åŠ è½½æ¨¡å‹
                    await loadModel(model_name, model_info);
                    
                    showStatus(t('live2d.modelLoaded', `å·²åŠ è½½è§’è‰² ${catgirl_name} çš„æ¨¡å‹: ${model_name}`, {name: catgirl_name, model: model_name}));
                } else {
                    // å¦‚æœè§’è‰²æ²¡æœ‰è®¾ç½®æ¨¡å‹ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                    console.log(`è§’è‰² ${catgirl_name} æœªè®¾ç½®Live2Dæ¨¡å‹`);
                    showStatus(t('live2d.modelNotSet', `è§’è‰² ${catgirl_name} æœªè®¾ç½®æ¨¡å‹ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©`, {name: catgirl_name}));
                }
            } catch (error) {
                console.error('åŠ è½½å½“å‰è§’è‰²æ¨¡å‹å¤±è´¥:', error);
                showStatus(t('live2d.loadCurrentModelFailed', 'åŠ è½½å½“å‰è§’è‰²æ¨¡å‹å¤±è´¥'));
            }
        }
    });
// ç›‘å¬é¡µé¢å¸è½½äº‹ä»¶ï¼Œç¡®ä¿è¿”å›æ—¶ä¸»ç•Œé¢å¯è§
        window.addEventListener('beforeunload', (e) => {
            // å°è¯•é€€å‡ºå…¨å±
            if (isFullscreen()) {
                try {
                    exitFullscreen();
                } catch (err) {
                    console.log('é€€å‡ºå…¨å±å¤±è´¥:', err);
                }
            }
            
            sendMessageToMainPage('show_main_ui');
            
            // å¦‚æœæœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œé˜»æ­¢é¡µé¢å…³é—­å¹¶æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            // æ³¨æ„ï¼šç°ä»£æµè§ˆå™¨ä¼šå¿½ç•¥è‡ªå®šä¹‰æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæ ‡å‡†çš„ç¡®è®¤å¯¹è¯æ¡†
            if (window.hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = ''; // Chromeéœ€è¦è¿™ä¸ª
                return ''; // æŸäº›æµè§ˆå™¨éœ€è¦è¿”å›å€¼
            }
        });
        
        // ç¡®ä¿åœ¨é¡µé¢å…³é—­æ—¶ä¹Ÿæ¢å¤ä¸»ç•Œé¢
        window.addEventListener('unload', () => {
            sendMessageToMainPage('show_main_ui');
        });
        </script>

</body>
</html>
