<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steamåˆ›æ„å·¥åŠç®¡ç†</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        h1 {
            color: #1b2838;
            margin-bottom: 30px;
            border-bottom: 2px solid #2a475e;
            padding-bottom: 10px;
        }
        /* é¡µé¢æ§åˆ¶åŒºæ ·å¼ */
        .page-controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        
        /* ä¸Šä¼ åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .upload-toggle-button {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s, transform 0.2s;
        }
        
        .upload-toggle-button:hover {
            background-color: #229954;
            transform: translateY(-2px);
        }
        
        .upload-toggle-button:active {
            transform: translateY(0);
        }
        
        /* ä¸Šä¼ åŒºåŸŸå®¹å™¨æ ·å¼ */
        .upload-section-container {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        .button {
            background-color: #2a475e;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .button:hover {
            background-color: #1b2838;
        }
        .button-danger {
            background-color: #e74c3c;
        }
        .button-danger:hover {
            background-color: #c0392b;
        }
        .upload-section {
            margin-bottom: 30px;
        }
        .file-upload {
            border: 2px dashed #ddd;
            padding: 20px;
            text-align: center;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .file-upload.dragover {
            border-color: #2a475e;
            background-color: #f0f4f8;
        }
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .tag {
            background-color: #e1e8ed;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        .tag-remove {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-published {
            background-color: #2ecc71;
        }
        .status-pending {
            background-color: #f39c12;
        }
        .status-failed {
            background-color: #e74c3c;
        }
        .filter-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .pagination button {
            margin: 0 5px;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        .success-message,
        .error-message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .success-message {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            position: relative;
            padding-right: 30px;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            position: relative;
            padding-right: 30px;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .warning-message {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            position: relative;
            padding-right: 30px;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .message-close {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            color: inherit;
            opacity: 0.7;
        }
        .message-close:hover {
            opacity: 1;
        }
        .input.error {
            border-color: #dc3545;
            background-color: #fdf2f2;
        }
        .button-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .button-sm {
            font-size: 14px;
            padding: 5px 10px;
            margin: 0 5px;
        }
        
        /* ä¸ºè¡¨å•è¾“å…¥æ·»åŠ é”™è¯¯çŠ¶æ€æ ·å¼ */
        input.error,
        textarea.error,
        select.error {
            border-color: #dc3545;
            background-color: #fdf2f2;
        }
        
        /* æ·»åŠ è¡¨å•ç»„çš„é”™è¯¯æç¤ºæ ·å¼ */
        .form-group.error {
            color: #dc3545;
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* å¡ç‰‡æ ·å¼ */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .workshop-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
        }
        .workshop-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }
        .card-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
        }
        .card-content {
            padding: 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .card-title {
            font-size: 18px;
            font-weight: bold;
            margin: 0 0 8px 0;
            color: #1b2838;
        }
        .card-author {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }
        .card-info {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }
        
        /* ç‰©å“çŠ¶æ€æ ·å¼ */
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .status-subscribed {
            background-color: #e3f2fd;
            color: #1565c0;
        }

        .status-installed {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .status-downloading {
            background-color: #fff3e0;
            color: #ef6c00;
            animation: pulse 2s infinite;
        }

        .status-needs-update {
            background-color: #fff8e1;
            color: #ff8f00;
        }

        .status-error {
            background-color: #ffebee;
            color: #c62828;
        }

        @keyframes pulse {
            0% {
                opacity: 0.7;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.7;
            }
        }
        
        /* ä¸‹è½½è¿›åº¦æ¡æ ·å¼ */
        .download-progress {
            margin: 8px 0;
            width: 100%;
        }
        
        .progress-bar {
            width: 100%;
            height: 16px;
            background-color: #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #2196f3;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7em;
            font-weight: bold;
            transition: width 0.3s ease;
        }
        
        /* ç”¨æˆ·å¤´åƒæ ·å¼ */
        .author-info {
            display: flex;
            align-items: center;
            margin: 4px 0;
        }
        
        .author-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 6px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            color: #666;
        }
        .card-actions {
            margin-top: auto;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .card-actions .button {
            font-size: 14px;
            padding: 8px 12px;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .cards-container {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            }
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: modalFadeIn 0.3s ease-out;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
            background-color: #f9f9f9;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #1b2838;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #7f8c8d;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .modal-close:hover {
            background-color: #e0e0e0;
            color: #333;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
            background-color: #f9f9f9;
            gap: 10px;
        }
        
        .item-detail-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .item-preview-large {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 4px;
        }
        
        .item-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .item-info-item {
            margin: 0;
        }
        
        .item-info-label {
            font-weight: bold;
            color: #1b2838;
        }
        
        .item-description {
            margin-top: 16px;
            line-height: 1.6;
        }
        
        .info-box {
            background-color: #e1f5fe;
            border-left: 4px solid #0288d1;
            padding: 12px 16px;
            margin: 16px 0;
            border-radius: 4px;
        }
        
        .info-box p {
            margin: 0;
            color: #01579b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Steamåˆ›æ„å·¥åŠç®¡ç†</h1>
        
        <!-- é¡µé¢æ§åˆ¶åŒº -->
        <div class="page-controls">
            <button id="upload-toggle-button" class="upload-toggle-button" onclick="toggleUploadSection()">ä¸Šä¼ å†…å®¹åˆ°åˆ›æ„å·¥åŠ</button>
            <button id="local-items-toggle-button" class="upload-toggle-button" onclick="toggleLocalItemsSection()">ç®¡ç†æœ¬åœ°ç‰©å“</button>
        </div>
        
        <!-- ä¸Šä¼ å†…å®¹éƒ¨åˆ† -->
        <div id="upload" class="upload-section-container" style="display: none;">
            <div class="upload-section">
                <h2>ä¸Šä¼ åˆ°åˆ›æ„å·¥åŠ</h2>
                <div class="info-box">
                    <p>è¯·å…ˆåœ¨"ç®¡ç†æœ¬åœ°ç‰©å“"åŒºåŸŸé€‰æ‹©ä¸€ä¸ªæœªå‘å¸ƒçš„ç‰©å“ï¼Œç„¶åç‚¹å‡»"å‡†å¤‡ä¸Šä¼ "æŒ‰é’®ã€‚å†…å®¹æ–‡ä»¶å¤¹è·¯å¾„å’Œé¢„è§ˆå›¾ç‰‡è·¯å¾„å°†è‡ªåŠ¨å¡«å……ã€‚</p>
                </div>
                
                <div id="message-area"></div>
                
                <div class="form-group">
                    <label for="item-title">æ ‡é¢˜ *</label>
                    <input type="text" id="item-title" placeholder="è¾“å…¥æ‚¨çš„åˆ›ä½œæ ‡é¢˜">
                </div>
                
                <div class="form-group">
                    <label for="item-description">æè¿°</label>
                    <textarea id="item-description" placeholder="è¯¦ç»†æè¿°æ‚¨çš„åˆ›ä½œå†…å®¹..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="content-folder">å†…å®¹æ–‡ä»¶å¤¹è·¯å¾„ *</label>
                    <input type="text" id="content-folder" placeholder="ä»æœ¬åœ°ç‰©å“ä¸­è·å–çš„å†…å®¹æ–‡ä»¶å¤¹è·¯å¾„" aria-describedby="content-folder-help" readonly>
                    <small id="content-folder-help">æ­¤è·¯å¾„ä»æ‚¨é€‰æ‹©çš„æœ¬åœ°ç‰©å“ä¸­è‡ªåŠ¨è·å–ï¼Œä¸å¯æ‰‹åŠ¨ä¿®æ”¹ã€‚è¯·å…ˆåœ¨"ç®¡ç†æœ¬åœ°ç‰©å“"ä¸­é€‰æ‹©è¦ä¸Šä¼ çš„ç‰©å“ã€‚</small>
                </div>
                
                <div class="form-group">
                    <label for="preview-image">é¢„è§ˆå›¾ç‰‡è·¯å¾„ *</label>
                    <input type="text" id="preview-image" placeholder="ä»æœ¬åœ°ç‰©å“ä¸­è·å–çš„é¢„è§ˆå›¾ç‰‡è·¯å¾„" aria-describedby="preview-image-help" readonly>
                    <small id="preview-image-help">æ­¤è·¯å¾„ä»æ‚¨é€‰æ‹©çš„æœ¬åœ°ç‰©å“ä¸­è‡ªåŠ¨è·å–ï¼Œä¸å¯æ‰‹åŠ¨ä¿®æ”¹ã€‚</small>
                </div>
                
                <div class="form-group">
                    <label for="item-tags">æ ‡ç­¾</label>
                    <input type="text" id="item-tags" placeholder="è¾“å…¥æ ‡ç­¾ï¼ŒæŒ‰å›è½¦æ·»åŠ ">
                    <div id="tags-container" class="tags-container"></div>
                </div>
                
                <div class="form-group">
                    <label for="visibility">å¯è§æ€§</label>
                    <select id="visibility">
                        <option value="public">å…¬å¼€</option>
                        <option value="friends">ä»…å¥½å‹å¯è§</option>
                        <option value="private">ç§æœ‰</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="allow-comments">
                        <input type="checkbox" id="allow-comments" checked>
                        å…è®¸è¯„è®º
                    </label>
                </div>
                
                <button class="button" onclick="uploadItem()">ä¸Šä¼ åˆ°åˆ›æ„å·¥åŠ</button>
            </div>
        </div>
        
        <!-- æœ¬åœ°ç‰©å“ç®¡ç†éƒ¨åˆ† -->
        <div id="local-items" class="upload-section-container" style="display: none;">
            <div class="local-items-section">
                <h2>ç®¡ç†æœ¬åœ°ç‰©å“</h2>
                
                <div class="form-group">
                    <label for="scan-folder">æ‰«ææ–‡ä»¶å¤¹è·¯å¾„</label>
                    <input type="text" id="scan-folder" placeholder="è¯·é€‰æ‹©åˆ›æ„å·¥åŠç‰©å“æ–‡ä»¶å¤¹" aria-describedby="scan-folder-help" readonly>
                    <input type="file" id="folder-selector" style="display: none;" webkitdirectory directory multiple>
                    <small id="scan-folder-help">é€‰æ‹©åŒ…å«åˆ›æ„å·¥åŠç‰©å“çš„æ–‡ä»¶å¤¹ï¼Œä¾‹å¦‚: D:\Steam\steamapps\workshop\content\æ¸¸æˆID</small>
                    <div style="display: flex; gap: 10px;">
                        <button class="button button-sm" onclick="document.getElementById('folder-selector').click()">æµè§ˆ...</button>
                        <button class="button button-sm" onclick="scanLocalItems()">æ‰«æç‰©å“</button>
                    </div>
                </div>
                
                <div id="local-items-list" class="cards-container">
                    <div class="empty-state">
                        <p>è¯·é€‰æ‹©å¹¶æ‰«æä¸€ä¸ªåŒ…å«åˆ›æ„å·¥åŠç‰©å“çš„æ–‡ä»¶å¤¹</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æˆ‘çš„è®¢é˜…éƒ¨åˆ† -->
        <div id="subscriptions">
            <h2>æˆ‘çš„è®¢é˜…ç‰©å“</h2>
            
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="search-subscription">æœç´¢ï¼š</label>
                    <input type="text" id="search-subscription" placeholder="æœç´¢è®¢é˜…å†…å®¹...">
                </div>
                <div class="filter-group">
                    <label for="sort-subscription">æ’åºï¼š</label>
                    <select id="sort-subscription">
                        <option value="name_asc">åç§°ï¼ˆå‡åºï¼‰</option>
                        <option value="name_desc">åç§°ï¼ˆé™åºï¼‰</option>
                        <option value="date_asc">è®¢é˜…æ—¥æœŸï¼ˆå‡åºï¼‰</option>
                        <option value="date_desc">è®¢é˜…æ—¥æœŸï¼ˆé™åºï¼‰</option>
                    </select>
                </div>
            </div>
            
            <div id="subscriptions-result">
                <!-- å¡ç‰‡å®¹å™¨ -->
                <div id="subscriptions-list" class="cards-container">
                    <!-- ç©ºçŠ¶æ€ -->
                    <div class="empty-state">
                        <p>æ­£åœ¨åŠ è½½æ‚¨çš„è®¢é˜…ç‰©å“...</p>
                        <button class="button" onclick="loadSubscriptions()">é‡æ–°åŠ è½½</button>
                    </div>
                </div>
                <!-------------------------------------å¾…åš------------------------------------>
                <div class="pagination">
                    <button class="button" disabled>ä¸Šä¸€é¡µ</button>
                    <span>ç¬¬ 1 é¡µï¼Œå…± 0 é¡µ</span>
                    <button class="button" disabled>ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
    </div>
    
    <!-- ç‰©å“è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="itemDetailsModal" class="modal" onclick="closeModalOnOutsideClick(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">ç‰©å“è¯¦æƒ…</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="itemDetailContent" class="item-detail-container">
                    <!-- ç‰©å“è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    <div class="empty-state">
                        <p>æ­£åœ¨åŠ è½½ç‰©å“è¯¦æƒ…...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button" onclick="closeModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // ä¸Šä¼ åŒºåŸŸåˆ‡æ¢åŠŸèƒ½
        function toggleUploadSection() {
            const uploadSection = document.getElementById('upload');
            const toggleButton = document.getElementById('upload-toggle-button');
            
            // åˆ‡æ¢ä¸Šä¼ åŒºåŸŸçš„æ˜¾ç¤º/éšè—
            if (uploadSection.style.display === 'none') {
                uploadSection.style.display = 'block';
                toggleButton.textContent = 'éšè—ä¸Šä¼ å†…å®¹';
                // å¹³æ»‘æ»šåŠ¨åˆ°ä¸Šä¼ åŒºåŸŸ
                uploadSection.scrollIntoView({ behavior: 'smooth' });
            } else {
                uploadSection.style.display = 'none';
            }
        }
        
        // æœ¬åœ°ç‰©å“åŒºåŸŸåˆ‡æ¢åŠŸèƒ½
        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            async function doesFileExist(filePath) {
                try {
                    const response = await fetch(`/api/file-exists?path=${encodeURIComponent(filePath)}`);
                    const result = await response.json();
                    return result.exists;
                } catch (error) {
                    // å¦‚æœAPIä¸å¯ç”¨ï¼Œè¿”å›false
                    return false;
                }
            }
            
            // æŸ¥æ‰¾é¢„è§ˆå›¾ç‰‡
            async function findPreviewImage(folderPath) {
                try {
                    // å°è¯•æŸ¥æ‰¾å¸¸è§çš„é¢„è§ˆå›¾ç‰‡æ–‡ä»¶
                    const commonImageNames = ['preview.jpg', 'preview.png', 'thumbnail.jpg', 'thumbnail.png', 'icon.jpg', 'icon.png', 'header.jpg', 'header.png'];
                    
                    for (const imageName of commonImageNames) {
                        const imagePath = `${folderPath}/${imageName}`;
                        if (await doesFileExist(imagePath)) {
                            return imagePath;
                        }
                    }
                    
                    // å¦‚æœæ‰¾ä¸åˆ°å¸¸è§é¢„è§ˆå›¾ï¼Œå°è¯•ä½¿ç”¨APIè·å–æ–‡ä»¶å¤¹ä¸­çš„ç¬¬ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶
                    const response = await fetch(`/api/find-first-image?folder=${encodeURIComponent(folderPath)}`);
                    const result = await response.json();
                    
                    if (result.success && result.imagePath) {
                        return result.imagePath;
                    }
                } catch (error) {
                    console.error('æŸ¥æ‰¾é¢„è§ˆå›¾ç‰‡å¤±è´¥:', error);
                }
                
                return null;
            }
            
            // æ ¼å¼åŒ–æ—¥æœŸ
            function formatDate(date) {
                return new Date(date).toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            // åˆ›æ„å·¥åŠç‰©å“å¯¹æ¯”
            async function compareLocalWithWorkshop(localItem) {
                try {
                    // è·å–å·²å‘å¸ƒçš„åˆ›æ„å·¥åŠç‰©å“
                    const workshopItems = await getWorkshopItems();
                    
                    // æ¯”è¾ƒåç§°
                    for (const workshopItem of workshopItems) {
                        if (areNamesSimilar(localItem.name, workshopItem.title)) {
                            return {
                                exists: true,
                                item: workshopItem,
                                reason: 'åç§°ç›¸ä¼¼'
                            };
                        }
                    }
                } catch (error) {
                    console.error('åˆ›æ„å·¥åŠå¯¹æ¯”å¤±è´¥:', error);
                }
                
                return { exists: false };
            }
            
            // æ£€æŸ¥åç§°æ˜¯å¦ç›¸ä¼¼
            function areNamesSimilar(name1, name2) {
                // ç®€å•çš„ç›¸ä¼¼åº¦æ£€æŸ¥ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ”¹è¿›
                name1 = name1.toLowerCase().trim();
                name2 = name2.toLowerCase().trim();
                
                // å¦‚æœå®Œå…¨ç›¸åŒï¼Œç›´æ¥è¿”å›true
                if (name1 === name2) return true;
                
                // å¦‚æœä¸€ä¸ªåç§°åŒ…å«å¦ä¸€ä¸ªåç§°
                if (name1.includes(name2) || name2.includes(name1)) return true;
                
                // è®¡ç®—ç¼–è¾‘è·ç¦»ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
                if (Math.abs(name1.length - name2.length) > 3) return false;
                
                return false;
            }
            
            // è·å–åˆ›æ„å·¥åŠç‰©å“åˆ—è¡¨
            async function getWorkshopItems() {
                try {
                    const response = await fetch('/api/steam/workshop/subscribed-items');
                    const data = await response.json();
                    if (data.success) {
                        return data.items;
                    }
                } catch (error) {
                    console.error('è·å–åˆ›æ„å·¥åŠç‰©å“å¤±è´¥:', error);
                }
                return [];
            }
            
            function toggleLocalItemsSection() {
            const localItemsSection = document.getElementById('local-items');
            const toggleButton = document.getElementById('local-items-toggle-button');
            
            // åˆ‡æ¢æœ¬åœ°ç‰©å“åŒºåŸŸçš„æ˜¾ç¤º/éšè—
            if (localItemsSection.style.display === 'none') {
                localItemsSection.style.display = 'block';
                toggleButton.textContent = 'éšè—æœ¬åœ°ç‰©å“';
                // å¹³æ»‘æ»šåŠ¨åˆ°æœ¬åœ°ç‰©å“åŒºåŸŸ
                localItemsSection.scrollIntoView({ behavior: 'smooth' });
            } else {
                localItemsSection.style.display = 'none';
                toggleButton.textContent = 'ç®¡ç†æœ¬åœ°ç‰©å“';
            }
        }
        
        // æ–‡ä»¶å¤¹é€‰æ‹©äº‹ä»¶å¤„ç†
        document.getElementById('folder-selector').addEventListener('change', function(e) {
            if (e.target.files && e.target.files.length > 0) {
                // è·å–é€‰æ‹©çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶å¤¹çš„è·¯å¾„
                const folderPath = e.target.files[0].webkitRelativePath ? 
                    e.target.files[0].webkitRelativePath.split('/')[0] : 
                    e.target.files[0].path;
                
                // æœ‰äº›æµè§ˆå™¨å¯èƒ½åªè¿”å›æ–‡ä»¶åï¼Œéœ€è¦æå–å®Œæ•´è·¯å¾„
                if (!folderPath.includes('\\') && !folderPath.includes('/')) {
                    const fullPath = e.target.files[0].path;
                    const pathParts = fullPath.split(/[\\/]/);
                    // ç§»é™¤æœ€åä¸€éƒ¨åˆ†ï¼ˆæ–‡ä»¶åï¼‰
                    pathParts.pop();
                    document.getElementById('scan-folder').value = pathParts.join('\\');
                } else {
                    document.getElementById('scan-folder').value = folderPath;
                }
            }
        });

        // æ‰«ææœ¬åœ°ç‰©å“
        function scanLocalItems() {
            const folderPath = document.getElementById('scan-folder').value.trim();
            
            if (!folderPath) {
                showMessage('è¯·è¾“å…¥è¦æ‰«æçš„æ–‡ä»¶å¤¹è·¯å¾„', 'error');
                return;
            }
            
            // ç®€åŒ–è·¯å¾„éªŒè¯ï¼Œåªæ£€æŸ¥æ˜¯å¦ä¸ºç©º
            // æ–‡ä»¶ç®¡ç†å™¨é€‰æ‹©çš„è·¯å¾„é€šå¸¸å·²ç»æ˜¯æœ‰æ•ˆçš„
            // å¯ä»¥ç§»é™¤ä¸¥æ ¼çš„æ ¼å¼éªŒè¯ï¼Œè®©åç«¯APIå¤„ç†å®é™…çš„è·¯å¾„éªŒè¯
            
            // æ˜¾ç¤ºåŠ è½½ä¸­æ¶ˆæ¯
            showMessage('æ­£åœ¨æ‰«ææœ¬åœ°ç‰©å“...', 'info');
            
            // è°ƒç”¨APIæ‰«ææœ¬åœ°æ–‡ä»¶å¤¹ä¸­çš„ç‰©å“
            fetch('/api/steam/workshop/local-items/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ folder_path: folderPath })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯ï¼ŒçŠ¶æ€ç : ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // è·å–æœ¬åœ°ç‰©å“åˆ—è¡¨å’Œåˆ›æ„å·¥åŠå·²å‘å¸ƒç‰©å“ä¿¡æ¯
                    const localItems = data.local_items || [];
                    const publishedItems = data.published_items || [];
                    
                    // æ›´æ–°UIæ˜¾ç¤ºæœ¬åœ°ç‰©å“
                    displayLocalItems(localItems, publishedItems);
                    
                    showMessage(`æˆåŠŸæ‰«æåˆ° ${localItems.length} ä¸ªæœ¬åœ°ç‰©å“`, 'success');
                } else {
                    showMessage(`æ‰«æå¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            })
            .catch(error => {
                console.error('æ‰«ææœ¬åœ°ç‰©å“å¤±è´¥:', error);
                showMessage(`æ‰«æè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
            });
        }
        
        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            async function doesFileExist(filePath) {
                try {
                    const response = await fetch(`/api/file-exists?path=${encodeURIComponent(filePath)}`);
                    const result = await response.json();
                    return result.exists;
                } catch (error) {
                    // å¦‚æœAPIä¸å¯ç”¨ï¼Œè¿”å›false
                    return false;
                }
            }
            
            // æŸ¥æ‰¾é¢„è§ˆå›¾ç‰‡
            async function findPreviewImage(folderPath) {
                try {
                    // å°è¯•æŸ¥æ‰¾å¸¸è§çš„é¢„è§ˆå›¾ç‰‡æ–‡ä»¶
                    const commonImageNames = ['preview.jpg', 'preview.png', 'thumbnail.jpg', 'thumbnail.png', 'icon.jpg', 'icon.png', 'header.jpg', 'header.png'];
                    
                    for (const imageName of commonImageNames) {
                        const imagePath = `${folderPath}/${imageName}`;
                        if (await doesFileExist(imagePath)) {
                            return imagePath;
                        }
                    }
                    
                    // å¦‚æœæ‰¾ä¸åˆ°å¸¸è§é¢„è§ˆå›¾ï¼Œå°è¯•ä½¿ç”¨APIè·å–æ–‡ä»¶å¤¹ä¸­çš„ç¬¬ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶
                    const response = await fetch(`/api/find-first-image?folder=${encodeURIComponent(folderPath)}`);
                    const result = await response.json();
                    
                    if (result.success && result.imagePath) {
                        return result.imagePath;
                    }
                } catch (error) {
                    console.error('æŸ¥æ‰¾é¢„è§ˆå›¾ç‰‡å¤±è´¥:', error);
                }
                
                return null;
            }
            
            // åˆ›æ„å·¥åŠç‰©å“å¯¹æ¯”
            async function compareLocalWithWorkshop(localItem) {
                try {
                    // è·å–å·²å‘å¸ƒçš„åˆ›æ„å·¥åŠç‰©å“
                    const workshopItems = await getWorkshopItems();
                    
                    // æ¯”è¾ƒåç§°
                    for (const workshopItem of workshopItems) {
                        if (areNamesSimilar(localItem.name, workshopItem.title)) {
                            return {
                                exists: true,
                                item: workshopItem,
                                reason: 'åç§°ç›¸ä¼¼'
                            };
                        }
                    }
                } catch (error) {
                    console.error('åˆ›æ„å·¥åŠå¯¹æ¯”å¤±è´¥:', error);
                }
                
                return { exists: false };
            }
            
            // æ£€æŸ¥åç§°æ˜¯å¦ç›¸ä¼¼
            function areNamesSimilar(name1, name2) {
                // ç®€å•çš„ç›¸ä¼¼åº¦æ£€æŸ¥ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ”¹è¿›
                name1 = name1.toLowerCase().trim();
                name2 = name2.toLowerCase().trim();
                
                // å¦‚æœå®Œå…¨ç›¸åŒï¼Œç›´æ¥è¿”å›true
                if (name1 === name2) return true;
                
                // å¦‚æœä¸€ä¸ªåç§°åŒ…å«å¦ä¸€ä¸ªåç§°
                if (name1.includes(name2) || name2.includes(name1)) return true;
                
                // è®¡ç®—ç¼–è¾‘è·ç¦»ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
                if (Math.abs(name1.length - name2.length) > 3) return false;
                
                return false;
            }
            
            // è·å–åˆ›æ„å·¥åŠç‰©å“åˆ—è¡¨
            async function getWorkshopItems() {
                try {
                    const response = await fetch('/api/steam/workshop/subscribed-items');
                    const data = await response.json();
                    if (data.success) {
                        return data.items;
                    }
                } catch (error) {
                    console.error('è·å–åˆ›æ„å·¥åŠç‰©å“å¤±è´¥:', error);
                }
                return [];
            }
            
            // æ˜¾ç¤ºæœ¬åœ°ç‰©å“å¡ç‰‡
            function displayLocalItems(localItems, publishedItems) {
            const itemsList = document.getElementById('local-items-list');
            
            if (localItems.length === 0) {
                itemsList.innerHTML = `
                    <div class="empty-state">
                        <p>åœ¨æŒ‡å®šæ–‡ä»¶å¤¹ä¸­æœªæ‰¾åˆ°ä»»ä½•åˆ›æ„å·¥åŠç‰©å“</p>
                        <button class="button" onclick="scanLocalItems()">é‡æ–°æ‰«æ</button>
                    </div>
                `;
                return;
            }
            
            // åˆ›å»ºç‰©å“å¡ç‰‡HTML
            itemsList.innerHTML = localItems.map(item => {
                // æ£€æŸ¥è¯¥ç‰©å“æ˜¯å¦å·²å‘å¸ƒåˆ°åˆ›æ„å·¥åŠ
                const isPublished = publishedItems.some(published => 
                    published.localId === item.id || 
                    (published.title && item.name && 
                     published.title.toLowerCase() === item.name.toLowerCase())
                );
                
                // ç¡®å®šçŠ¶æ€ç±»å’Œæ–‡æœ¬
                let statusClass = 'status-error';
                let statusText = 'æœªå‘å¸ƒ';
                
                if (isPublished) {
                    statusClass = 'status-published';
                    statusText = 'å·²å‘å¸ƒ';
                }
                
                // ç”Ÿæˆé¢„è§ˆå›¾ç‰‡URLæˆ–ä½¿ç”¨é»˜è®¤å›¾ç‰‡
                const previewUrl = item.previewImage ? item.previewImage : '../static/icons/Steam_icon_logo.png';
                
                // ç”Ÿæˆå¡ç‰‡HTML
                return `
                    <div class="workshop-card">
                        <img src="${previewUrl}" alt="${item.name || 'æœ¬åœ°ç‰©å“'}" class="card-image">
                        <div class="card-content">
                            <h3 class="card-title">${item.name || 'æœªå‘½åç‰©å“'}</h3>
                            <div class="status-badge ${statusClass}">${statusText}</div>
                            <div class="card-info">è·¯å¾„: ${item.path}</div>
                            <div class="card-info">ä¿®æ”¹æ—¥æœŸ: ${formatDate(item.lastModified)}</div>
                            <div class="card-info">å¤§å°: ${formatFileSize(item.size)}</div>
                            
                            ${!isPublished ? `
                                <div class="card-actions">
                                    <button class="button" onclick="prepareItemForUpload('${item.id}')">å‡†å¤‡ä¸Šä¼ </button>
                                    <button class="button button-primary" onclick="quickUploadItem('${item.id}')">å¿«é€Ÿä¸Šä¼ </button>
                                </div>
                            ` : `
                                <div class="card-actions">
                                    <button class="button button-disabled" disabled>å·²å‘å¸ƒ</button>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // å‡†å¤‡ç‰©å“ä¸Šä¼ 
        function prepareItemForUpload(itemId) {
            // è°ƒç”¨APIè·å–ç‰©å“è¯¦æƒ…
            fetch(`/api/steam/workshop/local-items/${itemId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯ï¼ŒçŠ¶æ€ç : ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const item = data.item;
                        
                        // å¡«å……ä¸Šä¼ è¡¨å•
                        document.getElementById('item-title').value = item.name || '';
                        document.getElementById('content-folder').value = item.path || '';
                        
                        // å¦‚æœæœ‰é¢„è§ˆå›¾ç‰‡ï¼Œå¡«å……é¢„è§ˆå›¾ç‰‡è·¯å¾„
                        if (item.previewImage) {
                            document.getElementById('preview-image').value = item.previewImage;
                        }
                        
                        // åˆ‡æ¢åˆ°ä¸Šä¼ åŒºåŸŸ
                        toggleUploadSection();
                        
                        showMessage('å·²å°†æœ¬åœ°ç‰©å“ä¿¡æ¯åŠ è½½åˆ°ä¸Šä¼ è¡¨å•', 'success');
                    } else {
                        showMessage(`è·å–ç‰©å“è¯¦æƒ…å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('å‡†å¤‡ä¸Šä¼ å¤±è´¥:', error);
                    showMessage(`å‡†å¤‡ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
                });
        }
        
        // å¿«é€Ÿä¸Šä¼ ç‰©å“
        async function quickUploadItem(itemId) {
            try {
                // æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
                const button = event.target;
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> ä¸Šä¼ ä¸­...';
                }
                
                // è°ƒç”¨APIè·å–ç‰©å“è¯¦æƒ…
                const itemResponse = await fetch(`/api/steam/workshop/local-items/${itemId}`);
                if (!itemResponse.ok) {
                    throw new Error(`HTTPé”™è¯¯ï¼ŒçŠ¶æ€ç : ${itemResponse.status}`);
                }
                
                const itemData = await itemResponse.json();
                if (!itemData.success) {
                    throw new Error(`è·å–ç‰©å“è¯¦æƒ…å¤±è´¥: ${itemData.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
                
                const item = itemData.item;
                
                // æ£€æŸ¥é¢„è§ˆå›¾ç‰‡æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å°è¯•æŸ¥æ‰¾
                let previewImage = item.previewImage;
                if (!previewImage || !await doesFileExist(previewImage)) {
                    previewImage = await findPreviewImage(item.path);
                    if (!previewImage) {
                        showMessage('æœªæ‰¾åˆ°é¢„è§ˆå›¾ç‰‡ï¼Œå°†å°è¯•ä½¿ç”¨åˆ›æ„å·¥åŠé»˜è®¤å›¾ç‰‡æœºåˆ¶', 'warning');
                    }
                }
                
                // æ„å»ºå¿«é€Ÿä¸Šä¼ æ•°æ®
                const uploadData = {
                    title: item.name || 'æœªå‘½åç‰©å“',
                    description: `é€šè¿‡N.E.K.Oå¿«é€Ÿä¸Šä¼ äº ${formatDate(new Date())}`,
                    content_folder: item.path,
                    preview_image: previewImage || '',
                    visibility: 0, // é»˜è®¤å…¬å¼€
                    tags: item.tags || ['æ¨¡ç»„'],
                    allow_comments: true
                };
                
                // å‘é€APIè¯·æ±‚
                const publishResponse = await fetch('/api/steam/workshop/publish', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(uploadData)
                });
                
                if (!publishResponse.ok) {
                    throw new Error(`HTTPé”™è¯¯ï¼ŒçŠ¶æ€ç : ${publishResponse.status}`);
                }
                
                const publishData = await publishResponse.json();
                if (publishData.success) {
                    showMessage(`ğŸ‰ å¿«é€Ÿä¸Šä¼ æˆåŠŸï¼ç‰©å“ID: ${publishData.published_file_id}`, 'success');
                    
                    // æ›´æ–°æœ¬åœ°æ•°æ®ç¼“å­˜
                    if (item.publishDate) {
                        item.publishDate = new Date();
                    }
                    item.publishedFileId = publishData.published_file_id;
                    
                    // é‡æ–°æ‰«æä»¥æ›´æ–°çŠ¶æ€
                    setTimeout(() => {
                        scanLocalItems();
                    }, 1000);
                } else {
                    throw new Error(`å‘å¸ƒå¤±è´¥: ${publishData.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                showMessage(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<i class="fa fa-rocket"></i> å¿«é€Ÿä¸Šä¼ ';
                }
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(timestamp) {
            if (!timestamp) return 'æœªçŸ¥';
            
            const date = new Date(timestamp);
            return date.toLocaleDateString();
        }
        
        // æ–‡ä»¶è·¯å¾„é€‰æ‹©è¾…åŠ©åŠŸèƒ½
        function validatePathInput(elementId) {
            const element = document.getElementById(elementId);
            element.addEventListener('blur', function() {
                const path = this.value.trim();
                if (path && path.includes('\\\\')) {
                    // å°†åŒåæ–œæ æ›¿æ¢ä¸ºå•åæ–œæ ï¼ŒWindowsè·¯å¾„æ ¼å¼
                    this.value = path.replace(/\\\\/g, '\\');
                }
            });
        }
        
        // ä¸ºè·¯å¾„è¾“å…¥æ¡†æ·»åŠ éªŒè¯
        validatePathInput('content-folder');
        validatePathInput('preview-image');
        
        // æ ‡ç­¾ç®¡ç†åŠŸèƒ½
        const tagInput = document.getElementById('item-tags');
        const tagsContainer = document.getElementById('tags-container');
        
        tagInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && tagInput.value.trim() !== '') {
                e.preventDefault();
                addTag(tagInput.value.trim());
                tagInput.value = '';
            }
        });
        
        function addTag(tagText) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ ‡ç­¾
            const existingTags = Array.from(tagsContainer.querySelectorAll('.tag')).map(tag => 
                tag.textContent.replace('Ã—', '').trim()
            );
            
            if (existingTags.includes(tagText)) {
                showMessage('æ ‡ç­¾å·²å­˜åœ¨', 'error');
                return;
            }
            
            const tagElement = document.createElement('div');
            tagElement.className = 'tag';
            tagElement.innerHTML = `${tagText}<span class="tag-remove" onclick="removeTag(this)">Ã—</span>`;
            tagsContainer.appendChild(tagElement);
        }
        
        function removeTag(tagElement) {
            tagElement.parentElement.remove();
        }
        
        // æ¶ˆæ¯æ˜¾ç¤ºåŠŸèƒ½ - å¢å¼ºç‰ˆ
        function showMessage(message, type = 'info', duration = 3000) {
            const messageArea = document.getElementById('message-area') || createMessageArea();
            const messageElement = document.createElement('div');
            
            // åˆ›å»ºæ¶ˆæ¯å®¹å™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            function createMessageArea() {
                const container = document.createElement('div');
                container.id = 'message-area';
                container.className = 'message-area';
                document.body.appendChild(container);
                return container;
            }
            
            // æ¶ˆæ¯ç±»å‹å’Œå›¾æ ‡æ˜ å°„
            const typeConfig = {
                error: { className: 'error-message', icon: 'fa-exclamation-circle' },
                warning: { className: 'warning-message', icon: 'fa-exclamation-triangle' },
                success: { className: 'success-message', icon: 'fa-check-circle' },
                info: { className: 'info-message', icon: 'fa-info-circle' }
            };
            
            // è·å–å½“å‰æ¶ˆæ¯ç±»å‹çš„é…ç½®
            const config = typeConfig[type] || typeConfig.info;
            
            // è®¾ç½®æ ·å¼ç±»
            messageElement.className = config.className;
            
            // è®¾ç½®æ¶ˆæ¯å†…å®¹ï¼Œæ·»åŠ å›¾æ ‡å’ŒHTMLè½¬ä¹‰
            messageElement.innerHTML = `
                <i class="fa ${config.icon}" style="margin-right: 8px;"></i>
                <span>${escapeHtml(message)}</span>
            `;
            
            // æ·»åŠ å…³é—­æŒ‰é’®
            const closeButton = document.createElement('span');
            closeButton.className = 'message-close';
            closeButton.innerHTML = '<i class="fa fa-times"></i>';
            closeButton.onclick = () => messageElement.remove();
            messageElement.appendChild(closeButton);
            
            // ä¸ºé”™è¯¯æ¶ˆæ¯æ·»åŠ è¯¦ç»†ä¿¡æ¯æ”¯æŒ
            if (type === 'error' && typeof message === 'object') {
                messageElement.title = JSON.stringify(message, null, 2);
            }
            
            // æ·»åŠ æ¶ˆæ¯
            messageArea.appendChild(messageElement);
            
            // è®¾ç½®åˆå§‹æ ·å¼
            messageElement.style.opacity = '0';
            messageElement.style.transform = 'translateY(-10px)';
            messageElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            messageElement.style.display = 'flex';
            messageElement.style.alignItems = 'center';
            messageElement.style.padding = '10px 15px';
            messageElement.style.marginBottom = '10px';
            messageElement.style.borderRadius = '4px';
            messageElement.style.position = 'relative';
            messageElement.style.zIndex = '1000';
            
            // ä¸ºä¸åŒç±»å‹è®¾ç½®èƒŒæ™¯è‰²
            const bgColors = {
                error: '#ffebee',
                warning: '#fff8e1',
                success: '#e8f5e9',
                info: '#e3f2fd'
            };
            messageElement.style.backgroundColor = bgColors[type] || '#f5f5f5';
            
            // è®¾ç½®æ¶ˆæ¯æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                messageElement.style.opacity = '1';
                messageElement.style.transform = 'translateY(0)';
            }, 10);
            
            // ç¡®ä¿æ¶ˆæ¯åŒºåŸŸåœ¨é¡µé¢é¡¶éƒ¨ä¸”å›ºå®š
            messageArea.style.position = 'fixed';
            messageArea.style.top = '20px';
            messageArea.style.right = '20px';
            messageArea.style.maxWidth = '400px';
            messageArea.style.zIndex = '10000';
            messageArea.style.display = 'flex';
            messageArea.style.flexDirection = 'column';
            messageArea.style.alignItems = 'flex-end';
            
            // å…³é—­æŒ‰é’®æ ·å¼
            closeButton.style.position = 'absolute';
            closeButton.style.right = '10px';
            closeButton.style.cursor = 'pointer';
            closeButton.style.fontSize = '16px';
            closeButton.style.border = 'none';
            closeButton.style.background = 'none';
            closeButton.style.padding = '2px 5px';
            closeButton.style.borderRadius = '3px';
            closeButton.onmouseover = function() { this.style.backgroundColor = 'rgba(0,0,0,0.1);' };
            closeButton.onmouseout = function() { this.style.backgroundColor = 'transparent;' };
            
            // è‡ªåŠ¨æ¸…é™¤æ¶ˆæ¯ï¼ˆå¦‚æœæŒ‡å®šäº†æŒç»­æ—¶é—´ï¼‰
            if (duration > 0) {
                setTimeout(() => {
                    messageElement.style.opacity = '0';
                    messageElement.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        messageElement.remove();
                    }, 300);
                }, duration);
            }
        }
        
        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            if (typeof text !== 'string') {
                return String(text);
            }
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // åŠ è½½çŠ¶æ€ç®¡ç†å™¨
        function LoadingManager() {
            const loadingCount = { value: 0 };
            
            return {
                show: function(message = 'åŠ è½½ä¸­...') {
                    loadingCount.value++;
                    if (loadingCount.value === 1) {
                        const loadingOverlay = document.createElement('div');
                        loadingOverlay.id = 'loading-overlay';
                        loadingOverlay.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(255, 255, 255, 0.8);
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            z-index: 9999;
                            backdrop-filter: blur(2px);
                        `;
                        
                        const loadingSpinner = document.createElement('div');
                        loadingSpinner.style.cssText = `
                            border: 4px solid #f3f3f3;
                            border-top: 4px solid #3498db;
                            border-radius: 50%;
                            width: 40px;
                            height: 40px;
                            animation: spin 1s linear infinite;
                            margin-bottom: 15px;
                        `;
                        
                        const loadingText = document.createElement('div');
                        loadingText.textContent = message;
                        loadingText.style.fontSize = '16px';
                        loadingText.style.color = '#333';
                        
                        // æ·»åŠ CSSåŠ¨ç”»
                        const style = document.createElement('style');
                        style.textContent = `
                            @keyframes spin {
                                0% { transform: rotate(0deg); }
                                100% { transform: rotate(360deg); }
                            }
                        `;
                        
                        loadingOverlay.appendChild(loadingSpinner);
                        loadingOverlay.appendChild(loadingText);
                        document.body.appendChild(loadingOverlay);
                        document.body.appendChild(style);
                    }
                },
                
                hide: function() {
                    loadingCount.value--;
                    if (loadingCount.value <= 0) {
                        loadingCount.value = 0;
                        const overlay = document.getElementById('loading-overlay');
                        if (overlay) {
                            overlay.remove();
                        }
                    }
                }
            };
        }
        
        // åˆ›å»ºå…¨å±€åŠ è½½ç®¡ç†å™¨å®ä¾‹
        const loading = new LoadingManager();
        
        // è¡¨å•éªŒè¯å‡½æ•°
        function validateForm() {
            let isValid = true;
            const errorMessages = [];
            
            // éªŒè¯æ ‡é¢˜
            const title = document.getElementById('item-title').value.trim();
            if (!title) {
                errorMessages.push('è¯·è¾“å…¥æ ‡é¢˜');
                document.getElementById('item-title').classList.add('error');
                isValid = false;
            } else {
                document.getElementById('item-title').classList.remove('error');
            }
            
            // éªŒè¯å†…å®¹æ–‡ä»¶å¤¹
            const contentFolder = document.getElementById('content-folder').value.trim();
            if (!contentFolder) {
                errorMessages.push('è¯·è¾“å…¥å†…å®¹æ–‡ä»¶å¤¹è·¯å¾„');
                document.getElementById('content-folder').classList.add('error');
                isValid = false;
            } else {
                // ç®€å•çš„è·¯å¾„æ ¼å¼éªŒè¯
                if (!contentFolder.match(/^[a-zA-Z]:\\/)) {
                    errorMessages.push('å†…å®¹æ–‡ä»¶å¤¹è·¯å¾„æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºD:\\\Projects\\\\MyModæ ¼å¼');
                    document.getElementById('content-folder').classList.add('error');
                    isValid = false;
                } else {
                    document.getElementById('content-folder').classList.remove('error');
                }
            }
            
            // éªŒè¯é¢„è§ˆå›¾ç‰‡
            const previewImage = document.getElementById('preview-image').value.trim();
            if (!previewImage) {
                errorMessages.push('è¯·è¾“å…¥é¢„è§ˆå›¾ç‰‡è·¯å¾„');
                document.getElementById('preview-image').classList.add('error');
                isValid = false;
            } else {
                // éªŒè¯å›¾ç‰‡æ ¼å¼
                const imageExtRegex = /\.(jpg|jpeg|png)$/i;
                if (!imageExtRegex.test(previewImage)) {
                    errorMessages.push('é¢„è§ˆå›¾ç‰‡å¿…é¡»æ˜¯.jpgæˆ–.pngæ ¼å¼');
                    document.getElementById('preview-image').classList.add('error');
                    isValid = false;
                } else {
                    document.getElementById('preview-image').classList.remove('error');
                }
            }
            
            // æ˜¾ç¤ºéªŒè¯é”™è¯¯æ¶ˆæ¯
            if (errorMessages.length > 0) {
                showMessage(errorMessages.join('\n'), 'error', 5000);
            }
            
            return isValid;
        }
        
        // ç¦ç”¨/å¯ç”¨æŒ‰é’®å‡½æ•°
        function setButtonState(buttonElement, isDisabled) {
            if (buttonElement) {
                buttonElement.disabled = isDisabled;
                if (isDisabled) {
                    buttonElement.classList.add('button-disabled');
                } else {
                    buttonElement.classList.remove('button-disabled');
                }
            }
        }
        
        // ä¸Šä¼ ç‰©å“åŠŸèƒ½
        function uploadItem() {
            // æ£€æŸ¥æ˜¯å¦å·²ä»æœ¬åœ°ç‰©å“ä¸­é€‰æ‹©å†…å®¹
            const contentFolder = document.getElementById('content-folder').value.trim();
            const previewImage = document.getElementById('preview-image').value.trim();
            
            if (!contentFolder) {
                showMessage('è¯·å…ˆåœ¨"ç®¡ç†æœ¬åœ°ç‰©å“"ä¸­é€‰æ‹©è¦ä¸Šä¼ çš„ç‰©å“', 'error');
                return;
            }
            
            if (!previewImage) {
                showMessage('é¢„è§ˆå›¾ç‰‡è·¯å¾„ä¸èƒ½ä¸ºç©ºï¼Œè¯·ç¡®ä¿æ‚¨é€‰æ‹©çš„æœ¬åœ°ç‰©å“åŒ…å«é¢„è§ˆå›¾ç‰‡', 'error');
                return;
            }
            
            // éªŒè¯è¡¨å•
            if (!validateForm()) {
                return;
            }
            
            // æ”¶é›†è¡¨å•æ•°æ®
            const title = document.getElementById('item-title').value.trim();
            const description = document.getElementById('item-description').value.trim();
            // å†…å®¹æ–‡ä»¶å¤¹å’Œé¢„è§ˆå›¾ç‰‡è·¯å¾„å·²ç»åœ¨ä¸Šé¢å®šä¹‰è¿‡äº†ï¼Œä¸å†é‡å¤å®šä¹‰
            const visibilitySelect = document.getElementById('visibility');
            const allowComments = document.getElementById('allow-comments').checked;
            
            // æ”¶é›†æ ‡ç­¾
            const tags = Array.from(document.querySelectorAll('#tags-container .tag')).map(tag => 
                tag.textContent.replace('Ã—', '').trim()
            );
            
            // è½¬æ¢å¯è§æ€§é€‰é¡¹ä¸ºæ•°å€¼
            let visibility = 0; // é»˜è®¤å…¬å¼€
            if (visibilitySelect.value === 'friends') {
                visibility = 1;
            } else if (visibilitySelect.value === 'private') {
                visibility = 2;
            }
            
            // å‡†å¤‡ä¸Šä¼ æ•°æ®
            const uploadData = {
                title: title,
                description: description,
                content_folder: contentFolder,
                preview_image: previewImage,
                visibility: visibility,
                tags: tags,
                allow_comments: allowComments
            };
            
            // è·å–ä¸Šä¼ æŒ‰é’®å¹¶ç¦ç”¨
            const uploadButton = document.querySelector('.upload-section button.button');
            const originalText = uploadButton.textContent;
            uploadButton.textContent = 'ä¸Šä¼ ä¸­...';
            setButtonState(uploadButton, true);
            
            // æ˜¾ç¤ºä¸Šä¼ ä¸­æ¶ˆæ¯
            showMessage('æ­£åœ¨å‡†å¤‡ä¸Šä¼ ...', 'success', 0); // 0è¡¨ç¤ºä¸è‡ªåŠ¨å…³é—­
            
            // å‘é€APIè¯·æ±‚
            fetch('/api/steam/workshop/publish', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(uploadData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯ï¼ŒçŠ¶æ€ç : ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                uploadButton.textContent = originalText;
                setButtonState(uploadButton, false);
                
                if (data.success) {
                    showMessage('ğŸ‰ ä¸Šä¼ æˆåŠŸï¼å†…å®¹å·²æäº¤åˆ°åˆ›æ„å·¥åŠ', 'success', 5000);
                    
                    // æ˜¾ç¤ºç‰©å“ID
                    if (data.published_file_id) {
                        showMessage(`ğŸ“¦ ç‰©å“ID: ${data.published_file_id}`, 'success', 5000);
                    }
                    
                    // å¦‚æœéœ€è¦æ¥å—åè®®
                    if (data.needs_to_accept_agreement) {
                        showMessage('â„¹ï¸ éœ€è¦æ¥å—åˆ›æ„å·¥åŠåè®®ï¼Œè¯·åœ¨Steamå®¢æˆ·ç«¯ä¸­å®Œæˆ', 'warning', 8000);
                    }
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('item-title').value = '';
                    document.getElementById('item-description').value = '';
                    document.getElementById('content-folder').value = '';
                    document.getElementById('preview-image').value = '';
                    document.getElementById('visibility').value = 'public';
                    document.getElementById('allow-comments').checked = true;
                    
                    // æ¸…ç©ºæ ‡ç­¾
                    const tagsContainer = document.getElementById('tags-container');
                    tagsContainer.innerHTML = '';
                    
                    // æ·»åŠ é»˜è®¤æ ‡ç­¾
                    addTag('æ¨¡ç»„');
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤ºå’Œæ“ä½œé€‰é¡¹
                    setTimeout(() => {
                        const messageArea = document.getElementById('message-area');
                        const actionMessage = document.createElement('div');
                        actionMessage.className = 'success-message';
                        actionMessage.innerHTML = `
                            <span>æ“ä½œå·²å®Œæˆï¼Œæ‚¨å¯ä»¥ï¼š</span>
                            <button class="button button-sm" onclick="document.getElementById('item-title').focus()">ç»§ç»­ä¸Šä¼ </button>
                            <button class="button button-sm" onclick="toggleUploadSection()">éšè—ä¸Šä¼ åŒº</button>
                            <span class="message-close" onclick="this.parentElement.remove()">Ã—</span>
                        `;
                        messageArea.appendChild(actionMessage);
                    }, 1000);
                } else {
                    showMessage(`âŒ ä¸Šä¼ å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error', 8000);
                    if (data.message) {
                        showMessage(`âš ï¸ ${data.message}`, 'warning', 8000);
                    }
                    
                    // æä¾›é‡è¯•å»ºè®®
                    setTimeout(() => {
                        const retryButton = document.createElement('button');
                        retryButton.className = 'button button-sm';
                        retryButton.textContent = 'é‡è¯•ä¸Šä¼ ';
                        retryButton.onclick = uploadItem;
                        
                        const messageArea = document.getElementById('message-area');
                        const retryMessage = document.createElement('div');
                        retryMessage.className = 'error-message';
                        retryMessage.innerHTML = `<span>æ˜¯å¦é‡è¯•ä¸Šä¼ ï¼Ÿ</span>
                            <button class="button button-sm" onclick="uploadItem()">é‡è¯•</button>
                            <span class="message-close" onclick="this.parentElement.remove()">Ã—</span>`;
                        messageArea.appendChild(retryMessage);
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                uploadButton.textContent = originalText;
                setButtonState(uploadButton, false);
                
                let errorMessage = 'ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯';
                
                // æ ¹æ®é”™è¯¯ç±»å‹æä¾›æ›´å…·ä½“çš„æç¤º
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage += 'ï¼Œå¯èƒ½æ˜¯ç½‘ç»œè¿æ¥é—®é¢˜æˆ–æœåŠ¡å™¨æœªå¯åŠ¨';
                    showMessage(`âŒ ${errorMessage}`, 'error', 8000);
                    showMessage('âš ï¸ è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒæœåŠ¡å™¨çŠ¶æ€', 'warning', 8000);
                } else if (error.message.includes('HTTPé”™è¯¯')) {
                    errorMessage += `ï¼š${error.message}`;
                    showMessage(`âŒ ${errorMessage}`, 'error', 8000);
                    showMessage('âš ï¸ æœåŠ¡å™¨å¯èƒ½é‡åˆ°é—®é¢˜ï¼Œè¯·ç¨åå†è¯•', 'warning', 8000);
                } else {
                    showMessage(`âŒ ${errorMessage}ï¼š${error.message}`, 'error', 8000);
                }
            });
        }
        
        // åŠ è½½è®¢é˜…ç‰©å“
        function loadSubscriptions() {
            const subscriptionsList = document.getElementById('subscriptions-list');
            subscriptionsList.innerHTML = '<div class="empty-state"><p>æ­£åœ¨åŠ è½½æ‚¨çš„è®¢é˜…ç‰©å“...</p></div>';
            
            // è°ƒç”¨åç«¯APIè·å–è®¢é˜…ç‰©å“åˆ—è¡¨
            fetch('/api/steam/workshop/subscribed-items')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.success) {
                        subscriptionsList.innerHTML = `<div class="empty-state"><p>è·å–è®¢é˜…ç‰©å“å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</p></div>`;
                        // å¦‚æœæœ‰æ¶ˆæ¯æç¤ºï¼Œæ˜¾ç¤ºç»™ç”¨æˆ·
                        if (data.message) {
                            showMessage(data.message, 'error');
                        }
                        return;
                    }
                    
                    if (data.items.length === 0) {
                        subscriptionsList.innerHTML = '<div class="empty-state"><p>æ‚¨è¿˜æ²¡æœ‰è®¢é˜…ä»»ä½•åˆ›æ„å·¥åŠç‰©å“</p></div>';
                    } else {
                        // ç”Ÿæˆå¡ç‰‡HTML
                        subscriptionsList.innerHTML = data.items.map(item => {
                            // æ ¼å¼åŒ–ç‰©å“æ•°æ®ä¸ºå‰ç«¯æ‰€éœ€æ ¼å¼
                            const formattedItem = {
                                id: item.publishedFileId.toString(),
                                name: item.title,
                                author: item.steamIDOwner.toString(), // æš‚æ—¶ä½¿ç”¨SteamIDä½œä¸ºä½œè€…å
                                subscribedDate: new Date(item.timeAdded * 1000).toLocaleDateString(),
                                lastUpdated: new Date(item.timeUpdated * 1000).toLocaleDateString(),
                                size: formatFileSize(item.fileSize),
                                previewUrl: item.previewImageUrl || '../static/icons/Steam_icon_logo.png',
                                state: item.state
                            };
                            
                            // ç¡®å®šçŠ¶æ€ç±»å’Œæ–‡æœ¬
                            let statusClass = 'status-subscribed';
                            let statusText = 'å·²è®¢é˜…';
                            
                            if (formattedItem.state.downloading) {
                                statusClass = 'status-downloading';
                                statusText = 'ä¸‹è½½ä¸­';
                            } else if (formattedItem.state.needsUpdate) {
                                statusClass = 'status-needs-update';
                                statusText = 'éœ€è¦æ›´æ–°';
                            } else if (formattedItem.state.installed) {
                                statusClass = 'status-installed';
                                statusText = 'å·²å®‰è£…';
                            }
                             
                            return `
                                <div class="workshop-card">
                                    <img src="${formattedItem.previewUrl}" alt="${formattedItem.name}" class="card-image">
                                    <div class="card-content">
                                        <h3 class="card-title">${formattedItem.name}</h3>
                                        <div class="status-badge ${statusClass}">${statusText}</div>
                                        <div class="author-info">
                                                <div class="author-avatar">${formattedItem.author.substring(0, 2).toUpperCase()}</div>
                                                <span>ä½œè€…: ${formattedItem.author}</span>
                                            </div>
                                        <div class="card-info">è®¢é˜…æ—¥æœŸ: ${formattedItem.subscribedDate}</div>
                                        <div class="card-info">ä¸Šæ¬¡æ›´æ–°: ${formattedItem.lastUpdated}</div>
                                        <div class="card-info">å¤§å°: ${formattedItem.size}</div>
                                        ${formattedItem.state.downloading && item.downloadProgress ? 
                                            `<div class="download-progress">
                                                <div class="progress-bar">
                                                    <div class="progress-fill" style="width: ${item.downloadProgress.percentage}%">
                                                        ${item.downloadProgress.percentage.toFixed(1)}%
                                                    </div>
                                                </div>
                                            </div>` : ''
                                        }
                                        <div class="card-actions">
                                            <button class="button" onclick="viewItemDetails('${formattedItem.id}')">è¯¦æƒ…</button>
                                            <button class="button button-danger" onclick="unsubscribeItem('${formattedItem.id}', '${formattedItem.name}')">å–æ¶ˆè®¢é˜…</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                })
                .catch(error => {
                    console.error('è·å–è®¢é˜…ç‰©å“å¤±è´¥:', error);
                    subscriptionsList.innerHTML = `<div class="empty-state"><p>è·å–è®¢é˜…ç‰©å“å¤±è´¥: ${error.message}</p></div>`;
                    showMessage('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                });
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0 || bytes === undefined) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(state) {
            if (state.downloading) {
                return 'ä¸‹è½½ä¸­';
            } else if (state.needsUpdate) {
                return 'éœ€è¦æ›´æ–°';
            } else if (state.installed) {
                return 'å·²å®‰è£…';
            } else if (state.subscribed) {
                return 'å·²è®¢é˜…';
            } else {
                return 'æœªçŸ¥';
            }
        }
        
        // æ‰“å¼€æ¨¡æ€æ¡†
        function openModal() {
            const modal = document.getElementById('itemDetailsModal');
            modal.style.display = 'flex';
            // é˜»æ­¢é¡µé¢æ»šåŠ¨
            document.body.style.overflow = 'hidden';
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            const modal = document.getElementById('itemDetailsModal');
            modal.style.display = 'none';
            // æ¢å¤é¡µé¢æ»šåŠ¨
            document.body.style.overflow = 'auto';
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        function closeModalOnOutsideClick(event) {
            const modal = document.getElementById('itemDetailsModal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        // è·å–ç‰©å“è¯¦ç»†ä¿¡æ¯ï¼ˆæ¨¡æ‹Ÿï¼‰
        function getItemDetails(itemId) {
            // æ¨¡æ‹Ÿä»æœåŠ¡å™¨è·å–æ•°æ®
            // å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥æ˜¯ä¸€ä¸ªAPIè°ƒç”¨æ¥è·å–çœŸå®æ•°æ®
            const sampleData = [
                {
                    id: '1',
                    name: 'ç²¾ç¾è§’è‰²æ¨¡å‹åŒ…',
                    author: 'Creator1',
                    authorUrl: '#',
                    subscribedDate: '2024-01-15',
                    lastUpdated: '2024-02-10',
                    size: '15.2 MB',
                    previewUrl: '../static/icons/character_icon.png',
                    description: 'è¿™æ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ªç²¾ç¾è§’è‰²æ¨¡å‹çš„åŒ…ï¼Œé€‚åˆå„ç±»æ¸¸æˆå’ŒåŠ¨ç”»é¡¹ç›®ä½¿ç”¨ã€‚æ‰€æœ‰æ¨¡å‹éƒ½ç»è¿‡ä¼˜åŒ–ï¼Œæ”¯æŒå„ç§å¸¸è§çš„3Då¼•æ“ã€‚æ¯ä¸ªè§’è‰²éƒ½æœ‰å®Œæ•´çš„éª¨éª¼ç³»ç»Ÿå’ŒåŸºæœ¬åŠ¨ä½œé›†ã€‚',
                    downloadCount: '1,245',
                    rating: '4.8/5',
                    tags: ['è§’è‰²', 'æ¨¡å‹', '3D', 'åŠ¨ç”»']
                },
                {
                    id: '2',
                    name: 'ç¯å¢ƒæè´¨åŒ…',
                    author: 'TextureMaster',
                    authorUrl: '#',
                    subscribedDate: '2024-01-20',
                    lastUpdated: '2024-02-05',
                    size: '24.8 MB',
                    previewUrl: '../static/icons/memory_icon.png',
                    description: 'é«˜å“è´¨ç¯å¢ƒæè´¨åŒ…ï¼ŒåŒ…å«å„ç§è‡ªç„¶å’ŒåŸå¸‚ç¯å¢ƒçš„çº¹ç†ã€‚æ‰€æœ‰æè´¨éƒ½å…·æœ‰4Kåˆ†è¾¨ç‡ï¼ŒåŒ…å«æ³•çº¿è´´å›¾ã€é«˜å…‰è´´å›¾å’Œç½®æ¢è´´å›¾ï¼Œä¸ºæ‚¨çš„é¡¹ç›®å¸¦æ¥æè‡´çš„è§†è§‰æ•ˆæœã€‚',
                    downloadCount: '3,567',
                    rating: '4.9/5',
                    tags: ['æè´¨', 'ç¯å¢ƒ', 'çº¹ç†', 'é«˜æ¸…']
                },
                {
                    id: '3',
                    name: 'å£°éŸ³æ•ˆæœåˆé›†',
                    author: 'AudioPro',
                    authorUrl: '#',
                    subscribedDate: '2024-02-01',
                    lastUpdated: '2024-02-15',
                    size: '32.1 MB',
                    previewUrl: '../static/icons/voice_clone_icon.png',
                    description: 'ä¸“ä¸šçº§å£°éŸ³æ•ˆæœåˆé›†ï¼ŒåŒ…å«è¶…è¿‡500ä¸ªé«˜å“è´¨éŸ³æ•ˆã€‚æ¶µç›–äº†è‡ªç„¶ç¯å¢ƒã€æ­¦å™¨ã€UIåé¦ˆã€è§’è‰²è¯­éŸ³ç­‰å¤šç§ç±»å‹ï¼Œå…¨éƒ¨é‡‡ç”¨æ— æŸéŸ³è´¨å½•åˆ¶ï¼Œä¸ºæ‚¨çš„æ¸¸æˆæˆ–åº”ç”¨å¢æ·»æ²‰æµ¸å¼éŸ³é¢‘ä½“éªŒã€‚',
                    downloadCount: '2,134',
                    rating: '4.7/5',
                    tags: ['éŸ³æ•ˆ', 'éŸ³é¢‘', 'å£°éŸ³', 'æ¸¸æˆ']
                },
                {
                    id: '4',
                    name: 'åŠ¨æ€èƒŒæ™¯ç‰¹æ•ˆ',
                    author: 'VisualArtist',
                    authorUrl: '#',
                    subscribedDate: '2024-02-20',
                    lastUpdated: '2024-03-01',
                    size: '45.6 MB',
                    previewUrl: '../static/icons/live2d_settings_icon.png',
                    description: 'ç‚«é…·çš„åŠ¨æ€èƒŒæ™¯ç‰¹æ•ˆé›†åˆï¼ŒåŒ…å«ç²’å­æ•ˆæœã€æµä½“åŠ¨ç”»ã€å…‰æ•ˆç­‰å¤šç§ç±»å‹ã€‚æ‰€æœ‰ç‰¹æ•ˆéƒ½é’ˆå¯¹æ€§èƒ½è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¯ä»¥è½»æ¾é›†æˆåˆ°å„ç±»åº”ç”¨å’Œæ¸¸æˆä¸­ï¼Œä¸ºç”¨æˆ·ç•Œé¢å¢æ·»è§†è§‰å¸å¼•åŠ›ã€‚',
                    downloadCount: '1,876',
                    rating: '4.6/5',
                    tags: ['ç‰¹æ•ˆ', 'åŠ¨ç”»', 'èƒŒæ™¯', 'è§†è§‰']
                },
                {
                    id: '5',
                    name: 'AIè¯­éŸ³åŒ…',
                    author: 'VoiceCreator',
                    authorUrl: '#',
                    subscribedDate: '2024-03-05',
                    lastUpdated: '2024-03-15',
                    size: '28.3 MB',
                    previewUrl: '../static/icons/voice_clone_icon.png',
                    description: 'ç”±å…ˆè¿›AIæŠ€æœ¯ç”Ÿæˆçš„è¯­éŸ³åŒ…ï¼ŒåŒ…å«å¤šç§è§’è‰²å£°éŸ³å’Œæƒ…æ„Ÿè¡¨è¾¾ã€‚æ‰€æœ‰è¯­éŸ³éƒ½ç»è¿‡è‡ªç„¶åŒ–å¤„ç†ï¼Œæ”¯æŒå¤šç§è¯­è¨€å’Œæ–¹è¨€ï¼Œå¯ä»¥ç”¨äºæ¸¸æˆè§’è‰²é…éŸ³ã€è™šæ‹ŸåŠ©æ‰‹ã€æœ‰å£°è¯»ç‰©ç­‰å¤šç§åœºæ™¯ã€‚',
                    downloadCount: '2,789',
                    rating: '4.5/5',
                    tags: ['AI', 'è¯­éŸ³', 'é…éŸ³', 'å£°éŸ³']
                },
                {
                    id: '6',
                    name: 'Steamä¸»é¢˜çš®è‚¤',
                    author: 'Themer',
                    authorUrl: '#',
                    subscribedDate: '2024-03-10',
                    lastUpdated: '2024-03-20',
                    size: '12.7 MB',
                    previewUrl: '../static/icons/Steam_icon_logo.png',
                    description: 'ç²¾ç¾çš„Steamå®¢æˆ·ç«¯ä¸»é¢˜çš®è‚¤ï¼Œæ”¹å˜æ‚¨çš„Steamç•Œé¢å¤–è§‚ã€‚åŒ…å«å¤šç§é¢œè‰²æ–¹æ¡ˆå’Œè§†è§‰é£æ ¼ï¼Œæ‰€æœ‰å…ƒç´ éƒ½ç»è¿‡ç²¾å¿ƒè®¾è®¡ï¼Œä¿æŒSteamåŸæœ‰åŠŸèƒ½çš„åŒæ—¶æä¾›å…¨æ–°çš„è§†è§‰ä½“éªŒã€‚',
                    downloadCount: '4,321',
                    rating: '4.9/5',
                    tags: ['Steam', 'ä¸»é¢˜', 'çš®è‚¤', 'ç•Œé¢']
                }
            ];
            
            // æŸ¥æ‰¾å¯¹åº”IDçš„ç‰©å“
            return sampleData.find(item => item.id === itemId) || null;
        }
        
        // æŸ¥çœ‹ç‰©å“è¯¦æƒ…
function viewItemDetails(itemId) {
    // æ˜¾ç¤ºåŠ è½½æ¶ˆæ¯
    showMessage(`æ­£åœ¨åŠ è½½ç‰©å“ID: ${itemId} çš„è¯¦ç»†ä¿¡æ¯...`, 'success');
    
    // è°ƒç”¨åç«¯APIè·å–ç‰©å“è¯¦æƒ…
    fetch(`/api/steam/workshop/item/${itemId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                showMessage(`è·å–ç‰©å“è¯¦æƒ…å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                return;
            }
            
            const item = data.item;
            const formattedItem = {
                id: item.publishedFileId.toString(),
                name: item.title,
                author: item.steamIDOwner.toString(),
                subscribedDate: new Date(item.timeAdded * 1000).toLocaleDateString(),
                lastUpdated: new Date(item.timeUpdated * 1000).toLocaleDateString(),
                size: formatFileSize(item.fileSize),
                previewUrl: item.previewImageUrl || '../static/icons/Steam_icon_logo.png',
                description: item.description || 'æš‚æ— æè¿°',
                downloadCount: 'N/A',
                rating: 'N/A',
                tags: ['æ¨¡ç»„'] // é»˜è®¤æ ‡ç­¾ï¼Œå®é™…åº”ç”¨ä¸­åº”è¯¥ä»APIè·å–
            };
            
            // ç¡®å®šçŠ¶æ€ç±»å’Œæ–‡æœ¬
            let statusClass = 'status-subscribed';
            let statusText = getStatusText(formattedItem.state || {});
            
            if (formattedItem.state && formattedItem.state.downloading) {
                statusClass = 'status-downloading';
            } else if (formattedItem.state && formattedItem.state.needsUpdate) {
                statusClass = 'status-needs-update';
            } else if (formattedItem.state && formattedItem.state.installed) {
                statusClass = 'status-installed';
            }
            
            // è·å–ä½œè€…å¤´åƒï¼ˆä½¿ç”¨é¦–å­—æ¯ä½œä¸ºå ä½ç¬¦ï¼‰
            const authorInitial = formattedItem.author.substring(0, 2).toUpperCase();
            
            // æ›´æ–°æ¨¡æ€æ¡†å†…å®¹
            document.getElementById('modalTitle').textContent = formattedItem.name;
            
            const detailContent = document.getElementById('itemDetailContent');
            detailContent.innerHTML = `
                <img src="${formattedItem.previewUrl}" alt="${formattedItem.name}" class="item-preview-large">
                
                <div class="item-info-grid">
                    <p class="item-info-item">
                        <span class="item-info-label">ä½œè€…:</span>
                        <div class="author-info">
                            <div class="author-avatar">${authorInitial}</div>
                            <span>${formattedItem.author}</span>
                        </div>
                    </p>
                    <p class="item-info-item"><span class="item-info-label">è®¢é˜…æ—¥æœŸ:</span> ${formattedItem.subscribedDate}</p>
                    <p class="item-info-item"><span class="item-info-label">ä¸Šæ¬¡æ›´æ–°:</span> ${formattedItem.lastUpdated}</p>
                    <p class="item-info-item"><span class="item-info-label">å¤§å°:</span> ${formattedItem.size}</p>
                    <p class="item-info-item">
                        <span class="item-info-label">çŠ¶æ€:</span>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </p>
                    <p class="item-info-item"><span class="item-info-label">ä¸‹è½½æ¬¡æ•°:</span> ${formattedItem.downloadCount}</p>
                    ${formattedItem.state && formattedItem.state.downloading && item.downloadProgress ? 
                        `<p class="item-info-item" style="grid-column: span 2;">
                            <div class="download-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${item.downloadProgress.percentage}%">
                                        ${item.downloadProgress.percentage.toFixed(1)}%
                                    </div>
                                </div>
                            </div>
                        </p>` : ''
                    }
                </div>
                
                <div>
                    <h4>æ ‡ç­¾</h4>
                    <div class="tags-container">
                        ${formattedItem.tags.map(tag => `
                            <div class="tag">${tag}</div>
                        `).join('')}
                    </div>
                </div>
                
                <div>
                    <h4>æè¿°</h4>
                    <p class="item-description">${formattedItem.description}</p>
                </div>
            `;
            
            // æ‰“å¼€æ¨¡æ€æ¡†
            openModal();
        })
        .catch(error => {
            console.error('è·å–ç‰©å“è¯¦æƒ…å¤±è´¥:', error);
            showMessage('æ— æ³•åŠ è½½ç‰©å“è¯¦æƒ…ï¼Œè¯·ç¨åå†è¯•', 'error');
        });
}
        
                // å–æ¶ˆè®¢é˜…åŠŸèƒ½
        function unsubscribeItem(itemId, itemName) {
            if (confirm(`ç¡®å®šè¦å–æ¶ˆè®¢é˜… "${itemName}" å—ï¼Ÿ`)) {
                // æŸ¥æ‰¾å½“å‰å¡ç‰‡å¹¶æ·»åŠ ç§»é™¤åŠ¨ç”»æ•ˆæœ
                const cards = document.querySelectorAll('.workshop-card');
                for (let card of cards) {
                    const cardTitle = card.querySelector('.card-title').textContent;
                    if (cardTitle === itemName) {
                        // æ·»åŠ æ·¡å‡ºæ•ˆæœ
                        card.style.opacity = '0.6';
                        card.style.transform = 'scale(0.95)';
                        break;
                    }
                }
                
                // è°ƒç”¨åç«¯APIæ‰§è¡Œå–æ¶ˆè®¢é˜…æ“ä½œ
                showMessage(`æ­£åœ¨å–æ¶ˆè®¢é˜… "${itemName}"...`, 'success');
                
                fetch('/api/steam/workshop/unsubscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ item_id: itemId })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showMessage(`å·²æˆåŠŸå–æ¶ˆè®¢é˜… "${itemName}"`, 'success');
                        // é‡æ–°åŠ è½½è®¢é˜…åˆ—è¡¨
                        loadSubscriptions();
                        // å¦‚æœæ¨¡æ€æ¡†æ˜¯æ‰“å¼€çš„ï¼Œå…³é—­å®ƒ
                        closeModal();
                    } else {
                        showMessage(`å–æ¶ˆè®¢é˜…å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                        // å¦‚æœæœ‰æ¶ˆæ¯æç¤ºï¼Œæ˜¾ç¤ºç»™ç”¨æˆ·
                        if (data.message) {
                            showMessage(data.message, 'warning');
                        }
                    }
                })
                .catch(error => {
                    console.error('å–æ¶ˆè®¢é˜…å¤±è´¥:', error);
                    showMessage('å–æ¶ˆè®¢é˜…æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åå†è¯•', 'error');
                });
            }
        }
        
        // åˆå§‹åŒ–é¡µé¢
        window.onload = function() {
            // åˆå§‹åŒ–æ—¶æ·»åŠ ä¸€äº›ç¤ºä¾‹æ ‡ç­¾
            addTag('æ¨¡ç»„');
            addTag('è§’è‰²');
            
            // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½è®¢é˜…å†…å®¹
            loadSubscriptions();
        };
    </script>
</body>
</html>