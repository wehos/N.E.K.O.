<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steam创意工坊管理</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        
        /* 浏览器通知样式 */
        .browser-notice {
            display: flex;
            align-items: flex-start;
            background-color: #e8f4fd;
            border: 1px solid #b8e2ff;
            border-radius: 8px;
            padding: 16px;
            margin: 20px auto;
            max-width: 600px;
        }
        
        .notice-icon {
            font-size: 24px;
            margin-right: 12px;
            margin-top: 2px;
        }
        
        .notice-content h3 {
            margin: 0 0 8px 0;
            color: #0056b3;
            font-size: 18px;
        }
        
        .notice-content p {
            margin: 6px 0;
            color: #495057;
            line-height: 1.5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        h1 {
            color: #1b2838;
            margin-bottom: 30px;
            border-bottom: 2px solid #2a475e;
            padding-bottom: 10px;
        }
        /* 页面控制区样式 */
        .page-controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        
        /* 上传切换按钮样式 */
        .upload-toggle-button {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s, transform 0.2s;
        }
        
        .upload-toggle-button:hover {
            background-color: #229954;
            transform: translateY(-2px);
        }
        
        .upload-toggle-button:active {
            transform: translateY(0);
        }
        
        /* 上传区域容器样式 */
        .upload-section-container {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        .button {
            background-color: #2a475e;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .button:hover {
            background-color: #1b2838;
        }
        .button-danger {
            background-color: #e74c3c;
        }
        .button-danger:hover {
            background-color: #c0392b;
        }
        .upload-section {
            margin-bottom: 30px;
        }
        .file-upload {
            border: 2px dashed #ddd;
            padding: 20px;
            text-align: center;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .file-upload.dragover {
            border-color: #2a475e;
            background-color: #f0f4f8;
        }
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .tag {
            background-color: #e1e8ed;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        .tag-remove {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-published {
            background-color: #2ecc71;
        }
        .status-pending {
            background-color: #f39c12;
        }
        .status-failed {
            background-color: #e74c3c;
        }
        .filter-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .pagination button {
            margin: 0 5px;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        .success-message,
        .error-message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .success-message {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            position: relative;
            padding-right: 30px;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            position: relative;
            padding-right: 30px;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .warning-message {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            position: relative;
            padding-right: 30px;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .message-close {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            color: inherit;
            opacity: 0.7;
        }
        .message-close:hover {
            opacity: 1;
        }
        .input.error {
            border-color: #dc3545;
            background-color: #fdf2f2;
        }
        .button-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .button-sm {
            font-size: 14px;
            padding: 5px 10px;
            margin: 0 5px;
        }
        
        /* 为表单输入添加错误状态样式 */
        input.error,
        textarea.error,
        select.error {
            border-color: #dc3545;
            background-color: #fdf2f2;
        }
        
        /* 添加表单组的错误提示样式 */
        .form-group.error {
            color: #dc3545;
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* 卡片样式 */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .workshop-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
        }
        .workshop-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }
        .card-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
        }
        .card-content {
            padding: 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .card-title {
            font-size: 18px;
            font-weight: bold;
            margin: 0 0 8px 0;
            color: #1b2838;
        }
        .card-author {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }
        .card-info {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }
        /* 安装路径样式 */
        .card-path {
            max-height: 3em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .path-text {
            font-size: 11px;
            color: #666;
            word-break: break-all;
            display: inline-block;
            max-width: 100%;
            vertical-align: middle;
        }
        
        /* 物品状态样式 */
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .status-subscribed {
            background-color: #e3f2fd;
            color: #1565c0;
        }

        .status-installed {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .status-downloading {
            background-color: #fff3e0;
            color: #ef6c00;
            animation: pulse 2s infinite;
        }

        .status-needs-update {
            background-color: #fff8e1;
            color: #ff8f00;
        }

        .status-error {
            background-color: #ffebee;
            color: #c62828;
        }

        @keyframes pulse {
            0% {
                opacity: 0.7;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.7;
            }
        }
        
        /* 下载进度条样式 */
        .download-progress {
            margin: 8px 0;
            width: 100%;
        }
        
        .progress-bar {
            width: 100%;
            height: 16px;
            background-color: #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #2196f3;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7em;
            font-weight: bold;
            transition: width 0.3s ease;
        }
        
        /* 用户头像样式 */
        .author-info {
            display: flex;
            align-items: center;
            margin: 4px 0;
        }
        
        .author-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 6px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            color: #666;
        }
        .card-actions {
            margin-top: auto;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .card-actions .button {
            font-size: 14px;
            padding: 8px 12px;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .cards-container {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            }
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: modalFadeIn 0.3s ease-out;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
            background-color: #f9f9f9;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #1b2838;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #7f8c8d;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .modal-close:hover {
            background-color: #e0e0e0;
            color: #333;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
            background-color: #f9f9f9;
            gap: 10px;
        }
        
        .item-detail-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .item-preview-large {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 4px;
        }
        
        .item-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .item-info-item {
            margin: 0;
        }
        
        .item-info-label {
            font-weight: bold;
            color: #1b2838;
        }
        
        .item-description {
            margin-top: 16px;
            line-height: 1.6;
        }
        
        .info-box {
            background-color: #e1f5fe;
            border-left: 4px solid #0288d1;
            padding: 12px 16px;
            margin: 16px 0;
            border-radius: 4px;
        }
        
        .info-box p {
            margin: 0;
            color: #01579b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Steam创意工坊管理</h1>
        
        <!-- 页面控制区 -->
        <div class="page-controls">
            <button id="upload-toggle-button" class="upload-toggle-button" onclick="toggleUploadSection()">上传内容到创意工坊</button>
            <button id="local-items-toggle-button" class="upload-toggle-button" onclick="toggleLocalItemsSection()">管理本地物品</button>
        </div>
        
        <!-- 上传内容部分 -->
        <div id="upload" class="upload-section-container" style="display: none;">
            <div class="upload-section">
                <h2>上传到创意工坊</h2>
                <div class="info-box">
                    <p>请先在"管理本地物品"区域选择一个未发布的物品，然后点击"准备上传"按钮。内容文件夹路径和预览图片路径将自动填充。</p>
                </div>
                
                <div id="message-area"></div>
                
                <div class="form-group">
                    <label for="item-title">标题 *</label>
                    <input type="text" id="item-title" placeholder="输入您的创作标题">
                </div>
                
                <div class="form-group">
                    <label for="item-description">描述</label>
                    <textarea id="item-description" placeholder="详细描述您的创作内容..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="content-folder">内容文件夹路径 *</label>
                    <input type="text" id="content-folder" placeholder="从本地物品中获取的内容文件夹路径" aria-describedby="content-folder-help" readonly>
                    <small id="content-folder-help">此路径从您选择的本地物品中自动获取，不可手动修改。请先在"管理本地物品"中选择要上传的物品。</small>
                </div>
                
                <div class="form-group">
                    <label for="preview-image">预览图片路径 *</label>
                    <input type="text" id="preview-image" placeholder="从本地物品中获取的预览图片路径" aria-describedby="preview-image-help" readonly>
                    <small id="preview-image-help">此路径从您选择的本地物品中自动获取，不可手动修改。</small>
                </div>
                
                <div class="form-group">
                    <label for="item-tags">标签</label>
                    <input type="text" id="item-tags" placeholder="输入标签，按回车添加">
                    <div id="tags-container" class="tags-container"></div>
                </div>
                
                <div class="form-group">
                    <label for="visibility">可见性</label>
                    <select id="visibility">
                        <option value="public">公开</option>
                        <option value="friends">仅好友可见</option>
                        <option value="private">私有</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="allow-comments">
                        <input type="checkbox" id="allow-comments" checked>
                        允许评论
                    </label>
                </div>
                
                <button class="button" onclick="uploadItem()">上传到创意工坊</button>
            </div>
        </div>
        
        <!-- 本地物品管理部分 -->
        <div id="local-items" class="upload-section-container" style="display: none;">
            <div class="local-items-section">
                <h2>管理本地物品</h2>
                
                <div style="display: flex; justify-content: flex-start; margin-bottom: 20px;">
                    <button class="button" onclick="scanLocalItems()">扫描本地物品（使用默认路径）</button>
                </div>
                
                <!-- 默认路径配置区域 -->
                <div style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                    <h3 style="margin-top: 0; margin-bottom: 15px;">创意工坊默认路径配置</h3>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px;">默认创意工坊文件夹路径</label>
                        <input type="text" id="default-workshop-folder" placeholder="默认创意工坊文件夹路径" style="width: 100%; padding: 8px;">
                        <small style="color: #6c757d; font-size: 0.85rem; display: block; margin-top: 3px;">未指定扫描路径时将使用此默认路径</small>
                        <small style="color: #28a745; font-size: 0.85rem; display: block; margin-top: 3px;">提示：默认路径通常在 我的文档/Xiao8</small>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <input type="checkbox" id="auto-create-folder" style="margin-right: 8px;">
                        <label for="auto-create-folder">自动创建默认文件夹</label>
                        <small style="color: #6c757d; font-size: 0.85rem; display: block; margin-top: 3px; margin-left: 24px;">当默认文件夹不存在时自动创建</small>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="button button-sm" onclick="loadDefaultConfig()">加载当前配置</button>
                        <button class="button button-sm" style="background-color: #28a745; color: white;" onclick="saveDefaultConfig()">保存配置</button>
                    </div>
                </div>
                
                <div id="local-items-list" class="cards-container">
                    <div class="empty-state">
                        <p>请输入并扫描一个包含本地文件的文件夹</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 我的订阅部分 -->
        <div id="subscriptions">
            <h2>我的订阅物品</h2>
            
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="search-subscription">搜索：</label>
                    <input type="text" id="search-subscription" placeholder="搜索订阅内容...">
                </div>
                <div class="filter-group">
                    <label for="sort-subscription">排序：</label>
                    <select id="sort-subscription">
                        <option value="name_asc">名称（升序）</option>
                        <option value="name_desc">名称（降序）</option>
                        <option value="date_asc">订阅日期（升序）</option>
                        <option value="date_desc">订阅日期（降序）</option>
                    </select>
                </div>
            </div>
            
            <div id="subscriptions-result">
                <!-- 卡片容器 -->
                <div id="subscriptions-list" class="cards-container">
                    <!-- 空状态 -->
                    <div class="empty-state">
                        <p>正在加载您的订阅物品...</p>
                        <button class="button" onclick="loadSubscriptions()">重新加载</button>
                    </div>
                </div>
                <!-------------------------------------待做------------------------------------>
                <div class="pagination">
                    <button class="button" disabled>上一页</button>
                    <span>第 1 页，共 0 页</span>
                    <button class="button" disabled>下一页</button>
                </div>
            </div>
    </div>
    
    <!-- 物品详情模态框 -->
    <div id="itemDetailsModal" class="modal" onclick="closeModalOnOutsideClick(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">物品详情</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="itemDetailContent" class="item-detail-container">
                    <!-- 物品详情内容将通过JavaScript动态加载 -->
                    <div class="empty-state">
                        <p>正在加载物品详情...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button" onclick="closeModal()">关闭</button>
            </div>
        </div>
    </div>

    <script>
        // 上传区域切换功能
        function toggleUploadSection() {
            const uploadSection = document.getElementById('upload');
            const toggleButton = document.getElementById('upload-toggle-button');
            
            // 切换上传区域的显示/隐藏
            if (uploadSection.style.display === 'none') {
                uploadSection.style.display = 'block';
                toggleButton.textContent = '隐藏上传内容';
                // 平滑滚动到上传区域
                uploadSection.scrollIntoView({ behavior: 'smooth' });
            } else {
                uploadSection.style.display = 'none';
            }
        }
        
        // 本地物品区域切换功能
        // 检查文件是否存在
            /* 注释掉重复函数定义 - 保留第二个版本（第1061行开始）
            async function doesFileExist(filePath) {
                try {
                    const response = await fetch(`/api/file-exists?path=${encodeURIComponent(filePath)}`);
                    const result = await response.json();
                    return result.exists;
                } catch (error) {
                    // 如果API不可用，返回false
                    return false;
                }
            }
            
            // 查找预览图片
            async function findPreviewImage(folderPath) {
                try {
                    // 只使用指定的预览图片文件列表
                    const commonImageNames = ['preview.jpg', 'preview.png', 'thumbnail.jpg', 'thumbnail.png', 'icon.jpg', 'icon.png', 'header.jpg', 'header.png'];
                    
                    for (const imageName of commonImageNames) {
                        const imagePath = `${folderPath}/${imageName}`;
                        if (await doesFileExist(imagePath)) {
                            return imagePath;
                        }
                    }
                } catch (error) {
                    console.error('查找预览图片失败:', error);
                }
                
                return null;
            }
            
            // 格式化日期
            function formatDate(date) {
                return new Date(date).toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            // 创意工坊物品对比
            async function compareLocalWithWorkshop(localItem) {
                try {
                    // 获取已发布的创意工坊物品
                    const workshopItems = await getWorkshopItems();
                    
                    // 比较名称
                    for (const workshopItem of workshopItems) {
                        if (areNamesSimilar(localItem.name, workshopItem.title)) {
                            return {
                                exists: true,
                                item: workshopItem,
                                reason: '名称相似'
                            };
                        }
                    }
                } catch (error) {
                    console.error('创意工坊对比失败:', error);
                }
                
                return { exists: false };
            }
            
            // 检查名称是否相似
            function areNamesSimilar(name1, name2) {
                // 简单的相似度检查，可以根据需要改进
                name1 = name1.toLowerCase().trim();
                name2 = name2.toLowerCase().trim();
                
                // 如果完全相同，直接返回true
                if (name1 === name2) return true;
                
                // 如果一个名称包含另一个名称
                if (name1.includes(name2) || name2.includes(name1)) return true;
                
                // 计算编辑距离（简单版本）
                if (Math.abs(name1.length - name2.length) > 3) return false;
                
                return false;
            }
            
            // 获取创意工坊物品列表
            async function getWorkshopItems() {
                try {
                    const response = await fetch('/api/steam/workshop/subscribed-items');
                    const data = await response.json();
                    if (data.success) {
                        return data.items;
                    }
                } catch (error) {
                    console.error('获取创意工坊物品失败:', error);
                }
                return [];
            }
            
            // 格式化日期时间（完整版本）
            function formatDate(date) {
                if (!date) return '未知';
                return new Date(date).toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            */
            
            function toggleLocalItemsSection() {
            const localItemsSection = document.getElementById('local-items');
            const toggleButton = document.getElementById('local-items-toggle-button');
            
            // 切换本地物品区域的显示/隐藏
            if (localItemsSection.style.display === 'none') {
                localItemsSection.style.display = 'block';
                toggleButton.textContent = '隐藏本地物品';
                // 平滑滚动到本地物品区域
                localItemsSection.scrollIntoView({ behavior: 'smooth' });
            } else {
                localItemsSection.style.display = 'none';
                toggleButton.textContent = '管理本地物品';
            }
        }
        
        // 提示：由于浏览器安全限制，浏览按钮仅提供路径输入提示

        // 加载默认配置
        function loadDefaultConfig() {
            showMessage('正在加载当前配置...', 'info');
            
            fetch('/api/steam/workshop/config', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // 填充表单
                    const defaultFolder = data.config.default_workshop_folder || '';
                    const autoCreate = data.config.auto_create_folder !== false; // 默认true
                    
                    document.getElementById('default-workshop-folder').value = defaultFolder;
                    document.getElementById('auto-create-folder').checked = autoCreate;
                    
                    showMessage('配置加载成功', 'success');
                } else {
                    showMessage(`加载配置失败: ${data.error || '未知错误'}`, 'error');
                }
            })
            .catch(error => {
                console.error('加载配置时出错:', error);
                showMessage(`加载配置时出错: ${error.message}`, 'error');
            });
        }
        
        // 保存默认配置
        function saveDefaultConfig() {
            const defaultFolder = document.getElementById('default-workshop-folder').value.trim();
            const autoCreate = document.getElementById('auto-create-folder').checked;
            
            // 验证默认文件夹路径格式（如果提供了）
            if (defaultFolder && defaultFolder.length < 3) {
                showMessage('请输入有效的完整文件夹路径', 'error');
                return;
            }
            
            showMessage('正在保存配置...', 'info');
            
            fetch('/api/steam/workshop/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    default_workshop_folder: defaultFolder,
                    auto_create_folder: autoCreate
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showMessage('配置保存成功', 'success');
                } else {
                    showMessage(`保存配置失败: ${data.error || '未知错误'}`, 'error');
                }
            })
            .catch(error => {
                console.error('保存配置时出错:', error);
                showMessage(`保存配置时出错: ${error.message}`, 'error');
            });
        }
        
        // 扫描本地物品 - 现在仅使用默认路径
        function scanLocalItems() {
            // 直接使用默认路径，不再接受用户输入的路径
            showMessage('正在扫描默认创意工坊路径...', 'info');
            
            // 调用API扫描本地文件夹中的物品
            console.log('正在调用API扫描本地物品，使用默认路径');
            
            // 准备请求数据 - 空对象表示使用默认路径
            const requestData = {};
            console.log('请求数据:', requestData);
            
            fetch('/api/steam/workshop/local-items/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                console.log('API响应状态码:', response.status);
                if (!response.ok) {
                    console.error('API请求失败，状态码:', response.status);
                    throw new Error(`HTTP错误，状态码: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // 检查是否使用了默认路径
                const defaultPathUsed = !!data.default_path_used;
                
                if (data.success) {
                    // 获取本地物品列表和创意工坊已发布物品信息
                    const localItems = data.local_items || [];
                    const publishedItems = data.published_items || [];
                    
                    // 更新UI显示本地物品
                    displayLocalItems(localItems, publishedItems);
                    
                    // 构建成功消息
                    let successMessage = `成功扫描到 ${localItems.length} 个本地物品`;
                    if (defaultPathUsed && data.folder_path) {
                        successMessage += ` (使用默认路径: ${data.folder_path})`;
                    }
                    showMessage(successMessage, 'success');
                } else {
                    // 构建错误消息
                    let errorMessage = `扫描失败: ${data.error || '未知错误'}`;
                    if (defaultPathUsed) {
                        errorMessage += ' (尝试使用默认路径)';
                    }
                    showMessage(errorMessage, 'error');
                }
            })
            .catch(error => {
                console.error('扫描本地物品失败:', error);
                showMessage(`扫描过程中发生错误: ${error.message}`, 'error');
            });
        }
        
        // 检查文件是否存在
            async function doesFileExist(filePath) {
                try {
                    const response = await fetch(`/api/file-exists?path=${encodeURIComponent(filePath)}`);
                    const result = await response.json();
                    return result.exists;
                } catch (error) {
                    // 如果API不可用，返回false
                    return false;
                }
            }
            
            // 查找预览图片
            async function findPreviewImage(folderPath) {
                try {
                    // 尝试查找常见的预览图片文件
                    const commonImageNames = ['preview.jpg', 'preview.png', 'thumbnail.jpg', 'thumbnail.png', 'icon.jpg', 'icon.png', 'header.jpg', 'header.png'];
                    
                    for (const imageName of commonImageNames) {
                        const imagePath = `${folderPath}/${imageName}`;
                        if (await doesFileExist(imagePath)) {
                            return imagePath;
                        }
                    }
                    
                    // 如果找不到常见预览图，尝试使用API获取文件夹中的第一个图片文件
                    const response = await fetch(`/api/find-first-image?folder=${encodeURIComponent(folderPath)}`);
                    const result = await response.json();
                    
                    if (result.success && result.imagePath) {
                        return result.imagePath;
                    }
                } catch (error) {
                    console.error('查找预览图片失败:', error);
                }
                
                return null;
            }
            
            // 创意工坊物品对比
            async function compareLocalWithWorkshop(localItem) {
                try {
                    // 获取已发布的创意工坊物品
                    const workshopItems = await getWorkshopItems();
                    
                    // 比较名称
                    for (const workshopItem of workshopItems) {
                        if (areNamesSimilar(localItem.name, workshopItem.title)) {
                            return {
                                exists: true,
                                item: workshopItem,
                                reason: '名称相似'
                            };
                        }
                    }
                } catch (error) {
                    console.error('创意工坊对比失败:', error);
                }
                
                return { exists: false };
            }
            
            // 检查名称是否相似
            function areNamesSimilar(name1, name2) {
                // 简单的相似度检查，可以根据需要改进
                name1 = name1.toLowerCase().trim();
                name2 = name2.toLowerCase().trim();
                
                // 如果完全相同，直接返回true
                if (name1 === name2) return true;
                
                // 如果一个名称包含另一个名称
                if (name1.includes(name2) || name2.includes(name1)) return true;
                
                // 计算编辑距离（简单版本）
                if (Math.abs(name1.length - name2.length) > 3) return false;
                
                return false;
            }
            
            // 获取创意工坊物品列表
            async function getWorkshopItems() {
                try {
                    const response = await fetch('/api/steam/workshop/subscribed-items');
                    const data = await response.json();
                    if (data.success) {
                        return data.items;
                    }
                } catch (error) {
                    console.error('获取创意工坊物品失败:', error);
                }
                return [];
            }
            
            // 显示本地物品卡片
            function displayLocalItems(localItems, publishedItems) {
            const itemsList = document.getElementById('local-items-list');
            
            if (localItems.length === 0) {
                itemsList.innerHTML = `
                    <div class="empty-state">
                        <p>在指定文件夹中未找到任何创意工坊物品</p>
                        <button class="button" onclick="scanLocalItems()">重新扫描</button>
                    </div>
                `;
                return;
            }
            
            // 创建物品卡片HTML
            itemsList.innerHTML = localItems.map(item => {
                // 检查该物品是否已发布到创意工坊
                const isPublished = publishedItems.some(published => 
                    published.localId === item.id || 
                    (published.title && item.name && 
                     published.title.toLowerCase() === item.name.toLowerCase())
                );
                
                // 确定状态类和文本
                let statusClass = 'status-error';
                let statusText = '未发布';
                
                if (isPublished) {
                    statusClass = 'status-published';
                    statusText = '已发布';
                }
                
                // 生成预览图片URL或使用默认图片
                // 使用图片代理API访问本地图片，避免浏览器安全限制
                // 确保Windows路径中的反斜杠正确编码
                const previewUrl = item.previewImage ? `/api/proxy-image?image_path=${encodeURIComponent(item.previewImage.replace(/\\/g, '/'))}` : '../static/icons/Steam_icon_logo.png';
                
                // 生成卡片HTML
                return `
                    <div class="workshop-card">
                        <img src="${previewUrl}" alt="${item.name || '本地物品'}" class="card-image">
                        <div class="card-content">
                            <h3 class="card-title">${item.name || '未命名物品'}</h3>
                            <div class="status-badge ${statusClass}">${statusText}</div>
                            <div class="card-info">路径: ${item.path}</div>
                            <div class="card-info">修改日期: ${formatDate(item.lastModified)}</div>
                            <div class="card-info">大小: ${formatFileSize(item.size)}</div>
                            
                            ${!isPublished ? `
                                <div class="card-actions">
                                    <button class="button" onclick="prepareItemForUpload('${item.id}', '${encodeURIComponent(item.path.replace(/\\\\/g, '/'))}')">准备上传</button>
                                    <button class="button button-primary" onclick="quickUploadItem(event, '${item.id}', '${encodeURIComponent(item.path.replace(/\\\\/g, '/'))}')">快速上传</button>
                                </div>
                            ` : `
                                <div class="card-actions">
                                    <button class="button button-disabled" disabled>已发布</button>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 准备物品上传
        function prepareItemForUpload(itemId, folderPath) {
            // 确保路径格式一致（将Windows反斜杠转换为正斜杠以便正确编码）
            const normalizedPath = folderPath.replace(/\\/g, '/');
            // 调用API获取物品详情
            fetch(`/api/steam/workshop/local-items/${itemId}?folder_path=${encodeURIComponent(normalizedPath)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP错误，状态码: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const item = data.item;
                        
                        // 填充上传表单
                        document.getElementById('item-title').value = item.name || '';
                        document.getElementById('content-folder').value = item.path || '';
                        
                        // 如果有预览图片，填充预览图片路径
                        if (item.previewImage) {
                            document.getElementById('preview-image').value = item.previewImage;
                        }
                        
                        // 切换到上传区域
                        toggleUploadSection();
                        
                        showMessage('已将本地物品信息加载到上传表单', 'success');
                    } else {
                        showMessage(`获取物品详情失败: ${data.error || '未知错误'}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('准备上传失败:', error);
                    showMessage(`准备上传过程中发生错误: ${error.message}`, 'error');
                });
        }
        
        // 快速上传物品
        async function quickUploadItem(event, itemId, folderPath) {
            let button = null;
            try {
                // 显示上传中状态
                button = event?.target || null;
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 上传中...';
                }
                
                // 显示路径验证通知
                showMessage(`正在验证文件夹: ${folderPath}`, 'info');
                
                // 增强的路径规范化，支持Windows和其他系统
                const normalizedPath = folderPath.replace(/\\/g, '/');
                
                // 调用API获取物品详情，这里会进行服务器端路径验证
                const itemResponse = await fetch(`/api/steam/workshop/local-items/${itemId}?folder_path=${encodeURIComponent(normalizedPath)}`);
                if (!itemResponse.ok) {
                    throw new Error(`HTTP错误，状态码: ${itemResponse.status}`);
                }
                
                const itemData = await itemResponse.json();
                if (!itemData.success) {
                    throw new Error(`获取物品详情失败: ${itemData.error || '未知错误'}`);
                }
                
                const item = itemData.item;
                
                // 检查预览图片是否存在，如果不存在则尝试查找
                let previewImage = item.previewImage;
                if (!previewImage || !await doesFileExist(previewImage)) {
                    previewImage = await findPreviewImage(item.path);
                    if (!previewImage) {
                        showMessage('未找到预览图片，将尝试使用创意工坊默认图片机制', 'warning');
                    }
                }
                
                // 确保预览图片路径格式一致
                if (previewImage) {
                    previewImage = previewImage.replace(/\\/g, '/');
                }
                
                // 构建快速上传数据
                const uploadData = {
                    title: item.name || '未命名物品',
                    description: `通过N.E.K.O快速上传于 ${formatDate(new Date())}`,
                    content_folder: item.path,
                    preview_image: previewImage || '',
                    visibility: 0, // 默认公开
                    tags: item.tags || ['模组'],
                    allow_comments: true
                };
                
                // 发送API请求
                const publishResponse = await fetch('/api/steam/workshop/publish', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(uploadData)
                });
                
                if (!publishResponse.ok) {
                    throw new Error(`HTTP错误，状态码: ${publishResponse.status}`);
                }
                
                const publishData = await publishResponse.json();
                if (publishData.success) {
                    showMessage(`🎉 快速上传成功！物品ID: ${publishData.published_file_id}`, 'success');
                    
                    // 更新本地数据缓存
                    if (item.publishDate) {
                        item.publishDate = new Date();
                    }
                    item.publishedFileId = publishData.published_file_id;
                    
                    // 重新扫描以更新状态
                    setTimeout(() => {
                        scanLocalItems();
                    }, 1000);
                } else {
                    throw new Error(`发布失败: ${publishData.error || '未知错误'}`);
                }
            } catch (error) {
                showMessage(`上传失败: ${error.message}`, 'error');
            } finally {
                // 恢复按钮状态
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<i class="fa fa-rocket"></i> 快速上传';
                }
            }
        }
        
        // 格式化日期
        /* 注释掉不完整的formatDate版本 */
        /*
        function formatDate(timestamp) {
            if (!timestamp) return '未知';
            
            const date = new Date(timestamp);
            return date.toLocaleDateString();
        }
        */
        
        // 添加完整版本的formatDate函数（包含日期和时间）
        function formatDate(timestamp) {
            if (!timestamp) return '未知';
            
            const date = new Date(timestamp);
            // 使用toLocaleString同时显示日期和时间
            return date.toLocaleString();
        }
        
        // 文件路径选择辅助功能
        function validatePathInput(elementId) {
            const element = document.getElementById(elementId);
            element.addEventListener('blur', function() {
                const path = this.value.trim();
                if (path && path.includes('\\\\')) {
                    // 将双反斜杠替换为单反斜杠，Windows路径格式
                    this.value = path.replace(/\\\\/g, '\\');
                }
            });
        }
        
        // 为路径输入框添加验证
        validatePathInput('content-folder');
        validatePathInput('preview-image');
        
        // 标签管理功能
        const tagInput = document.getElementById('item-tags');
        const tagsContainer = document.getElementById('tags-container');
        
        tagInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && tagInput.value.trim() !== '') {
                e.preventDefault();
                addTag(tagInput.value.trim());
                tagInput.value = '';
            }
        });
        
        function addTag(tagText) {
            // 检查是否已存在相同标签
            const existingTags = Array.from(tagsContainer.querySelectorAll('.tag')).map(tag => 
                tag.textContent.replace('×', '').trim()
            );
            
            if (existingTags.includes(tagText)) {
                showMessage('标签已存在', 'error');
                return;
            }
            
            const tagElement = document.createElement('div');
            tagElement.className = 'tag';
            tagElement.innerHTML = `${tagText}<span class="tag-remove" onclick="removeTag(this)">×</span>`;
            tagsContainer.appendChild(tagElement);
        }
        
        function removeTag(tagElement) {
            tagElement.parentElement.remove();
        }
        
        // 消息显示功能 - 增强版
        function showMessage(message, type = 'info', duration = 3000) {
            const messageArea = document.getElementById('message-area') || createMessageArea();
            const messageElement = document.createElement('div');
            
            // 创建消息容器（如果不存在）
            function createMessageArea() {
                const container = document.createElement('div');
                container.id = 'message-area';
                container.className = 'message-area';
                document.body.appendChild(container);
                return container;
            }
            
            // 消息类型和图标映射
            const typeConfig = {
                error: { className: 'error-message', icon: 'fa-exclamation-circle' },
                warning: { className: 'warning-message', icon: 'fa-exclamation-triangle' },
                success: { className: 'success-message', icon: 'fa-check-circle' },
                info: { className: 'info-message', icon: 'fa-info-circle' }
            };
            
            // 获取当前消息类型的配置
            const config = typeConfig[type] || typeConfig.info;
            
            // 设置样式类
            messageElement.className = config.className;
            
            // 设置消息内容，添加图标和HTML转义
            messageElement.innerHTML = `
                <i class="fa ${config.icon}" style="margin-right: 8px;"></i>
                <span>${escapeHtml(message)}</span>
            `;
            
            // 添加关闭按钮
            const closeButton = document.createElement('span');
            closeButton.className = 'message-close';
            closeButton.innerHTML = '<i class="fa fa-times"></i>';
            closeButton.onclick = () => messageElement.remove();
            messageElement.appendChild(closeButton);
            
            // 为错误消息添加详细信息支持
            if (type === 'error' && typeof message === 'object') {
                messageElement.title = JSON.stringify(message, null, 2);
            }
            
            // 添加消息
            messageArea.appendChild(messageElement);
            
            // 设置初始样式
            messageElement.style.opacity = '0';
            messageElement.style.transform = 'translateY(-10px)';
            messageElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            messageElement.style.display = 'flex';
            messageElement.style.alignItems = 'center';
            messageElement.style.padding = '10px 15px';
            messageElement.style.marginBottom = '10px';
            messageElement.style.borderRadius = '4px';
            messageElement.style.position = 'relative';
            messageElement.style.zIndex = '1000';
            
            // 为不同类型设置背景色
            const bgColors = {
                error: '#ffebee',
                warning: '#fff8e1',
                success: '#e8f5e9',
                info: '#e3f2fd'
            };
            messageElement.style.backgroundColor = bgColors[type] || '#f5f5f5';
            
            // 设置消息显示动画
            setTimeout(() => {
                messageElement.style.opacity = '1';
                messageElement.style.transform = 'translateY(0)';
            }, 10);
            
            // 确保消息区域在页面顶部且固定
            messageArea.style.position = 'fixed';
            messageArea.style.top = '20px';
            messageArea.style.right = '20px';
            messageArea.style.maxWidth = '400px';
            messageArea.style.zIndex = '10000';
            messageArea.style.display = 'flex';
            messageArea.style.flexDirection = 'column';
            messageArea.style.alignItems = 'flex-end';
            
            // 关闭按钮样式
            closeButton.style.position = 'absolute';
            closeButton.style.right = '10px';
            closeButton.style.cursor = 'pointer';
            closeButton.style.fontSize = '16px';
            closeButton.style.border = 'none';
            closeButton.style.background = 'none';
            closeButton.style.padding = '2px 5px';
            closeButton.style.borderRadius = '3px';
            closeButton.onmouseover = function() { this.style.backgroundColor = 'rgba(0,0,0,0.1);' };
            closeButton.onmouseout = function() { this.style.backgroundColor = 'transparent;' };
            
            // 自动清除消息（如果指定了持续时间）
            if (duration > 0) {
                setTimeout(() => {
                    messageElement.style.opacity = '0';
                    messageElement.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        messageElement.remove();
                    }, 300);
                }, duration);
            }
        }
        
        // HTML转义函数
        function escapeHtml(text) {
            if (typeof text !== 'string') {
                return String(text);
            }
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 加载状态管理器
        function LoadingManager() {
            const loadingCount = { value: 0 };
            
            return {
                show: function(message = '加载中...') {
                    loadingCount.value++;
                    if (loadingCount.value === 1) {
                        const loadingOverlay = document.createElement('div');
                        loadingOverlay.id = 'loading-overlay';
                        loadingOverlay.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(255, 255, 255, 0.8);
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            z-index: 9999;
                            backdrop-filter: blur(2px);
                        `;
                        
                        const loadingSpinner = document.createElement('div');
                        loadingSpinner.style.cssText = `
                            border: 4px solid #f3f3f3;
                            border-top: 4px solid #3498db;
                            border-radius: 50%;
                            width: 40px;
                            height: 40px;
                            animation: spin 1s linear infinite;
                            margin-bottom: 15px;
                        `;
                        
                        const loadingText = document.createElement('div');
                        loadingText.textContent = message;
                        loadingText.style.fontSize = '16px';
                        loadingText.style.color = '#333';
                        
                        // 添加CSS动画
                        const style = document.createElement('style');
                        style.textContent = `
                            @keyframes spin {
                                0% { transform: rotate(0deg); }
                                100% { transform: rotate(360deg); }
                            }
                        `;
                        
                        loadingOverlay.appendChild(loadingSpinner);
                        loadingOverlay.appendChild(loadingText);
                        document.body.appendChild(loadingOverlay);
                        document.body.appendChild(style);
                    }
                },
                
                hide: function() {
                    loadingCount.value--;
                    if (loadingCount.value <= 0) {
                        loadingCount.value = 0;
                        const overlay = document.getElementById('loading-overlay');
                        if (overlay) {
                            overlay.remove();
                        }
                    }
                }
            };
        }
        
        // 创建全局加载管理器实例
        const loading = new LoadingManager();
        
        // 表单验证函数
        function validateForm() {
            let isValid = true;
            const errorMessages = [];
            
            // 验证标题
            const title = document.getElementById('item-title').value.trim();
            if (!title) {
                errorMessages.push('请输入标题');
                document.getElementById('item-title').classList.add('error');
                isValid = false;
            } else {
                document.getElementById('item-title').classList.remove('error');
            }
            
            // 验证内容文件夹
            const contentFolder = document.getElementById('content-folder').value.trim();
            if (!contentFolder) {
                errorMessages.push('请输入内容文件夹路径');
                document.getElementById('content-folder').classList.add('error');
                isValid = false;
            } else {
                // 简单的路径格式验证
                if (!contentFolder.match(/^[a-zA-Z]:\\/)) {
                    errorMessages.push('内容文件夹路径格式不正确，应为D:\\\Projects\\\\MyMod格式');
                    document.getElementById('content-folder').classList.add('error');
                    isValid = false;
                } else {
                    document.getElementById('content-folder').classList.remove('error');
                }
            }
            
            // 验证预览图片
            const previewImage = document.getElementById('preview-image').value.trim();
            if (!previewImage) {
                errorMessages.push('请输入预览图片路径');
                document.getElementById('preview-image').classList.add('error');
                isValid = false;
            } else {
                // 验证图片格式
                const imageExtRegex = /\.(jpg|jpeg|png)$/i;
                if (!imageExtRegex.test(previewImage)) {
                    errorMessages.push('预览图片必须是.jpg或.png格式');
                    document.getElementById('preview-image').classList.add('error');
                    isValid = false;
                } else {
                    document.getElementById('preview-image').classList.remove('error');
                }
            }
            
            // 显示验证错误消息
            if (errorMessages.length > 0) {
                showMessage(errorMessages.join('\n'), 'error', 5000);
            }
            
            return isValid;
        }
        
        // 禁用/启用按钮函数
        function setButtonState(buttonElement, isDisabled) {
            if (buttonElement) {
                buttonElement.disabled = isDisabled;
                if (isDisabled) {
                    buttonElement.classList.add('button-disabled');
                } else {
                    buttonElement.classList.remove('button-disabled');
                }
            }
        }
        
        // 上传物品功能
        function uploadItem() {
            // 检查是否已从本地物品中选择内容
            let contentFolder = document.getElementById('content-folder').value.trim();
            let previewImage = document.getElementById('preview-image').value.trim();
            
            if (!contentFolder) {
                showMessage('请先在"管理本地物品"中选择要上传的物品', 'error');
                return;
            }
            
            // 增强的路径规范化处理
            contentFolder = contentFolder.replace(/\\/g, '/');
            if (previewImage) {
                previewImage = previewImage.replace(/\\/g, '/');
            }
            
            // 显示路径验证通知
            showMessage(`正在验证文件夹路径: ${contentFolder}`, 'info');
            
            // 如果没有预览图片，仍然允许继续上传，后端会尝试自动查找或使用默认机制
            if (!previewImage) {
                showMessage('未提供预览图片，后端将尝试自动查找或使用默认机制', 'warning');
            }
            
            // 验证表单
            if (!validateForm()) {
                return;
            }
            
            // 收集表单数据
            const title = document.getElementById('item-title').value.trim();
            const description = document.getElementById('item-description').value.trim();
            // 内容文件夹和预览图片路径已经在上面定义过了，不再重复定义
            const visibilitySelect = document.getElementById('visibility');
            const allowComments = document.getElementById('allow-comments').checked;
            
            // 收集标签
            const tags = Array.from(document.querySelectorAll('#tags-container .tag')).map(tag => 
                tag.textContent.replace('×', '').trim()
            );
            
            // 转换可见性选项为数值
            let visibility = 0; // 默认公开
            if (visibilitySelect.value === 'friends') {
                visibility = 1;
            } else if (visibilitySelect.value === 'private') {
                visibility = 2;
            }
            
            // 准备上传数据
            const uploadData = {
                title: title,
                description: description,
                content_folder: contentFolder,
                preview_image: previewImage,
                visibility: visibility,
                tags: tags,
                allow_comments: allowComments
            };
            
            // 获取上传按钮并禁用
            const uploadButton = document.querySelector('.upload-section button.button');
            const originalText = uploadButton.textContent;
            uploadButton.textContent = '上传中...';
            setButtonState(uploadButton, true);
            
            // 显示上传中消息
            showMessage('正在准备上传...', 'success', 0); // 0表示不自动关闭
            
            // 发送API请求
            fetch('/api/steam/workshop/publish', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(uploadData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP错误，状态码: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // 恢复按钮状态
                uploadButton.textContent = originalText;
                setButtonState(uploadButton, false);
                
                if (data.success) {
                    showMessage('🎉 上传成功！内容已提交到创意工坊', 'success', 5000);
                    
                    // 显示物品ID
                    if (data.published_file_id) {
                        showMessage(`📦 物品ID: ${data.published_file_id}`, 'success', 5000);
                    }
                    
                    // 如果需要接受协议
                    if (data.needs_to_accept_agreement) {
                        showMessage('ℹ️ 需要接受创意工坊协议，请在Steam客户端中完成', 'warning', 8000);
                    }
                    
                    // 清空表单
                    document.getElementById('item-title').value = '';
                    document.getElementById('item-description').value = '';
                    document.getElementById('content-folder').value = '';
                    document.getElementById('preview-image').value = '';
                    document.getElementById('visibility').value = 'public';
                    document.getElementById('allow-comments').checked = true;
                    
                    // 清空标签
                    const tagsContainer = document.getElementById('tags-container');
                    tagsContainer.innerHTML = '';
                    
                    // 添加默认标签
                    addTag('模组');
                    
                    // 显示成功提示和操作选项
                    setTimeout(() => {
                        const messageArea = document.getElementById('message-area');
                        const actionMessage = document.createElement('div');
                        actionMessage.className = 'success-message';
                        actionMessage.innerHTML = `
                            <span>操作已完成，您可以：</span>
                            <button class="button button-sm" onclick="document.getElementById('item-title').focus()">继续上传</button>
                            <button class="button button-sm" onclick="toggleUploadSection()">隐藏上传区</button>
                            <span class="message-close" onclick="this.parentElement.remove()">×</span>
                        `;
                        messageArea.appendChild(actionMessage);
                    }, 1000);
                } else {
                    showMessage(`❌ 上传失败: ${data.error || '未知错误'}`, 'error', 8000);
                    if (data.message) {
                        showMessage(`⚠️ ${data.message}`, 'warning', 8000);
                    }
                    
                    // 提供重试建议
                    setTimeout(() => {
                        const retryButton = document.createElement('button');
                        retryButton.className = 'button button-sm';
                        retryButton.textContent = '重试上传';
                        retryButton.onclick = uploadItem;
                        
                        const messageArea = document.getElementById('message-area');
                        const retryMessage = document.createElement('div');
                        retryMessage.className = 'error-message';
                        retryMessage.innerHTML = `<span>是否重试上传？</span>
                            <button class="button button-sm" onclick="uploadItem()">重试</button>
                            <span class="message-close" onclick="this.parentElement.remove()">×</span>`;
                        messageArea.appendChild(retryMessage);
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('上传失败:', error);
                
                // 恢复按钮状态
                uploadButton.textContent = originalText;
                setButtonState(uploadButton, false);
                
                let errorMessage = '上传过程中发生错误';
                
                // 根据错误类型提供更具体的提示
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage += '，可能是网络连接问题或服务器未启动';
                    showMessage(`❌ ${errorMessage}`, 'error', 8000);
                    showMessage('⚠️ 请检查网络连接和服务器状态', 'warning', 8000);
                } else if (error.message.includes('HTTP错误')) {
                    errorMessage += `：${error.message}`;
                    showMessage(`❌ ${errorMessage}`, 'error', 8000);
                    showMessage('⚠️ 服务器可能遇到问题，请稍后再试', 'warning', 8000);
                } else {
                    showMessage(`❌ ${errorMessage}：${error.message}`, 'error', 8000);
                }
            });
        }
        
        // 加载订阅物品
        function loadSubscriptions() {
            const subscriptionsList = document.getElementById('subscriptions-list');
            subscriptionsList.innerHTML = '<div class="empty-state"><p>正在加载您的订阅物品...</p></div>';
            
            // 调用后端API获取订阅物品列表
            fetch('/api/steam/workshop/subscribed-items')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.success) {
                        subscriptionsList.innerHTML = `<div class="empty-state"><p>获取订阅物品失败: ${data.error || '未知错误'}</p></div>`;
                        // 如果有消息提示，显示给用户
                        if (data.message) {
                            showMessage(data.message, 'error');
                        }
                        return;
                    }
                    
                    if (data.items.length === 0) {
                        subscriptionsList.innerHTML = '<div class="empty-state"><p>您还没有订阅任何创意工坊物品</p></div>';
                    } else {
                        // 生成卡片HTML
                        subscriptionsList.innerHTML = data.items.map(item => {
                            // 格式化物品数据为前端所需格式
                        // 确保publishedFileId转换为字符串，避免类型错误
                        const formattedItem = {
                            id: String(item.publishedFileId),
                            name: item.title || `未知物品_${String(item.publishedFileId)}`,
                            author: item.steamIDOwner ? String(item.steamIDOwner) : '未知作者', // 暂时使用SteamID作为作者名
                            subscribedDate: item.timeAdded ? new Date(item.timeAdded * 1000).toLocaleDateString() : '未知日期',
                            lastUpdated: item.timeUpdated ? new Date(item.timeUpdated * 1000).toLocaleDateString() : '未知日期',
                            size: formatFileSize(item.fileSizeOnDisk || item.fileSize || 0),
                            previewUrl: item.previewImageUrl || '../static/icons/Steam_icon_logo.png',
                            state: item.state || {},
                            // 添加安装路径信息
                            installedFolder: item.installedFolder || '',
                            description: item.description || '暂无描述'
                        };
                            
                            // 确定状态类和文本
                            let statusClass = 'status-subscribed';
                            let statusText = '已订阅';
                            
                            if (formattedItem.state.downloading) {
                                statusClass = 'status-downloading';
                                statusText = '下载中';
                            } else if (formattedItem.state.needsUpdate) {
                                statusClass = 'status-needs-update';
                                statusText = '需要更新';
                            } else if (formattedItem.state.installed) {
                                statusClass = 'status-installed';
                                statusText = '已安装';
                            }
                             
                            return `
                                <div class="workshop-card">
                                    <img src="${formattedItem.installedFolder ? `/api/proxy-image?image_path=${encodeURIComponent(formattedItem.installedFolder + '/preview.png')}` : `/api/proxy-image?image_path=${encodeURIComponent(formattedItem.previewUrl)}`}" alt="${formattedItem.name}" class="card-image">
                                    <div class="card-content">
                                        <h3 class="card-title">${formattedItem.name}</h3>
                                        <div class="status-badge ${statusClass}">${statusText}</div>
                                        <div class="author-info">
                                                <div class="author-avatar">${formattedItem.author.substring(0, 2).toUpperCase()}</div>
                                                <span>作者: ${formattedItem.author}</span>
                                            </div>
                                        <div class="card-info">订阅日期: ${formattedItem.subscribedDate}</div>
                                        <div class="card-info">上次更新: ${formattedItem.lastUpdated}</div>
                                        <div class="card-info">大小: ${formattedItem.size}</div>
                                        ${formattedItem.installedFolder ? 
                                            `<div class="card-info card-path">安装路径: <span class="path-text" title="${formattedItem.installedFolder}">${formattedItem.installedFolder}</span></div>` : ''
                                        }
                                        ${formattedItem.state.downloading && item.downloadProgress ? 
                                            `<div class="download-progress">
                                                <div class="progress-bar">
                                                    <div class="progress-fill" style="width: ${item.downloadProgress.percentage}%">
                                                        ${item.downloadProgress.percentage.toFixed(1)}%
                                                    </div>
                                                </div>
                                            </div>` : ''
                                        }
                                        <div class="card-actions">
                        
                                            <button class="button button-danger" onclick="unsubscribeItem('${formattedItem.id}', '${formattedItem.name}')">取消订阅</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                })
                .catch(error => {
                    console.error('获取订阅物品失败:', error);
                    subscriptionsList.innerHTML = `<div class="empty-state"><p>获取订阅物品失败: ${error.message}</p></div>`;
                    showMessage('无法连接到服务器，请检查网络连接', 'error');
                });
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0 || bytes === undefined) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 获取状态文本
        function getStatusText(state) {
            if (state.downloading) {
                return '下载中';
            } else if (state.needsUpdate) {
                return '需要更新';
            } else if (state.installed) {
                return '已安装';
            } else if (state.subscribed) {
                return '已订阅';
            } else {
                return '未知';
            }
        }
        
        // 打开模态框
        function openModal() {
            const modal = document.getElementById('itemDetailsModal');
            modal.style.display = 'flex';
            // 阻止页面滚动
            document.body.style.overflow = 'hidden';
        }
        
        // 关闭模态框
        function closeModal() {
            const modal = document.getElementById('itemDetailsModal');
            modal.style.display = 'none';
            // 恢复页面滚动
            document.body.style.overflow = 'auto';
        }
        
        // 点击模态框外部关闭
        function closeModalOnOutsideClick(event) {
            const modal = document.getElementById('itemDetailsModal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        // 获取物品详细信息（模拟）
        function getItemDetails(itemId) {
            // 模拟从服务器获取数据
            // 实际应用中，这里应该是一个API调用来获取真实数据
            const sampleData = [
                {
                    id: '1',
                    name: '精美角色模型包',
                    author: 'Creator1',
                    authorUrl: '#',
                    subscribedDate: '2024-01-15',
                    lastUpdated: '2024-02-10',
                    size: '15.2 MB',
                    previewUrl: '../static/icons/character_icon.png',
                    description: '这是一个包含多个精美角色模型的包，适合各类游戏和动画项目使用。所有模型都经过优化，支持各种常见的3D引擎。每个角色都有完整的骨骼系统和基本动作集。',
                    downloadCount: '1,245',
                    rating: '4.8/5',
                    tags: ['角色', '模型', '3D', '动画']
                },
                {
                    id: '2',
                    name: '环境材质包',
                    author: 'TextureMaster',
                    authorUrl: '#',
                    subscribedDate: '2024-01-20',
                    lastUpdated: '2024-02-05',
                    size: '24.8 MB',
                    previewUrl: '../static/icons/memory_icon.png',
                    description: '高品质环境材质包，包含各种自然和城市环境的纹理。所有材质都具有4K分辨率，包含法线贴图、高光贴图和置换贴图，为您的项目带来极致的视觉效果。',
                    downloadCount: '3,567',
                    rating: '4.9/5',
                    tags: ['材质', '环境', '纹理', '高清']
                },
                {
                    id: '3',
                    name: '声音效果合集',
                    author: 'AudioPro',
                    authorUrl: '#',
                    subscribedDate: '2024-02-01',
                    lastUpdated: '2024-02-15',
                    size: '32.1 MB',
                    previewUrl: '../static/icons/voice_clone_icon.png',
                    description: '专业级声音效果合集，包含超过500个高品质音效。涵盖了自然环境、武器、UI反馈、角色语音等多种类型，全部采用无损音质录制，为您的游戏或应用增添沉浸式音频体验。',
                    downloadCount: '2,134',
                    rating: '4.7/5',
                    tags: ['音效', '音频', '声音', '游戏']
                },
                {
                    id: '4',
                    name: '动态背景特效',
                    author: 'VisualArtist',
                    authorUrl: '#',
                    subscribedDate: '2024-02-20',
                    lastUpdated: '2024-03-01',
                    size: '45.6 MB',
                    previewUrl: '../static/icons/live2d_settings_icon.png',
                    description: '炫酷的动态背景特效集合，包含粒子效果、流体动画、光效等多种类型。所有特效都针对性能进行了优化，可以轻松集成到各类应用和游戏中，为用户界面增添视觉吸引力。',
                    downloadCount: '1,876',
                    rating: '4.6/5',
                    tags: ['特效', '动画', '背景', '视觉']
                },
                {
                    id: '5',
                    name: 'AI语音包',
                    author: 'VoiceCreator',
                    authorUrl: '#',
                    subscribedDate: '2024-03-05',
                    lastUpdated: '2024-03-15',
                    size: '28.3 MB',
                    previewUrl: '../static/icons/voice_clone_icon.png',
                    description: '由先进AI技术生成的语音包，包含多种角色声音和情感表达。所有语音都经过自然化处理，支持多种语言和方言，可以用于游戏角色配音、虚拟助手、有声读物等多种场景。',
                    downloadCount: '2,789',
                    rating: '4.5/5',
                    tags: ['AI', '语音', '配音', '声音']
                },
                {
                    id: '6',
                    name: 'Steam主题皮肤',
                    author: 'Themer',
                    authorUrl: '#',
                    subscribedDate: '2024-03-10',
                    lastUpdated: '2024-03-20',
                    size: '12.7 MB',
                    previewUrl: '../static/icons/Steam_icon_logo.png',
                    description: '精美的Steam客户端主题皮肤，改变您的Steam界面外观。包含多种颜色方案和视觉风格，所有元素都经过精心设计，保持Steam原有功能的同时提供全新的视觉体验。',
                    downloadCount: '4,321',
                    rating: '4.9/5',
                    tags: ['Steam', '主题', '皮肤', '界面']
                }
            ];
            
            // 查找对应ID的物品
            return sampleData.find(item => item.id === itemId) || null;
        }
        
        // 查看物品详情
function viewItemDetails(itemId) {
    // 显示加载消息
    showMessage(`正在加载物品ID: ${itemId} 的详细信息...`, 'success');
    
    // 调用后端API获取物品详情
    fetch(`/api/steam/workshop/item/${itemId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                showMessage(`获取物品详情失败: ${data.error || '未知错误'}`, 'error');
                return;
            }
            
            const item = data.item;
            const formattedItem = {
                id: item.publishedFileId.toString(),
                name: item.title,
                author: item.steamIDOwner.toString(),
                subscribedDate: new Date(item.timeAdded * 1000).toLocaleDateString(),
                lastUpdated: new Date(item.timeUpdated * 1000).toLocaleDateString(),
                size: formatFileSize(item.fileSize),
                previewUrl: item.previewImageUrl || '../static/icons/Steam_icon_logo.png',
                description: item.description || '暂无描述',
                downloadCount: 'N/A',
                rating: 'N/A',
                tags: ['模组'], // 默认标签，实际应用中应该从API获取
                state: item.state || {} // 添加state属性，确保后续代码可以正常访问
            };
            
            // 确定状态类和文本
            let statusClass = 'status-subscribed';
            let statusText = getStatusText(formattedItem.state || {});
            
            if (formattedItem.state && formattedItem.state.downloading) {
                statusClass = 'status-downloading';
            } else if (formattedItem.state && formattedItem.state.needsUpdate) {
                statusClass = 'status-needs-update';
            } else if (formattedItem.state && formattedItem.state.installed) {
                statusClass = 'status-installed';
            }
            
            // 获取作者头像（使用首字母作为占位符）
            const authorInitial = formattedItem.author.substring(0, 2).toUpperCase();
            
            // 更新模态框内容
            document.getElementById('modalTitle').textContent = formattedItem.name;
            
            const detailContent = document.getElementById('itemDetailContent');
            detailContent.innerHTML = `
                <img src="${formattedItem.installedFolder ? `/api/proxy-image?image_path=${encodeURIComponent(formattedItem.installedFolder + '/preview.png')}` : `/api/proxy-image?image_path=${encodeURIComponent(formattedItem.previewUrl)}`}" alt="${formattedItem.name}" class="item-preview-large">
                
                <div class="item-info-grid">
                    <p class="item-info-item">
                        <span class="item-info-label">作者:</span>
                        <div class="author-info">
                            <div class="author-avatar">${authorInitial}</div>
                            <span>${formattedItem.author}</span>
                        </div>
                    </p>
                    <p class="item-info-item"><span class="item-info-label">订阅日期:</span> ${formattedItem.subscribedDate}</p>
                    <p class="item-info-item"><span class="item-info-label">上次更新:</span> ${formattedItem.lastUpdated}</p>
                    <p class="item-info-item"><span class="item-info-label">大小:</span> ${formattedItem.size}</p>
                    <p class="item-info-item">
                        <span class="item-info-label">状态:</span>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </p>
                    <p class="item-info-item"><span class="item-info-label">下载次数:</span> ${formattedItem.downloadCount}</p>
                    ${formattedItem.state && formattedItem.state.downloading && item.downloadProgress ? 
                        `<p class="item-info-item" style="grid-column: span 2;">
                            <div class="download-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${item.downloadProgress.percentage}%">
                                        ${item.downloadProgress.percentage.toFixed(1)}%
                                    </div>
                                </div>
                            </div>
                        </p>` : ''
                    }
                </div>
                
                <div>
                    <h4>标签</h4>
                    <div class="tags-container">
                        ${formattedItem.tags.map(tag => `
                            <div class="tag">${tag}</div>
                        `).join('')}
                    </div>
                </div>
                
                <div>
                    <h4>描述</h4>
                    <p class="item-description">${formattedItem.description}</p>
                </div>
            `;
            
            // 打开模态框
            openModal();
        })
        .catch(error => {
            console.error('获取物品详情失败:', error);
            showMessage('无法加载物品详情，请稍后再试', 'error');
        });
}
        
                // 取消订阅功能
        function unsubscribeItem(itemId, itemName) {
            if (confirm(`确定要取消订阅 "${itemName}" 吗？`)) {
                // 查找当前卡片并添加移除动画效果
                const cards = document.querySelectorAll('.workshop-card');
                for (let card of cards) {
                    const cardTitle = card.querySelector('.card-title').textContent;
                    if (cardTitle === itemName) {
                        // 添加淡出效果
                        card.style.opacity = '0.6';
                        card.style.transform = 'scale(0.95)';
                        break;
                    }
                }
                
                // 调用后端API执行取消订阅操作
                showMessage(`正在取消订阅 "${itemName}"...`, 'success');
                
                fetch('/api/steam/workshop/unsubscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ item_id: itemId })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // 显示异步操作状态
                        let statusMessage = `取消订阅请求已被接受，正在处理 "${itemName}"`;
                        if (data.status === 'accepted') {
                            statusMessage = `取消订阅请求已被接受，系统正在处理 "${itemName}"`;
                        }
                        showMessage(statusMessage, 'success');
                        
                        // 立即重新加载订阅列表
                        loadSubscriptions();
                        
                        // 添加短暂延迟后再次刷新，确保获取最新状态
                        setTimeout(() => {
                            loadSubscriptions();
                            showMessage(`订阅列表已更新`, 'success');
                        }, 1000);
                        
                    } else {
                        showMessage(`取消订阅失败: ${data.error || '未知错误'}`, 'error');
                        // 如果有消息提示，显示给用户
                        if (data.message) {
                            showMessage(data.message, 'warning');
                        }
                    }
                })
                .catch(error => {
                    console.error('取消订阅失败:', error);
                    showMessage('取消订阅时发生错误，请稍后再试', 'error');
                });
            }
        }
        
        // 初始化页面
        window.onload = function() {
            // 初始化时添加一些示例标签
            addTag('模组');
            addTag('角色');
            
            // 页面加载时自动加载订阅内容
            loadSubscriptions();
            
            // 页面加载时自动扫描本地物品
            scanLocalItems();
        };
    </script>
</body>
</html>