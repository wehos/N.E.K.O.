<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§’è‰²ç®¡ç† - Project Lanlan</title>
    <script src="/static/common_dialogs.js"></script>
    <style>
        *:focus {
            outline: none !important;
            box-shadow: none !important; 
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #f7f8fa;
            color: #222;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        .container {
            max-width: 700px;
            margin: 40px auto 0 auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 32px 24px 24px 24px;
        }
        h2 {
            margin-top: 0;
            font-size: 1.5rem;
        }
        .section {
            margin-bottom: 32px;
        }
        .field-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        .field-row label {
            min-width: 80px;
            font-weight: bold;
        }
        .field-row input, .field-row select {
            flex: 1;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        .field-row .optional {
            color: #888;
            font-size: 0.95em;
            margin-left: 8px;
        }
        .btn {
            padding: 8px 18px;
            border-radius: 6px;
            border: none;
            background: #4f8cff;
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
            margin-right: 8px;
            transition: background 0.2s;
        }
        .btn:active { background: #2662c8; }
        .btn.delete { background: #e74c3c; }
        .btn.delete:active { background: #c0392b; }
        .btn.add { background: #27ae60; }
        .btn.add:active { background: #1e8449; }
        /* å°å·æŒ‰é’® */
        .btn.sm {
            padding: 4px 10px;
            font-size: 0.92rem;
            border-radius: 4px;
            margin-right: 4px;
        }
        .btn.sm.delete { background: #e74c3c; }
        .btn.sm.add { background: #27ae60; }
        .btn.sm:active { background: #2662c8; }
        .btn.sm.delete:active { background: #c0392b; }
        .btn.sm.add:active { background: #1e8449; }
        .fold {
            background: #f0f2f5;
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 10px 16px;
        }
        .fold-toggle {
            cursor: pointer;
            color: #4f8cff;
            font-weight: bold;
            user-select: none;
        }
        .fold-content {
            display: none;
            margin-top: 10px;
        }
        .fold.open > .fold-content {
            display: block;
        }
        .catgirl-block {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 18px;
            padding: 16px 12px 10px 12px;
            background: #fafbfc;
        }
        .catgirl-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .catgirl-title {
            font-weight: bold;
            font-size: 1.1em;
        }
        .catgirl-actions {
            display: flex;
            gap: 8px;
        }
        .tips {
            color: #888;
            font-size: 0.95em;
            margin-bottom: 10px;
        }
        @media (max-width: 600px) {
            .container { padding: 10px 2vw; }
        }
        

    </style>
</head>
<body>
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">è§’è‰²ç®¡ç†</h2>
        <button class="btn sm" onclick="openApiKeySettings()" style="background: #6c757d;">ğŸ”‘ API Key è®¾ç½®</button>
    </div>
    <div class="section" id="master-section">
        <div class="tips">ğŸ·ä¸»äººæ¡£æ¡ˆï¼ˆå”¯ä¸€ï¼‰ï¼šæ¡£æ¡ˆåä¸ºå¿…å¡«é¡¹ï¼Œå…¶ä»–å‡ä¸ºå¯é€‰é¡¹ï¼Œå¯è‡ªè¡Œåˆ å‡ã€‚</div>
        <div class="catgirl-block">
            <form id="master-form">
                <div class="field-row">
                    <label>æ¡£æ¡ˆå<span style="color:red">*</span></label>
                    <input type="text" name="æ¡£æ¡ˆå" required>
                </div>
                <div class="field-row">
                    <label>æ€§åˆ«</label>
                    <input type="text" name="æ€§åˆ«">
                    <button type="button" class="btn sm delete" onclick="deleteMasterField(this)">åˆ é™¤è®¾å®š</button>
                </div>
                <div class="field-row">
                    <label>æ˜µç§°</label>
                    <input type="text" name="æ˜µç§°">
                    <button type="button" class="btn sm delete" onclick="deleteMasterField(this)">åˆ é™¤è®¾å®š</button>
                </div>
            </form>
        </div>
    </div>
    <div class="section" id="catgirl-section">
        <div class="tips">ğŸ©·çŒ«å¨˜æ¡£æ¡ˆï¼šè¿›é˜¶è®¾å®šåŒ…å«Live2Då½¢è±¡ã€è¯­éŸ³IDç­‰ã€‚</div>
        <div id="catgirl-list"></div>
        <button class="btn add sm" id="add-catgirl-btn">â• æ–°å¢çŒ«å¨˜</button>
    </div>
</div>


<script>
// æŠ˜å é¢æ¿åˆ‡æ¢
function toggleFold(fold) {
    fold.classList.toggle('open');
}

// äº‹ä»¶å§”æ‰˜ï¼Œæ”¯æŒæ‰€æœ‰åŠ¨æ€è¡¨å•çš„æŠ˜å æŒ‰é’®å’Œç®­å¤´ç¬¦å·
if (!window._charaManagerFoldHandler) {
    document.body.addEventListener('click', function(e) {
        if (e.target.classList.contains('fold-toggle') || (e.target.classList.contains('arrow') && e.target.parentNode.classList.contains('fold-toggle'))) {
            let toggle = e.target.classList.contains('fold-toggle') ? e.target : e.target.parentNode;
            let fold = toggle.closest('.fold');
            if (fold) {
                fold.classList.toggle('open');
                // åŠ¨æ€åˆ‡æ¢ç®­å¤´
                let arrow = toggle.querySelector('.arrow');
                if (arrow) arrow.textContent = fold.classList.contains('open') ? 'â–²' : 'â–¼';
                
                // ç«‹å³ä¿å­˜é«˜çº§è®¾ç½®ä¸‹æ‹‰æ çŠ¶æ€
                // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€å¤–å±‚çš„foldï¼ˆè¿›é˜¶è®¾å®šï¼‰
                if (!fold.parentElement.closest('.fold') && toggle.textContent.includes('è¿›é˜¶è®¾å®š')) {
                    // è·å–å½“å‰è¡¨å•
                    const form = fold.closest('form');
                    if (form) {
                        // å°è¯•ä»è¡¨å•çš„_catgirlNameå±æ€§æˆ–æ¡£æ¡ˆåå­—æ®µè·å–çŒ«å¨˜åç§°
                        let catgirlName = form._catgirlName;
                        if (!catgirlName) {
                            const nameField = form.querySelector('[name="æ¡£æ¡ˆå"]');
                            if (nameField) {
                                catgirlName = nameField.value.trim();
                            }
                        }
                        
                        // å¦‚æœæœ‰çŒ«å¨˜åç§°ï¼Œä¿å­˜å±•å¼€çŠ¶æ€
                        if (catgirlName) {
                            const isOpen = fold.classList.contains('open');
                            localStorage.setItem(`catgirl_advanced_${catgirlName}`, isOpen.toString());
                        }
                    }
                }
            }
        }
    });
    window._charaManagerFoldHandler = true;
}

// è§’è‰²æ•°æ®ç¼“å­˜
let characterData = null;

// åŠ è½½è§’è‰²æ•°æ®
// è·Ÿè¸ªå½“å‰å±•å¼€çš„çŒ«å¨˜åç§°
let expandedCatgirlName = null;

async function loadCharacterData() {
    const resp = await fetch('/api/characters');
    characterData = await resp.json();
    renderMaster();
    renderCatgirls();
    updateSwitchButtons();
    
    // å¦‚æœæœ‰ä¹‹å‰å±•å¼€çš„çŒ«å¨˜ï¼Œè‡ªåŠ¨å±•å¼€å®ƒ
    if (expandedCatgirlName) {
        const catgirls = characterData['çŒ«å¨˜'] || {};
        if (catgirls[expandedCatgirlName]) {
            // ä½¿ç”¨ setTimeout ç¡®ä¿ DOM å·²ç»æ¸²æŸ“å®Œæˆ
            setTimeout(() => {
                // éå†æ‰€æœ‰çŒ«å¨˜å—ï¼Œæ‰¾åˆ°åŒ¹é…çš„
                const blocks = document.querySelectorAll('.catgirl-block');
                blocks.forEach(block => {
                    const titleSpan = block.querySelector('.catgirl-title');
                    if (titleSpan && titleSpan.textContent === expandedCatgirlName) {
                        const btn = block.querySelector('.catgirl-expand');
                        const details = block.querySelector('.catgirl-details');
                        if (btn && details && details.style.display === 'none') {
                            // å±•å¼€è¿™ä¸ªçŒ«å¨˜
                            details.style.display = 'block';
                            btn.textContent = 'â–¼';
                            showCatgirlForm(expandedCatgirlName, details);
                        }
                    }
                });
            }, 0);
        } else {
            // å¦‚æœçŒ«å¨˜ä¸å­˜åœ¨äº†ï¼Œæ¸…é™¤è®°å½•
            expandedCatgirlName = null;
        }
    }
}

// æ¸²æŸ“ä¸»äººè¡¨å•
function renderMaster() {
    const master = characterData['ä¸»äºº'] || {};
    const form = document.getElementById('master-form');
    // æ¸…ç©ºåŸæœ‰è‡ªå®šä¹‰é¡¹
    Array.from(form.querySelectorAll('.custom-row')).forEach(e => e.remove());
    form.æ¡£æ¡ˆå.value = master['æ¡£æ¡ˆå'] || '';
    form.æ€§åˆ«.value = master['æ€§åˆ«'] || '';
    form.æ˜µç§°.value = master['æ˜µç§°'] || '';
    // æ¸²æŸ“è‡ªå®šä¹‰é¡¹
    Object.keys(master).forEach(k => {
        if (["æ¡£æ¡ˆå", "æ€§åˆ«", "æ˜µç§°"].includes(k)) return;
        const row = document.createElement('div');
        row.className = 'field-row custom-row';
        row.innerHTML = `<label>${k}</label><input type="text" name="${k}" value="${master[k]}"><button type="button" class="btn sm delete" style="margin-left:8px">åˆ é™¤è®¾å®š</button>`;
        form.insertBefore(row, form.querySelector('div[style]'));
    });
    
    // ä¸ºæ–°æ¸²æŸ“çš„å…ƒç´ é‡æ–°è®¾ç½®äº‹ä»¶ç›‘å¬
    setupMasterFormListeners();
}

// æ–°å¢ä¸»äººè‡ªå®šä¹‰è®¾å®š
// ä¸»äººè¡¨å•æŒ‰é’®æ˜¾ç¤º/éšè—é€»è¾‘
    function setupMasterFormListeners() {
        const masterFormEl = document.getElementById('master-form');
        if (!masterFormEl) return;
        
        // è·å–ä¿å­˜å’Œå–æ¶ˆæŒ‰é’®
        const saveBtn = masterFormEl.querySelector('#save-master-btn');
        const cancelBtn = masterFormEl.querySelector('#cancel-master-btn');
        
        // æ˜¾ç¤ºæ“ä½œæŒ‰é’®çš„å‡½æ•°
        function showMasterActionButtons() {
            if (saveBtn) saveBtn.style.display = '';
            if (cancelBtn) cancelBtn.style.display = '';
        }
        
        // ä¸ºæ‰€æœ‰è¾“å…¥å…ƒç´ æ·»åŠ äº‹ä»¶ç›‘å¬
        const inputs = masterFormEl.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('change', showMasterActionButtons);
            input.addEventListener('input', showMasterActionButtons);
        });
        
        // ä¸ºåˆ é™¤æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
        const deleteButtons = masterFormEl.querySelectorAll('.btn.delete');
        deleteButtons.forEach(btn => {
            btn.addEventListener('click', showMasterActionButtons);
        });
        
        // ä¸ºæ–°å¢è®¾å®šæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
        const addBtn = masterFormEl.querySelector('#add-master-field-btn');
        if (addBtn) {
            addBtn.onclick = async function() {
                const key = await showPrompt('è¯·è¾“å…¥æ–°è®¾å®šçš„åç§°ï¼ˆé”®åï¼‰', '', 'æ–°å¢ä¸»äººè®¾å®š');
                if (!key || ["æ¡£æ¡ˆå"].includes(key)) return;
                if (masterFormEl.querySelector(`[name='${key}']`)) { 
                    await showAlert('è¯¥è®¾å®šå·²å­˜åœ¨'); 
                    return;
                }
                const row = document.createElement('div');
                row.className = 'field-row custom-row';
                row.innerHTML = `<label>${key}</label><input type="text" name="${key}"><button type="button" class="btn sm delete" style="margin-left:8px">åˆ é™¤è®¾å®š</button>`;
                masterFormEl.insertBefore(row, masterFormEl.querySelector('div[style]'));
                
                // æ˜¾ç¤ºæ“ä½œæŒ‰é’®
                showMasterActionButtons();
                
                // ä¸ºæ–°æ·»åŠ çš„å…ƒç´ æ·»åŠ äº‹ä»¶ç›‘å¬
                const newInput = row.querySelector('input');
                newInput.addEventListener('change', showMasterActionButtons);
                newInput.addEventListener('input', showMasterActionButtons);
                
                // ä¸ºåˆ é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å’Œç‚¹å‡»å¤„ç†
                const newDeleteBtn = row.querySelector('button');
                newDeleteBtn.addEventListener('click', showMasterActionButtons);
                newDeleteBtn.addEventListener('click', function() {
                    deleteMasterField(this);
                });
            };
        }
        
        // åˆ é™¤ä¸»äººå­—æ®µå‡½æ•°
        window.deleteMasterField = function(btn) {
            const row = btn.parentNode;
            // æ¡£æ¡ˆåä¸èƒ½åˆ 
            if (row.querySelector('label') && row.querySelector('label').textContent === 'æ¡£æ¡ˆå') return;
            row.remove();
            showMasterActionButtons(); // åˆ é™¤å­—æ®µåæ˜¾ç¤ºæ“ä½œæŒ‰é’®
        };
        
        // å–æ¶ˆæŒ‰é’®åŠŸèƒ½
        if (cancelBtn) {
            cancelBtn.onclick = function() {
                // é‡æ–°åŠ è½½ä¸»äººæ•°æ®ä»¥å–æ¶ˆä¿®æ”¹
                renderMaster();
                // éšè—æ“ä½œæŒ‰é’®
                if (saveBtn) saveBtn.style.display = 'none';
                if (cancelBtn) cancelBtn.style.display = 'none';
            };
        }
    }
    
    if (!window._addMasterFieldHandler) {
        var masterFormEl = document.getElementById('master-form');
        if (masterFormEl) {
            // æ·»åŠ æŒ‰é’®åŒºåŸŸï¼Œåˆå§‹éšè—ä¿å­˜å’Œå–æ¶ˆæŒ‰é’®
            masterFormEl.insertAdjacentHTML('beforeend', '<div style="text-align:right;margin-top:8px"><button type="button" class="btn sm add" id="add-master-field-btn">æ–°å¢è®¾å®š</button><button type="submit" class="btn sm" id="save-master-btn" style="display:none">ä¿å­˜ä¸»äººè®¾å®š</button><button type="button" class="btn sm" id="cancel-master-btn" style="display:none">å–æ¶ˆ</button></div>');
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬
        setupMasterFormListeners();
        
        window._addMasterFieldHandler = true;
    }

// ä¿å­˜ä¸»äºº
const masterForm = document.getElementById('master-form');
masterForm.onsubmit = async function(e) {
    e.preventDefault();
    const data = {};
    for (const [k, v] of new FormData(masterForm).entries()) {
        if (k && v) data[k] = v;
    }
    if (!data['æ¡£æ¡ˆå']) {
        await showAlert('æ¡£æ¡ˆåä¸ºå¿…å¡«é¡¹');
        return;
    }
    await fetch('/api/characters/master', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    await loadCharacterData();
    
    // éšè—ä¿å­˜å’Œå–æ¶ˆæŒ‰é’®
    const saveBtn = masterForm.querySelector('#save-master-btn');
    const cancelBtn = masterForm.querySelector('#cancel-master-btn');
    if (saveBtn) saveBtn.style.display = 'none';
    if (cancelBtn) cancelBtn.style.display = 'none';
};

// æ¸²æŸ“çŒ«å¨˜åˆ—è¡¨
function renderCatgirls() {
    const list = document.getElementById('catgirl-list');
    list.innerHTML = '';
    const catgirls = characterData['çŒ«å¨˜'] || {};
    Object.keys(catgirls).forEach(key => {
        const cat = catgirls[key];
        // éšæœºé¢œè‰²
        const color = randomColor();
        const block = document.createElement('div');
        block.className = 'catgirl-block';
        block.innerHTML = `
            <div class="catgirl-header">
                <span class="catgirl-expand" style="cursor:pointer;font-size:1.2em;margin-right:6px;user-select:none">â–¶</span>
                <span class="catgirl-title" style="color:${color};">${key}</span>
                <div class="catgirl-actions">
                    <button class="btn sm" id="switch-btn-${key}" onclick="switchCatgirl('${key}')" style="background: #28a745;">åˆ‡æ¢çŒ«å¨˜</button>
                    <button class="btn sm delete" onclick="deleteCatgirl('${key}')">åˆ é™¤çŒ«å¨˜</button>
                </div>
            </div>
            <div class="catgirl-details" style="display:none;"></div>
        `;
        // å±•å¼€æŒ‰é’®é€»è¾‘
        const expandBtn = block.querySelector('.catgirl-expand');
        const detailsDiv = block.querySelector('.catgirl-details');
        
        // ä» localStorage è¯»å–å±•å¼€çŠ¶æ€
        const storageKey = `catgirl_expand_${key}`;
        const savedState = localStorage.getItem(storageKey);
        const shouldBeOpen = savedState === 'true';
        
        if (shouldBeOpen) {
            detailsDiv.style.display = 'block';
            expandBtn.textContent = 'â–¼';
            expandedCatgirlName = key;
            // å»¶è¿ŸåŠ è½½è¡¨å•ï¼Œç¡®ä¿ DOM å·²æ¸²æŸ“
            setTimeout(() => {
                showCatgirlForm(key, detailsDiv);
            }, 0);
        }
        
        expandBtn.onclick = function() {
            const isOpen = detailsDiv.style.display === '' || detailsDiv.style.display === 'block';
            if (isOpen) {
                detailsDiv.style.display = 'none';
                expandBtn.textContent = 'â–¶';
                detailsDiv.innerHTML = '';
                // ä¿å­˜çŠ¶æ€åˆ° localStorage
                localStorage.setItem(storageKey, 'false');
                // æ¸…é™¤å±•å¼€è®°å½•
                if (expandedCatgirlName === key) {
                    expandedCatgirlName = null;
                }
            } else {
                detailsDiv.style.display = 'block';
                expandBtn.textContent = 'â–¼';
                // ä¿å­˜çŠ¶æ€åˆ° localStorage
                localStorage.setItem(storageKey, 'true');
                // è®°å½•å½“å‰å±•å¼€çš„çŒ«å¨˜
                expandedCatgirlName = key;
                showCatgirlForm(key, detailsDiv);
            }
        };
        list.appendChild(block);
    });
}

// éšæœºé¢œè‰²å‡½æ•°
function randomColor() {
    // ç”Ÿæˆæ˜äº®ã€æŸ”å’Œçš„éšæœºè‰²
    const h = Math.floor(Math.random() * 360);
    const s = 60 + Math.floor(Math.random() * 25); // 60-85%
    const l = 45 + Math.floor(Math.random() * 30); // 45-75%
    return `hsl(${h},${s}%,${l}%)`;
}

// æ–°å¢çŒ«å¨˜
const addBtn = document.getElementById('add-catgirl-btn');
addBtn.onclick = function() {
    showCatgirlForm(null);
};

// ç¼–è¾‘çŒ«å¨˜
window.editCatgirl = function(key) {
    showCatgirlForm(key);
};

// åˆ é™¤çŒ«å¨˜
window.deleteCatgirl = async function(key) {
    const catgirls = characterData['çŒ«å¨˜'] || {};
    if (Object.keys(catgirls).length <= 1) {
        await showAlert('åªå‰©ä¸€åªçŒ«å¨˜ï¼Œæ— æ³•åˆ é™¤ï¼');
        return;
    }
    // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰çŒ«å¨˜
    try {
        const currentResponse = await fetch('/api/characters/current_catgirl');
        const currentData = await currentResponse.json();
        const currentCatgirl = currentData.current_catgirl || '';
        
        if (key === currentCatgirl) {
            await showAlert('ä¸èƒ½åˆ é™¤å½“å‰æ­£åœ¨ä½¿ç”¨çš„çŒ«å¨˜ï¼\n\nè¯·å…ˆåˆ‡æ¢åˆ°å…¶ä»–çŒ«å¨˜åå†åˆ é™¤ã€‚');
            return;
        }
    } catch (error) {
        console.error('è·å–å½“å‰çŒ«å¨˜å¤±è´¥:', error);
        await showAlert('æ— æ³•ç¡®è®¤å½“å‰çŒ«å¨˜çŠ¶æ€ï¼Œåˆ é™¤æ“ä½œå·²å–æ¶ˆ');
        return;
    }
    
    if (!await showConfirm('ç¡®å®šè¦åˆ é™¤çŒ«å¨˜"' + key + '"ï¼Ÿ', 'åˆ é™¤çŒ«å¨˜', {danger: true})) return;
    await fetch('/api/characters/catgirl/' + encodeURIComponent(key), {method: 'DELETE'});
    // æ¸…é™¤ localStorage ä¸­çš„å±•å¼€çŠ¶æ€è®°å½•
    localStorage.removeItem(`catgirl_expand_${key}`);
    // æ¸…é™¤è¿›é˜¶è®¾å®šæŠ˜å çŠ¶æ€è®°å½•
    localStorage.removeItem(`catgirl_advanced_${key}`);
    await loadCharacterData();
};

// æ˜¾ç¤ºä¿å­˜å’Œå–æ¶ˆæŒ‰é’®çš„å…¨å±€å‡½æ•°
function showActionButtons(form) {
    if (!form) return;
    // ä½¿ç”¨è¡¨å•å†…çš„æŸ¥è¯¢é€‰æ‹©å™¨æ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®
    const saveBtn = form.querySelector('#save-button');
    const cancelBtn = form.querySelector('#cancel-button');
    if (saveBtn) saveBtn.style.display = '';
    if (cancelBtn) cancelBtn.style.display = '';
}

// æ˜¾ç¤ºçŒ«å¨˜ç¼–è¾‘/æ–°å¢è¡¨å•
function showCatgirlForm(key, container) {
    let cat = key ? characterData['çŒ«å¨˜'][key] : {};
    let isNew = !key;
    let form = document.createElement('form');
    form.id = key ? 'catgirl-form-' + key : 'catgirl-form-new';
    
    // ä¿å­˜çŒ«å¨˜åç§°ï¼Œç”¨äºåç»­æ¢å¤è¿›é˜¶è®¾å®šçš„å±•å¼€çŠ¶æ€
    form._catgirlName = key;
    // å…ˆæ¸²æŸ“åŸºç¡€é¡¹
    form.innerHTML = `
        <div class="field-row">
            <label>æ¡£æ¡ˆå<span style="color:red">*</span></label>
            <input type="text" name="æ¡£æ¡ˆå" value="${key || ''}" ${isNew ? '' : 'readonly'} required>
            ${!isNew ? '<button type="button" class="btn sm" id="rename-catgirl-btn">ä¿®æ”¹åç§°</button>' : ''}
        </div>
    `;
    // æ¸²æŸ“è‡ªå®šä¹‰é¡¹
    Object.keys(cat).forEach(k => {
        if (!["live2d", "voice_id", "system_prompt", "æ¡£æ¡ˆå"].includes(k)) {
            const row = document.createElement('div');
            row.className = 'field-row custom-row';
            row.innerHTML = `<label>${k}</label><input type="text" name="${k}" value="${cat[k]}"><button type="button" class="btn sm delete" style="margin-left:8px" onclick="deleteCatgirlField(this)">åˆ é™¤è®¾å®š</button>`;
            form.appendChild(row);
        }
    });
    // æ¸²æŸ“è¿›é˜¶è®¾å®š
    form.innerHTML += `
        <div class="fold">
            <div class="fold-toggle">è¿›é˜¶è®¾å®š <span class="arrow">â–¼</span></div>
            <div class="fold-content">
                <div class="field-row">
                    <label>live2d</label>
                    <span class="live2d-link" style="flex:1;cursor:pointer;color:#4f8cff;text-decoration:underline;display:inline-block;padding:6px 0" title="ç‚¹å‡»ç®¡ç†Live2Dæ¨¡å‹">${cat['live2d'] ? cat['live2d'] : 'æœªè®¾ç½®'}</span>
                </div>
                <div class="field-row">
                    <label>voice_id</label>
                    <select name="voice_id" class="form-control" style="flex:1">
                        <option value="">æœªæŒ‡å®šéŸ³è‰²</option>
                    </select>
                    <button type="button" class="btn sm" onclick="openVoiceClone('${key || ''}')">æ³¨å†Œæ–°å£°éŸ³</button>
                </div>
                <div class="fold">
                    <hr style="border: none; border-top: 1px solid #e0e0e0; margin: 8px 0;">
                    <div class="fold-toggle" style="color: #888; font-style: italic">system_prompt <span class="arrow">â–¼</span></div>
                    <div class="fold-content">
                        <textarea name="system_prompt" rows="5" style="width:100%" placeholder="ç³»ç»ŸæŒ‡ä»¤ï¼ˆè°¨æ…ä¿®æ”¹ï¼‰">${cat['system_prompt'] || ''}</textarea>
                    </div>
                </div>
            </div>
        </div>
        <div style="text-align:right;margin-top:10px;">
            <button type="button" class="btn sm add" id="add-catgirl-field-btn">æ–°å¢è®¾å®š</button>
            <button type="submit" class="btn sm" id="save-button" style="display:none">${isNew ? 'ç¡®è®¤æ–°çŒ«å¨˜' : 'ä¿å­˜ä¿®æ”¹'}</button>
            <button type="button" class="btn sm" id="cancel-button" style="display:none" onclick="this.form.querySelector('#save-button').style.display = 'none'; this.form.querySelector('#cancel-button').style.display = 'none'; loadCharacterData()">å–æ¶ˆ</button>
        </div>
    `;
    // live2då¼¹çª—é€»è¾‘
    const live2dLink = form.querySelector('.live2d-link');
    if (live2dLink) {
        live2dLink.onclick = async function() {
            const catgirlName = form.querySelector('[name="æ¡£æ¡ˆå"]').value;
            if (!catgirlName) {
                await showAlert('è¯·å…ˆå¡«å†™çŒ«å¨˜æ¡£æ¡ˆåï¼Œç„¶åå†è®¾ç½®Live2Dæ¨¡å‹');
                return;
            }
            const url = `/l2d?lanlan_name=${encodeURIComponent(catgirlName)}`;
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰è¯¥URLçš„çª—å£æ‰“å¼€
            if (!window._openSettingsWindows) {
                window._openSettingsWindows = {};
            }
            
            if (window._openSettingsWindows[url]) {
                const existingWindow = window._openSettingsWindows[url];
                // æ£€æŸ¥çª—å£æ˜¯å¦ä»ç„¶æ‰“å¼€
                if (existingWindow && !existingWindow.closed) {
                    // èšç„¦åˆ°å·²å­˜åœ¨çš„çª—å£
                    existingWindow.focus();
                    return;
                } else {
                    // çª—å£å·²å…³é—­ï¼Œæ¸…é™¤å¼•ç”¨
                    delete window._openSettingsWindows[url];
                }
            }
            
            const popup = window.open(
                url,
                '_blank',
                'toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=' + screen.availWidth + ',height=' + screen.availHeight + ',top=0,left=0'
            );
            if (!popup) {
                await showAlert('è¯·å…è®¸å¼¹çª—ï¼');
                return;
            }
            
            // ä¿å­˜çª—å£å¼•ç”¨
            window._openSettingsWindows[url] = popup;
            
            popup.moveTo(0, 0);
            popup.resizeTo(screen.availWidth, screen.availHeight);
            const timer = setInterval(() => {
                if (popup.closed) {
                    clearInterval(timer);
                    // æ¸…é™¤çª—å£å¼•ç”¨
                    if (window._openSettingsWindows[url] === popup) {
                        delete window._openSettingsWindows[url];
                    }
                    loadCharacterData();
                }
            }, 500);
        };
    }
    // è¡¨å•ç‰¹å®šçš„showActionButtonså°è£…
    const formShowActionButtons = function() {
        showActionButtons(form);
    };
    
    // æ–°çŒ«å¨˜å§‹ç»ˆæ˜¾ç¤ºç¡®è®¤æŒ‰é’®
    if (isNew) {
        setTimeout(() => {
            formShowActionButtons();
        }, 0);
    }

    // ç›‘å¬è¡¨å•å…ƒç´ å˜åŒ–
    function setupChangeListeners() {
        // ä¸ºæ‰€æœ‰è¾“å…¥å…ƒç´ æ·»åŠ changeäº‹ä»¶ç›‘å¬
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('change', formShowActionButtons);
            // å¯¹äºtextareaå’Œæ–‡æœ¬è¾“å…¥ï¼Œä¹Ÿç›‘å¬inputäº‹ä»¶ä»¥è·å¾—å®æ—¶å“åº”
            if (input.type === 'text' || input.tagName === 'TEXTAREA') {
                input.addEventListener('input', formShowActionButtons);
            }
        });
        
        // ä¸ºåˆ é™¤æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
        const deleteButtons = form.querySelectorAll('.btn.delete');
        deleteButtons.forEach(btn => {
            btn.addEventListener('click', formShowActionButtons);
        });
    }
    
    // è°ƒç”¨å‡½æ•°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    setupChangeListeners();

    // æ–°å¢è‡ªå®šä¹‰é¡¹æŒ‰é’®
    form.querySelector('#add-catgirl-field-btn').onclick = async function() {
        const key = await showPrompt('è¯·è¾“å…¥æ–°è®¾å®šçš„åç§°ï¼ˆé”®åï¼‰', '', 'æ–°å¢çŒ«å¨˜è®¾å®š');
        if (!key || ["æ¡£æ¡ˆå", "live2d", "voice_id", "system_prompt"].includes(key)) return;
        if (form.querySelector(`[name='${key}']`)) { await showAlert('è¯¥è®¾å®šå·²å­˜åœ¨'); return; }
        const row = document.createElement('div');
        row.className = 'field-row custom-row';
        row.innerHTML = `<label>${key}</label><input type="text" name="${key}"><button type="button" class="btn sm delete" style="margin-left:8px" onclick="deleteCatgirlField(this)">åˆ é™¤è®¾å®š</button>`;
        form.insertBefore(row, form.querySelector('.fold'));
        
        // æ–°å¢å­—æ®µåæ˜¾ç¤ºæ“ä½œæŒ‰é’®
        formShowActionButtons();
        
        // ä¸ºæ–°æ·»åŠ çš„è¾“å…¥å…ƒç´ æ·»åŠ äº‹ä»¶ç›‘å¬
        const newInput = row.querySelector('input');
        newInput.addEventListener('change', formShowActionButtons);
        newInput.addEventListener('input', formShowActionButtons);
        
        const newDeleteBtn = row.querySelector('button');
        newDeleteBtn.addEventListener('click', formShowActionButtons);
    };
    
    // è®¾ç½®åˆ é™¤å­—æ®µçš„å…¨å±€å‡½æ•°
    window.deleteCatgirlField = function(btn) {
        const fieldRow = btn.parentNode;
        const form = fieldRow.closest('form');
        fieldRow.remove();
        showActionButtons(form); // åˆ é™¤å­—æ®µåæ˜¾ç¤ºæ“ä½œæŒ‰é’®
    };

    // åœ¨ form.onsubmit ä¹‹å‰æ·»åŠ 
    async function loadVoices() {
        try {
            const response = await fetch('/api/voices');
            const data = await response.json();
            const select = form.querySelector('select[name="voice_id"]');
            if (select) {
                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                select.innerHTML = '<option value="">æœªæŒ‡å®šéŸ³è‰²</option>';
                // æ·»åŠ éŸ³è‰²é€‰é¡¹
                Object.entries(data.voices).forEach(([voiceId, voiceData]) => {
                    const option = document.createElement('option');
                    option.value = voiceId;
                    option.textContent = voiceData.prefix || voiceId;
                    option.selected = voiceId === (cat['voice_id'] || '');
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('åŠ è½½éŸ³è‰²åˆ—è¡¨å¤±è´¥:', error);
        }
    }

    // ç«‹å³è°ƒç”¨åŠ è½½éŸ³è‰²
    loadVoices();





    form.onsubmit = async function(e) {
        e.preventDefault();
        const fd = new FormData(form);
        const data = {};
        for (const [k, v] of fd.entries()) {
            // ç‰¹æ®Šå¤„ç†voice_idå­—æ®µï¼Œå³ä½¿ä¸ºç©ºä¹Ÿè¦åŒ…å«
            if (k === 'voice_id') {
                data[k] = v;
            } else if (k && v) {
                data[k] = v;
            }
        }
        if (!data['æ¡£æ¡ˆå']) { await showAlert('æ¡£æ¡ˆåä¸ºå¿…å¡«é¡¹'); return; }
        
        // éªŒè¯Live2Dæ¨¡å‹æ–‡ä»¶å­˜åœ¨æ€§
        if (data['live2d'] && data['live2d'].trim() !== '') {
            try {
                const response = await fetch(`/api/characters/catgirl/l2d/${encodeURIComponent(data['æ¡£æ¡ˆå'])}`);
                const modelInfo = await response.json();
                
                if (!modelInfo.valid) {
                    const confirmFallback = await showConfirm(`çŒ«å¨˜"${data['æ¡£æ¡ˆå']}"çš„Live2Dæ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨æˆ–å·²æŸåã€‚\n\nå½“å‰æ¨¡å‹è·¯å¾„: ${data['live2d']}\n\næ˜¯å¦å›é€€åˆ°é»˜è®¤æ¨¡å‹(mao_pro)ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"ä½¿ç”¨é»˜è®¤æ¨¡å‹ï¼Œç‚¹å‡»"å–æ¶ˆ"ä¿æŒå½“å‰è®¾ç½®ã€‚`, 'Live2Dæ¨¡å‹å¼‚å¸¸');
                    
                    if (confirmFallback) {
                        // å›é€€åˆ°é»˜è®¤æ¨¡å‹
                        const fallbackResponse = await fetch(`/api/characters/catgirl/l2d/${encodeURIComponent(data['æ¡£æ¡ˆå'])}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ fallback_to_default: true })
                        });
                        const fallbackResult = await fallbackResponse.json();
                        
                        if (fallbackResult.success) {
                            await showAlert(`å·²å›é€€åˆ°é»˜è®¤æ¨¡å‹: ${fallbackResult.model_path}`);
                            // æ›´æ–°è¡¨å•ä¸­çš„live2då­—æ®µ
                            data['live2d'] = fallbackResult.model_path;
                        } else {
                            await showAlert('å›é€€åˆ°é»˜è®¤æ¨¡å‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ¨¡å‹è®¾ç½®');
                        }
                    } else {
                        // ç”¨æˆ·é€‰æ‹©ä¿æŒå½“å‰è®¾ç½®ï¼Œç»§ç»­ä¿å­˜
                        console.warn(`ç”¨æˆ·é€‰æ‹©ä¿æŒæ— æ•ˆçš„Live2Dæ¨¡å‹è®¾ç½®: ${data['live2d']}`);
                    }
                }
            } catch (error) {
                console.error('éªŒè¯Live2Dæ¨¡å‹å¤±è´¥:', error);
                const continueSave = await showConfirm(`æ— æ³•éªŒè¯Live2Dæ¨¡å‹æ–‡ä»¶å­˜åœ¨æ€§ã€‚\n\næ˜¯å¦ç»§ç»­ä¿å­˜ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"ç»§ç»­ä¿å­˜ï¼Œç‚¹å‡»"å–æ¶ˆ"ä¸­æ­¢ä¿å­˜ã€‚`, 'éªŒè¯å¤±è´¥');
                if (!continueSave) {
                    return;
                }
            }
        }
        
        try {
            console.log('æäº¤æ•°æ®:', data);
            const response = await fetch('/api/characters/catgirl' + (isNew ? '' : '/' + encodeURIComponent(key)), {
                method: isNew ? 'POST' : 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('APIè¯·æ±‚å¤±è´¥:', response.status, errorText);
                await showAlert('ä¿å­˜å¤±è´¥: ' + errorText);
                return;
            }
            
            const result = await response.json();
            console.log('ä¿å­˜ç»“æœ:', result);
            
            if (result.success === false) {
                await showAlert(result.error || 'ä¿å­˜å¤±è´¥');
                return;
            }
            
            // ä¿å­˜å½“å‰å±•å¼€çš„çŒ«å¨˜åç§°ï¼Œä»¥ä¾¿é‡æ–°åŠ è½½åè‡ªåŠ¨å±•å¼€
            let formCatgirlName = data['æ¡£æ¡ˆå'];
            if (formCatgirlName) {
                // éªŒè¯å¹¶æ¸…ç†çŒ«å¨˜åç§°ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦
                formCatgirlName = formCatgirlName.trim();
                if (formCatgirlName) {
                    expandedCatgirlName = formCatgirlName;
                }
            }
            
            // åœ¨é‡æ–°åŠ è½½æ•°æ®å‰ï¼Œéšè—å½“å‰è¡¨å•çš„æŒ‰é’®
            form.querySelector('#save-button').style.display = 'none';
            form.querySelector('#cancel-button').style.display = 'none';
            
            await loadCharacterData();
        } catch (error) {
            console.error('ä¿å­˜å‡ºé”™:', error);
            await showAlert('ä¿å­˜æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
        }
    };
    // ç»‘å®š"ä¿®æ”¹åç§°"æŒ‰é’®äº‹ä»¶
    if (!isNew) {
        const renameBtn = form.querySelector('#rename-catgirl-btn');
        if (renameBtn) {
            renameBtn.onclick = async function() {
                await window.renameCatgirl(key);
            };
        }
    }
    // æ¸²æŸ“åˆ°æŒ‡å®šå®¹å™¨
    if (container) {
        container.innerHTML = '';
        container.appendChild(form);
        
        // å¦‚æœæ˜¯ç¼–è¾‘ç°æœ‰çŒ«å¨˜ï¼Œå°è¯•æ¢å¤è¿›é˜¶è®¾å®šçš„å±•å¼€çŠ¶æ€
        if (key) {
            setTimeout(() => {
                const savedState = localStorage.getItem(`catgirl_advanced_${key}`);
                if (savedState === 'true') {
                    const advancedSettingsFold = form.querySelector('.fold');
                    const toggle = advancedSettingsFold.querySelector('.fold-toggle');
                    if (advancedSettingsFold && toggle) {
                        advancedSettingsFold.classList.add('open');
                        const arrow = toggle.querySelector('.arrow');
                        if (arrow) arrow.textContent = 'â–¼';
                    }
                }
            }, 0);
        }
    } else {
        // å…¼å®¹åŸæœ‰é€»è¾‘
        const list = document.getElementById('catgirl-list');
        // å…ˆç§»é™¤æ‰€æœ‰è¡¨å•
        Array.from(list.querySelectorAll('form')).forEach(f => f.style.display = 'none');
        // æ‰¾åˆ°æˆ–æ–°å»ºè¡¨å•
        if (key) {
            let oldForm = document.getElementById('catgirl-form-' + key);
            if (oldForm) oldForm.style.display = '';
        } else {
            // æ–°å¢çŒ«å¨˜æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„è¡¨å•å—
            const block = document.createElement('div');
            block.className = 'catgirl-block';
            block.appendChild(form);
            list.prepend(block);
        }
    }
}
// deleteCatgirlFieldå‡½æ•°å·²åœ¨showCatgirlFormå†…éƒ¨å®šä¹‰ä¸ºå…¨å±€å‡½æ•°

// çŒ«å¨˜æ¡£æ¡ˆåé‡å‘½å
window.renameCatgirl = async function(oldName) {
    const newName = await showPrompt('è¯·è¾“å…¥æ–°çš„çŒ«å¨˜æ¡£æ¡ˆå', oldName, 'é‡å‘½åçŒ«å¨˜');
    if (!newName || newName === oldName) return;
    if (characterData['çŒ«å¨˜'][newName]) { await showAlert('è¯¥æ¡£æ¡ˆåå·²å­˜åœ¨'); return; }
    // è°ƒç”¨APIé‡å‘½å
    const res = await fetch('/api/characters/catgirl/' + encodeURIComponent(oldName) + '/rename', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({new_name: newName})
    });
    const result = await res.json();
    if (result.success) {
        // å¦‚æœé‡å‘½åçš„æ˜¯å½“å‰å±•å¼€çš„çŒ«å¨˜ï¼Œæ›´æ–°å±•å¼€è®°å½•
        if (expandedCatgirlName === oldName) {
            expandedCatgirlName = newName;
        }
        // è¿ç§» localStorage ä¸­çš„å±•å¼€çŠ¶æ€è®°å½•
        const oldStorageKey = `catgirl_expand_${oldName}`;
        const newStorageKey = `catgirl_expand_${newName}`;
        const savedState = localStorage.getItem(oldStorageKey);
        if (savedState !== null) {
            localStorage.setItem(newStorageKey, savedState);
            localStorage.removeItem(oldStorageKey);
        }
        await loadCharacterData();
    } else {
        await showAlert(result.error || 'é‡å‘½åå¤±è´¥');
    }
}

function openApiKeySettings() {
    // æ£€æŸ¥æ˜¯å¦å·²æœ‰å¼¹çª—å­˜åœ¨
    const existingModal = document.getElementById('api-key-settings-modal');
    if (existingModal) {
        // å¦‚æœå·²å­˜åœ¨ï¼Œèšç„¦åˆ°è¯¥å¼¹çª—ï¼ˆé€šè¿‡ç‚¹å‡»èƒŒæ™¯åŒºåŸŸï¼‰
        existingModal.style.display = 'block';
        return;
    }
    
    // åˆ›å»ºå¼¹çª—å®¹å™¨
    let modal = document.createElement('div');
    modal.id = 'api-key-settings-modal';
    modal.style.position = 'fixed';
    modal.style.left = '0';
    modal.style.top = '0';
    modal.style.width = '100vw';
    modal.style.height = '100vh';
    modal.style.background = 'rgba(0,0,0,0.4)';
    modal.style.zIndex = '9999';
    modal.onclick = function(e) { 
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    };
    // åˆ›å»ºiframe
    let iframe = document.createElement('iframe');
    iframe.src = '/api_key';
    iframe.style.width = '800px';
    iframe.style.height = '720px';  
    iframe.style.border = 'none';
    iframe.style.background = '#fff';
    iframe.style.display = 'block';
    iframe.style.margin = '50px auto';
    iframe.style.borderRadius = '8px';
    // ç›‘å¬å…³é—­æ¶ˆæ¯
    window.addEventListener('message', function handler(e) {
        if (e.data && e.data.type === 'close_api_key_settings') {
            const modalToRemove = document.getElementById('api-key-settings-modal');
            if (modalToRemove) {
                document.body.removeChild(modalToRemove);
            }
            window.removeEventListener('message', handler);
        }
    });
    modal.appendChild(iframe);
    document.body.appendChild(modal);
}

function openVoiceClone(lanlanName) {
    // æ£€æŸ¥æ˜¯å¦å·²æœ‰å¼¹çª—å­˜åœ¨ï¼ˆæ ¹æ®lanlanNameåŒºåˆ†ï¼‰
    const modalId = 'voice-clone-modal-' + encodeURIComponent(lanlanName);
    const existingModal = document.getElementById(modalId);
    if (existingModal) {
        // å¦‚æœå·²å­˜åœ¨ï¼Œèšç„¦åˆ°è¯¥å¼¹çª—
        existingModal.style.display = 'block';
        return;
    }
    
    // åˆ›å»ºå¼¹çª—å®¹å™¨
    let modal = document.createElement('div');
    modal.id = modalId;
    modal.style.position = 'fixed';
    modal.style.left = '0';
    modal.style.top = '0';
    modal.style.width = '100vw';
    modal.style.height = '100vh';
    modal.style.background = 'rgba(0,0,0,0.4)';
    modal.style.zIndex = '9999';
    modal.onclick = function(e) { 
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    };
    // åˆ›å»ºiframe
    let iframe = document.createElement('iframe');
    iframe.src = '/voice_clone?lanlan_name=' + encodeURIComponent(lanlanName);
    iframe.style.width = '600px';
    iframe.style.height = '400px';
    iframe.style.border = 'none';
    iframe.style.background = '#fff';
    iframe.style.display = 'block';
    iframe.style.margin = '60px auto';
    iframe.style.borderRadius = '8px';
    // ç›‘å¬voice_idå˜æ›´ï¼Œæ³¨å†Œé¡µé¢å¯åœ¨window.parent.postMessageé€šçŸ¥
    window.addEventListener('message', function handler(e) {
        if (e.data && e.data.type === 'voice_id_updated') {
            const modalToRemove = document.getElementById(modalId);
            if (modalToRemove) {
                document.body.removeChild(modalToRemove);
            }
            window.removeEventListener('message', handler);
            loadCharacterData();
        }
    });
    modal.appendChild(iframe);
    document.body.appendChild(modal);
}

// è§£é™¤å£°éŸ³æ³¨å†Œ
window.unregisterVoice = async function(catgirlName) {
    if (!await showConfirm(`ç¡®å®šè¦è§£é™¤çŒ«å¨˜"${catgirlName}"çš„å£°éŸ³æ³¨å†Œå—ï¼Ÿ`, 'è§£é™¤å£°éŸ³æ³¨å†Œ', {danger: true})) {
        return;
    }
    
    try {
        const response = await fetch('/api/characters/catgirl/' + encodeURIComponent(catgirlName) + '/unregister_voice', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await response.json();
        
        if (result.success) {
            await showAlert('å£°éŸ³æ³¨å†Œå·²è§£é™¤');
            await loadCharacterData(); // åˆ·æ–°æ•°æ®
        } else {
            await showAlert(result.error || 'è§£é™¤æ³¨å†Œå¤±è´¥');
        }
    } catch (error) {
        console.error('è§£é™¤æ³¨å†Œå‡ºé”™:', error);
        await showAlert('è§£é™¤æ³¨å†Œæ—¶å‘ç”Ÿé”™è¯¯');
    }
}

// BeaconåŠŸèƒ½ - é¡µé¢å…³é—­æ—¶å‘é€ä¿¡å·ç»™æœåŠ¡å™¨
let beaconSent = false;

function sendBeacon() {
    if (beaconSent) return; // é˜²æ­¢é‡å¤å‘é€
    beaconSent = true;
    
    try {
        // ä½¿ç”¨navigator.sendBeaconç¡®ä¿ä¿¡å·ä¸è¢«æ‹¦æˆª
        const success = navigator.sendBeacon('/api/beacon/shutdown', JSON.stringify({
            timestamp: Date.now(),
            action: 'shutdown'
        }));
        
        if (success) {
            console.log('Beaconä¿¡å·å·²å‘é€');
        } else {
            console.warn('Beaconå‘é€å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨fetch');
            // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨fetch
            fetch('/api/beacon/shutdown', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    timestamp: Date.now(),
                    action: 'shutdown'
                }),
                keepalive: true // ç¡®ä¿è¯·æ±‚åœ¨é¡µé¢å…³é—­æ—¶ä»èƒ½å‘é€
            }).catch(err => console.log('å¤‡ç”¨beaconå‘é€å¤±è´¥:', err));
        }
    } catch (e) {
        console.log('Beaconå‘é€å¼‚å¸¸:', e);
    }
}

// ç›‘å¬API Keyå˜æ›´äº‹ä»¶
window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'api_key_changed') {
        // API Keyå·²æ›´æ”¹ï¼Œåˆ·æ–°è§’è‰²æ•°æ®ä»¥æ˜¾ç¤ºæ›´æ–°åçš„Voice IDçŠ¶æ€
        console.log('API Keyå·²æ›´æ”¹ï¼Œæ­£åœ¨åˆ·æ–°è§’è‰²æ•°æ®...');
        loadCharacterData();
    }
});

// ç›‘å¬é¡µé¢å…³é—­äº‹ä»¶
window.addEventListener('beforeunload', sendBeacon);
window.addEventListener('unload', sendBeacon);



// æ›´æ–°åˆ‡æ¢æŒ‰é’®çŠ¶æ€
function updateSwitchButtons() {
    fetch('/api/characters/current_catgirl')
        .then(response => response.json())
        .then(data => {
            const currentCatgirl = data.current_catgirl || '';
            const catgirls = characterData['çŒ«å¨˜'] || {};
            
            Object.keys(catgirls).forEach(name => {
                const switchBtn = document.getElementById(`switch-btn-${name}`);
                if (switchBtn) {
                    if (name === currentCatgirl) {
                        switchBtn.textContent = 'å½“å‰çŒ«å¨˜';
                        switchBtn.style.background = '#4f8cff';
                        switchBtn.disabled = true;
                    } else {
                        switchBtn.textContent = 'åˆ‡æ¢çŒ«å¨˜';
                        switchBtn.style.background = '#28a745';
                        switchBtn.disabled = false;
                    }
                }
            });
        })
        .catch(error => {
            console.error('è·å–å½“å‰çŒ«å¨˜å¤±è´¥:', error);
        });
}

// åˆ‡æ¢çŒ«å¨˜
async function switchCatgirl(catgirlName) {
    try {
        const response = await fetch('/api/characters/current_catgirl', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({catgirl_name: catgirlName})
        });
        
        const result = await response.json();
        if (result.success) {
            await loadCharacterData(); // é‡æ–°åŠ è½½æ•°æ®ä»¥æ›´æ–°æŒ‰é’®çŠ¶æ€
        } else {
            await showAlert(result.error || 'åˆ‡æ¢å¤±è´¥');
        }
    } catch (error) {
        console.error('åˆ‡æ¢çŒ«å¨˜å¤±è´¥:', error);
        await showAlert('åˆ‡æ¢çŒ«å¨˜æ—¶å‘ç”Ÿé”™è¯¯');
    }
}



// é¡µé¢åŠ è½½æ—¶æ‹‰å–æ•°æ®
loadCharacterData();

// ä¸»äººä¿å­˜æŒ‰é’®ä¹Ÿç”¨.btn.sm
const masterSaveBtn = document.querySelector('#master-form button[type="submit"]');
if (masterSaveBtn) masterSaveBtn.classList.add('sm');
</script>
</body>
</html>